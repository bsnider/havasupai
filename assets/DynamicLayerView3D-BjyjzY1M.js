import{oI as v,oJ as b,oK as q,dO as W,a_ as k,bf as Z,b8 as J,aZ as D,ba as O,ak as Y,am as B,at as K,cm as T,jo as Q,ao as C,bW as E,Z as N,lk as X,os as ee,el as H,c2 as te,cJ as _,dw as ie,c5 as ae,oL as $,ou as P,oM as se,eR as z,oN as re,oO as R,aY as ne,oP as oe,dm as le,r as g,m as w,d as U,eb as he,en as de,em as ue,u as ce}from"./index-CA3J3HgS.js";import{p as ge}from"./SubView3D-BHkV5WrS.js";import{_ as me}from"./ImageMaterial.glsl-VNwlWVa8.js";import{l as pe}from"./LayerView3D-JeQQWbeY.js";import{u as we}from"./LayerView-LfRtBo31.js";import{i as fe}from"./RefreshableLayerView-G0vLJ6co.js";function ye(t,e,i){const s=v(t)/b(t),a={width:i,height:i};return s>1.0001?a.height=i/s:s<.9999&&(a.width=i*s),a.width=Math.round(a.width/(v(t)/v(e))),a.height=Math.round(a.height/(b(t)/b(e))),a}function j(t,e){return q(t,[[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}function xe(t,e,i){if(!W(e,i))return j(t,i);const s=[e[1]-i[1],Math.min(e[3],i[3])-Math.max(e[1],i[1]),i[3]-e[3],123456],a=[e[0]-i[0],Math.min(e[2],i[2])-Math.max(e[0],i[0]),i[2]-e[2],123456],o=i[2]-i[0],n=i[3]-i[1],r=a[0]>0&&a[2]>0?3:2,h=s[0]>0&&s[2]>0?3:2,l=(h+1)*(r+1),d=k(3*l),u=Z(2*l),c=new Array(6*(h*r-1));let M=0,A=0,L=0,p=0,f=0;for(let y=0;y<4;y++){const V=s[y];if(V<=0)continue;let I=0;for(let x=0;x<4;x++){const G=a[x];G<=0||(d[A++]=i[0]+I,d[A++]=i[1]+M,d[A++]=-1,u[L++]=I/o,u[L++]=M/n,x<3&&y<3&&(x!==1||y!==1)&&(c[f++]=p,c[f++]=p+1,c[f++]=p+r+1,c[f++]=p+1,c[f++]=p+r+2,c[f++]=p+r+1),p++,I+=G)}M+=V}const F=new Array(c.length);return new J(t,[[D.POSITION,new O(d,c,3,!0)],[D.NORMAL,new O(_e,F,3,!0)],[D.UV0,new O(u,c,2,!0)]])}const _e=[0,0,1];let S=class extends ge{constructor(t){super(t),this.drapeSourceType=Y.RasterImage,this.updatePolicy=B.SYNC,this.type="draped",this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this._drapeSourceRenderer=null}initialize(){this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this),this.addHandles(K((()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))))}setDrapingExtent(t,e){this._spatialReference=e,t.forEach(((i,s)=>{this._overlays[s]=i,this._updateImageExtent(i,s)}))}destroy(){this.clear()}get spatialReference(){return this._spatialReference}_updateImageExtent(t,e){const i=this._clippedExtent(t.extent,Re);if(i==null)return;const s=ye(t.extent,i,t.resolution);let a=t.pixelRatio*this.view.state.pixelRatio;const{layer:o}=this;if("imageMaxWidth"in o&&o.imageMaxWidth!=null||"imageMaxHeight"in o&&o.imageMaxHeight!=null){const r=o.imageMaxWidth,h=o.imageMaxHeight;if(s.width>r){const l=r/s.width;s.height=Math.floor(s.height*l),s.width=r,a*=l}if(s.height>h){const l=h/s.height;s.width=Math.floor(s.width*l),s.height=h,a*=l}}const n=this._extents[e];n&&Q(n.extent,i)&&this._imageSizeEquals(i,n.imageSize,s)||(this._extents[e]={extent:T(i),imageSize:s,pixelRatio:a},this.suspended||this._fetch(e).catch((r=>{C(r)||E.getLogger(this).error(r)})))}clear(){for(let t=0;t<this._images.length;t++)this._clearImage(t)}async doRefresh(t){const e=[];for(let i=0;i<this._extents.length;i++)this._extents[i]&&e.push(this._fetch(i,t));await Promise.allSettled(e)}async processResult(t,e,i){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(t.image=e)}findExtentInfoAt(t){for(const e of this._extents){const i=e.extent;if(new N(i[0],i[1],i[2],i[3],this._spatialReference).contains(t))return e}return null}async redraw(t,e){await X(this._images,(async(i,s)=>{i&&(await t(i,e),await this._createStageObjects(s,i.image,e))}))}_imageSizeEquals(t,e,i){if(!this.maximumDataResolution)return!1;const s=v(t)/this.maximumDataResolution.x,a=b(t)/this.maximumDataResolution.y,o=s/e.width,n=a/e.height,r=s/i.width,h=a/i.height,l=Math.abs(o-r),d=Math.abs(n-h),u=ee.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return l<=u&&d<=u}async _fetch(t,e){if(this.suspended)return;const i=this._extents[t],s=i.extent;this._images[t]||(this._images[t]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:T(s)});const a=this._images[t];a.loadingAbortController=H(a.loadingAbortController);const o=new N(s[0],s[1],s[2],s[3],this._spatialReference);if(o.width===0||o.height===0)return void this._clearImage(t);const n=new AbortController;a.loadingAbortController=n,te(e,(()=>n.abort()));const r=n.signal,h=this._waitFetchReady(r).then((async()=>{_(r);const l={requestAsImageElement:!0,pixelRatio:this._overlays[t].pixelRatio,...this.layerView.getFetchOptions(),signal:r},{height:d,width:u}=i.imageSize;return this.layer?this.layer.type==="imagery"?this.layer.internalFetchImage(o,u,d,l):this.layer.fetchImage(o,u,d,l):null})).then((l=>{if(ie(r))throw E.getLogger(this).warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),ae();return this.processResult(a,l)})).then((()=>{$(a.renderExtent,s)}));a.loadingPromise=h,await this.updatingHandles.addPromise(h.then((async()=>{_(r),await this._createStageObjects(t,a.image,r)})).catch((l=>{throw l&&!C(l)&&E.getLogger(this).error(l),l})).finally((()=>{h===a.loadingPromise&&(a.loadingPromise=null,a.loadingAbortController=null)})))}_clearImage(t){const e=this._images[t];if(e){e.renderGeometry!=null&&(this._drapeSourceRenderer.removeGeometries([e.renderGeometry],P.UPDATE),e.renderGeometry=null);const i=this.view.stage,s=e.texture;s==null||s.unload(),i.removeTexture(s),e.texture=null,e.material=null,e.loadingAbortController=H(e.loadingAbortController),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(t,e,i){const s=this.view.stage,a=this._images[t],o=()=>{var n;(n=a.texture)==null||n.unload(),s.removeTexture(a.texture),a.texture=null,a.renderGeometry&&(this._drapeSourceRenderer.removeGeometries([a.renderGeometry],P.UPDATE),a.renderGeometry=null)};if(e){const n=new se(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:z.CLAMP_TO_EDGE,t:z.CLAMP_TO_EDGE}});if(await re(this._images[t===R.INNER?R.OUTER:R.INNER].loadingPromise),_(i),o(),await s.schedule((()=>n.load(s.renderView.renderingContext)),i),!n.loaded)return void o();let r;if(s.addTexture(n),a.texture=n,a.material??(a.material=new me({draped:!0,texture:n})),a.material.setParameters({texture:n}),t===R.INNER)r=j(a.material,a.renderExtent);else{const h=this._images[0].renderExtent;if(!h)return void o();r=xe(a.material,h,a.renderExtent)}a.renderGeometry=new ne(r),a.renderGeometry.localOrigin=this._overlays[t].renderLocalOrigin,this._drapeSourceRenderer.addGeometries([a.renderGeometry],P.UPDATE)}else o(),a.material=null}_clippedExtent(t,e){if(this.view.viewingMode!=="local")return $(e,t);const i=this.view.basemapTerrain;return i.ready?oe(t,i.extent,e):$(e,t)}async _waitFetchReady(t){await le((()=>this.view.stationary),t),_(t)}};g([w()],S.prototype,"type",void 0),S=g([U("esri.views.3d.layers.DrapedSubView3D")],S);const Re=T();let m=class extends fe(pe(we)){constructor(){super(...arguments),this.fullExtentInLocalViewSpatialReference=null,this.refreshDebounced=he((async t=>{this.destroyed||await this._doRefresh(t).catch((e=>{C(e)||E.getLogger(this).error(e)}))}),2e3)}get visibleAtCurrentScale(){const t=this.layer,e="effectiveScaleRange"in t?t.effectiveScaleRange:null;return de(e,this.view.scale)}isUpdating(){var t;return super.isUpdating()||((t=this.subView)==null?void 0:t.updating)}initialize(){this._initSubView(),this.view.viewingMode==="local"&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await ue(this.layer.fullExtent,this.view.spatialReference))()),this._updatingHandles.add((()=>this.suspended),(()=>this._suspendedChangeHandler()))}destroy(){this.subView=ce(this.subView)}_initSubView(){this.subView=new S({layerView:this})}async doRefresh(){return this._doRefresh()}async _doRefresh(t){this.suspended||await this.subView.doRefresh(t)}getFetchOptions(){}_suspendedChangeHandler(){this.suspended?this.subView.clear():this.refreshDebounced()}get test(){}};g([w()],m.prototype,"layer",void 0),g([w()],m.prototype,"suspended",void 0),g([w()],m.prototype,"fullExtentInLocalViewSpatialReference",void 0),g([w({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),g([w()],m.prototype,"updating",void 0),g([w()],m.prototype,"subView",void 0),m=g([U("esri.views.3d.layers.DynamicLayerView3D")],m);export{S as C,m as h};
