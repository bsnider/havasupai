import{dM as g,cr as u,r as l,d as m,X as w,ae as o,ai as c,c as y,ca as x,m as p}from"./index-Ds3x37R4.js";import{C as _,h as f}from"./DynamicLayerView3D-NG10mdFz.js";import{b as D}from"./FlowSubView3D-BBInR0SP.js";import{w as H}from"./ImageHighlightHelper3D-CPyFic-S.js";import{m as b}from"./ImageryLayerView-BwurYRFn.js";import"./SubView3D-Ml6i0v2s.js";import"./ImageMaterial.glsl-DM9c-YtI.js";import"./DefaultLayouts-DCKmjEQU.js";import"./TriangleMaterial-K3vSxC87.js";import"./LayerView3D-CXCqTGin.js";import"./LayerView-B2e2cy0J.js";import"./RefreshableLayerView-Bz7uUOz8.js";import"./dataUtils-Cxih6PDB.js";import"./utils-DSFVOAAV.js";import"./line-CdAdATfH.js";import"./highlightUtils-OenP77c5.js";import"./timeSupport-DDgy1azU.js";import"./rasterProjectionHelper-DEDinKKk.js";import"./popupUtils-B7wJAZVr.js";let h=class extends _{constructor(e){super(e),this.redrawDebounced=g((async t=>{this.redraw(((i,a)=>this._redrawImage(i,a)),t)}),2e3)}initialize(){this.addHandles([u((()=>this.view.basemapTerrain.ready),(()=>this._initializeMaximumDataResolution()),{once:!0,initial:!0}),this.layer.on("redraw",(()=>this.updatingHandles.addPromise(this.redrawDebounced())))])}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}async processResult(e,t,i){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,i))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||e.pixelData==null)throw new Error;const i=e.image,a=i.getContext("2d"),n=await this.layer.applyRenderer(e.pixelData,{signal:t}),r=this.layer.applyFilter(n).pixelBlock;if(r==null)throw new Error;i.width=r.width,i.height=r.height;const d=a.createImageData(r.width,r.height);d.data.set(r.getAsRGBA()),a.putImageData(d,0,0)}};h=l([m("esri.views.3d.layers.ImagerySubView3D")],h);let s=class extends b(f){constructor(){super(...arguments),this.type="imagery-3d"}get highlightOptions(){return null}get pixelData(){return null}initialize(){const e=()=>this._updatingHandles.addPromise(this.refreshDebounced());this._updatingHandles.add((()=>{var t,i;return(i=(t=this.layer)==null?void 0:t.exportImageServiceParameters)==null?void 0:i.version}),e),this._updatingHandles.add((()=>{var t;return(t=this.layer)==null?void 0:t.renderer}),e),this._updatingHandles.add((()=>this.timeExtent),e),this._highlightHelper=new H({view:this.view,layer:this.layer,updatingHandles:this._updatingHandles}),this.addHandles([w(this._highlightHelper),o((()=>this.suspended),(t=>this._highlightHelper.suspended=t),c)])}_initSubView(){this.addHandles([o((()=>this.layer.renderer),(e=>this._recreateSubView(e)),y)])}_recreateSubView(e){var n;const t=(e==null?void 0:e.type)==="flow",i=((n=this.subView)==null?void 0:n.type)==="flow",a=this.subView;a&&t===i||(this.subView=t&&x("enable-feature:3d-flow")?new D({layerView:this}):new h({layerView:this}),a==null||a.destroy())}getFetchOptions(){return{timeExtent:this.timeExtent}}highlight(e,t){return this._highlightHelper.highlight(e,t)}isUpdating(){return super.isUpdating()||this._highlightHelper.updating}};l([p()],s.prototype,"highlightOptions",null),l([p()],s.prototype,"pixelData",null),s=l([m("esri.views.3d.layers.ImageryLayerView3D")],s);const G=s;export{G as default};
