const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/containsOperator-CeBHnPLa.js","assets/ProjectionTransformation-DE_mUYa_.js","assets/Envelope2D-zGBO_y2e.js","assets/Point2D-BUVSeX7E.js","assets/Transformation2D-DNNU7gV_.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/index-CxDa6KP7.js","assets/index-BXhtsskn.css","assets/OperatorDefinitions-DP7_WWTp.js","assets/jsonConverter-DUGTIL16.js","assets/apiConverter-3p3bEB5P.js","assets/intersectsOperator-CmWJmh9e.js","assets/OperatorIntersects-p2LKDM_i.js","assets/intersectionOperator-BlO1HCqH.js","assets/operatorIntersection-D1wmI3To.js","assets/simplifyOperator-Dblt5VQr.js","assets/operatorSimplify-BAcIpU-t.js"])))=>i.map(i=>d[i]);
import{_ as P,dw as I,g3 as C,Z as M,bm as G,cH as S,dv as j,lm as O,bW as R,r as x,m as L,d as z}from"./index-CxDa6KP7.js";import{s as F,a as U}from"./LercDecoder-BGNR-65o.js";import{l as Z}from"./LayerView3D-CEB1r7IX.js";import{p as k}from"./TiledLayerView3D-DEvA0c6Q.js";import{u as H}from"./LayerView-BMCVh46y.js";class W{constructor(){this.modifications=[]}async apply(o,t,e){if(this.modifications.length!==0&&(V??(V=Promise.all([P(()=>import("./containsOperator-CeBHnPLa.js").then(i=>i.c),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),P(()=>import("./intersectsOperator-CmWJmh9e.js").then(i=>i.i),__vite__mapDeps([11,1,2,3,4,5,6,7,8,9,12,10])),P(()=>import("./intersectionOperator-BlO1HCqH.js").then(i=>i.i),__vite__mapDeps([13,6,7,3,1,2,4,5,8,9,14,10]))])),b=await V,!I(e)))for(const i of this.modifications)i.apply(o,t)}}class B{constructor(o,t){this.type=o,this.polygon=t}apply(o,t){if(this.type!=="replace")return;const{polygon:e}=this,[i,a,l]=b,{extent:h,spatialReference:y}=t,w=C(h,y);if(a.accelerateGeometry(e),!a.execute(e,w))return;i.accelerateGeometry(e),l.accelerateGeometry(e);const{width:n,height:d,values:m}=o,g=e.hasZ?e.rings.reduce(((r,p)=>p.reduce(((c,u)=>Math.min(c,u[2]??1/0)),r)),1/0):1/0,f=g===1/0?0:g;if(i.execute(e,w))m.fill(f);else{const r=J(t,e,[n,d]);if(!r||r.rings.every((c=>c.length===0)))return;const p=K(t,r,n,d);for(let c=d-1;c>=0;--c)for(let u=0;u<n;++u){const $=(c+1)*(n+2)+(u+1);let _=0;for(let T=-1;T<=1;++T){const q=$+T*(n+2);for(let E=-1;E<=1;++E)_=Math.max(_,p[q+E])}const D=c*n+u;m[D]=_===0?m[D]:f}}}}let V,b;function J(s,o,t){const[e,i,a,l]=s.extent,{spatialReference:h}=s,[y,w]=t,n=2,d=(a-e)/(y-1),m=(l-i)/(w-1),g=new M({xmin:e-n*d,ymin:i-n*m,xmax:a+n*d,ymax:l+n*m,spatialReference:h}),f=b[2].execute(o,g);return(f==null?void 0:f.type)==="polygon"?f:null}function K(s,o,t,e){const i=new OffscreenCanvas(t+2,e+2).getContext("2d",{willReadFrequently:!0});if(!i)throw new Error("failed to create canvas");const[a,l,h,y]=s.extent,w=h-a,n=y-l;i.fillStyle="black",i.clearRect(0,0,t,e);const d=new Path2D;for(const r of o.rings)if(r.length>0){const p=new Path2D;let c=!0;for(const[u,$]of r){const _=(u-a)/w*(t-1)+1+A,D=(y-$)/n*(e-1)+1+A;c?(c=!1,p.moveTo(_,D)):p.lineTo(_,D)}p.closePath(),d.addPath(p)}i.fillStyle="white",i.fill(d,"evenodd");const m=i.getImageData(0,0,t+2,e+2),g=(t+2)*(e+2),f=new Uint8Array(g);for(let r=0;r<g;++r)f[r]=m.data[4*r+0]>0?1:0;return f}const A=.5;let v=class extends k(Z(H)){constructor(){super(...arguments),this.type="elevation-3d",this.modifications=new W}get tileInfo(){return this.layer.tileInfo}initialize(){var a,l,h;const s=this.view,o=(a=s.map)==null?void 0:a.allLayers,t=o&&o.includes(this.layer),e=(h=(l=s.map)==null?void 0:l.ground)==null?void 0:h.layers,i=e&&e.includes(this.layer);if(t&&!i){const y=new G("layerview:elevation-layer-only",`3D elevation layer '${this.layer.id}' can only be added to layers in map.ground`);this.addResolvingPromise(Promise.reject(y))}this._lercDecoder=F(s.resourceController),this._addTilingSchemeMatchPromise()}destroy(){this._lercDecoder=S(this._lercDecoder)}async fetchElevationTile(s,o){const t=await this._fetchTileData(s.lij,o);if(!I(o))return t&&await this.modifications.apply(t,s,o.signal),t}async _fetchTileData(s,o){const t=this.layer;if(j(t)){const l=await t.fetchTile(s[0],s[1],s[2],{noDataValue:O,signal:o.signal});return I(o)?void R.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."):l}const e=this.getTileUrl(s),i=await o.requester.request(e,"binary",o),a=await this._lercDecoder.decode(i,{noDataValue:O},o.signal);if(a)return new U(a);throw new Error("LERC decoding failed")}async setModifications(s){if(this.modifications.modifications.length=0,!s||s.length===0)return;this._simplifyOperatorPromise??(this._simplifyOperatorPromise=P(()=>import("./simplifyOperator-Dblt5VQr.js").then(t=>t.s),__vite__mapDeps([15,3,1,2,4,5,6,7,8,9,16,10])));const o=await this._simplifyOperatorPromise;for(const t of s){const e=t.geometry;if((e==null?void 0:e.type)==="polygon"){const i=o.execute(e);if((i==null?void 0:i.type)==="polygon"){const a=new B(t.type,i);this.modifications.modifications.push(a)}else R.getLogger(this).warn("Failed to simplify modification polygon")}else R.getLogger(this).warn("Invalid modification added to elevation layer: "+(e?`non polygon geometry ${e.type}`:"no geometry"))}}};x([L()],v.prototype,"layer",void 0),x([L()],v.prototype,"tileInfo",null),x([L()],v.prototype,"modifications",void 0),v=x([z("esri.views.3d.layers.ElevationLayerView3D")],v);const te=v;export{te as default};
