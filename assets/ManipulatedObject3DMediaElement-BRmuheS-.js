import{e as _,h as E,dk as v,c as P,dD as f,P as $,aL as x,dE as G,dF as R,r as n,m as r,d as g,tG as j,aN as b,ap as O,aq as V,n7 as D,mW as S,aU as A,dz as z,av as L}from"./index-CA3J3HgS.js";import{o as N}from"./MediaLayerView3D-CEsKdssS.js";import{p as T,E as U}from"./EditGeometryOperations-BY_V0Ut9.js";import{U as k,V as F}from"./VideoElement-BRrwM7ff.js";import"./perspectiveUtils-Jt6MoO4i.js";import"./normalizeUtilsSync-DFxj3Ye1.js";import"./LayerView3D-JeQQWbeY.js";import"./SnappingManagerPool-B8wCjH2V.js";import"./ImageMaterial.glsl-VNwlWVa8.js";import"./DefaultLayouts-fHZsOgCQ.js";import"./TriangleMaterial-BmOrBe-u.js";import"./LayerView-LfRtBo31.js";import"./MediaLayerView-CFYfzDgY.js";import"./mediaLayerUtils-BJ-DU5EY.js";let u=class extends _{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new E}initialize(){this.addHandles([v(this._updatingHandles),this._updatingHandles.add((()=>{const e=this.element.georeference;return(e==null?void 0:e.type)==="control-points"?e.controlPoints:null}),(e=>this._elementControlPointsChanged(e)),P)])}_elementControlPointsChanged(e){const t=e==null?void 0:e.map((({mapPoint:i})=>i)).filter(f),o=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(t,o,(i=>{if(!i)return void this._replaceOperations(null);const{_operations:s}=this,a=i.map((({x:p,y:d})=>[p,d]));a.push(a[0].slice());const m=new $({rings:[a],spatialReference:o});if(s!=null&&s.trySetGeometry(m))return void this.onModifiedExternally();const y=this.view.state.viewingMode;this._replaceOperations(new N(T.fromGeometry(m,y),y,(p=>this._operationsGeometryChanged(p))))})))}_operationsGeometryChanged(e){var p;const{element:{georeference:t},_operations:o}=this;if(!o||!t||t.type!=="control-points"||!t.controlPoints)return;const i=o.data.geometry,s=t.controlPoints.map((({mapPoint:d})=>d)).filter(f),a=o.data.components[0].isClosed()?1:0;if(((p=i.rings[0])==null?void 0:p.length)-a!==s.length)return;const m=i.rings[0].map((([d,M])=>new x({x:d,y:M,spatialReference:i.spatialReference})));m.length-=a;const y=s.map((({spatialReference:d})=>d));this._updatingHandles.addPromise(this._whenProjected(m,y,(d=>this._updateElementControlPoints(d,e))))}_updateElementControlPoints(e,t){var s;const{georeference:o}=this.element;if(!o||!e||o.type!=="control-points"||((s=o.controlPoints)==null?void 0:s.length)!==(e==null?void 0:e.length))return;const i=o.controlPoints;if((i==null?void 0:i.length)===e.length)for(let a=0;a<i.length;a++)t&&(i[a].sourcePoint=o.toSource(e[a])),i[a].mapPoint=e[a]}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:i,element:{georeference:s}}=this,a=e.map((({spatialReference:p})=>p)),m=Array.isArray(t)?t:new Array(a.length).fill(t);await G(Array.from(a).map(((p,d)=>({source:p,dest:m[d]}))));const y=e.map(((p,d)=>R(p,m[d])));i===this._operations&&s===this.element.georeference&&o(y)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e}};n([r({constructOnly:!0})],u.prototype,"view",void 0),n([r({constructOnly:!0})],u.prototype,"layer",void 0),n([r({constructOnly:!0})],u.prototype,"element",void 0),n([r({constructOnly:!0})],u.prototype,"onModifiedExternally",void 0),n([r()],u.prototype,"_operations",void 0),n([r()],u.prototype,"operations",null),n([r()],u.prototype,"updating",null),u=n([g("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],u);let h=class extends _{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new E}initialize(){this.addHandles([v(this._updatingHandles),this._updatingHandles.add((()=>{var e;return(e=this.element.georeference)==null?void 0:e.coords}),(e=>this._elementCoordinatesChanged(e)),P)])}_elementCoordinatesChanged(e){this._updatedElementCoordinates!==e&&this._updatingHandles.addPromise(this._whenProjected(e,this.view.spatialReference,(t=>{if(!t)return void this._replaceOperations(null);const{_operations:o}=this;o!=null&&o.trySetGeometry(t)?this.onModifiedExternally():this._replaceOperations(U.fromGeometry(t,this.view.state.viewingMode))})))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:t}=this;if(!t||!e)return;const o=t.data.geometry;if(!e.coords)return void this._updateElementCoordinates(o);const i=e.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(o,i,(s=>this._updateElementCoordinates(s))))}_updateElementCoordinates(e){const{georeference:t}=this.element;t&&(t.coords=e,this._updatedElementCoordinates=t.coords)}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:i,element:{georeference:s}}=this,a=await j(e,t);i===this._operations&&s===this.element.georeference&&o(a)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e),this.onModifiedExternally()}};n([r({constructOnly:!0})],h.prototype,"view",void 0),n([r({constructOnly:!0})],h.prototype,"layer",void 0),n([r({constructOnly:!0})],h.prototype,"element",void 0),n([r({constructOnly:!0})],h.prototype,"onModifiedExternally",void 0),n([r()],h.prototype,"_operations",void 0),n([r()],h.prototype,"operations",null),n([r()],h.prototype,"updating",null),h=n([g("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],h);function I(e,t,o){return H(e.allLayerViews.find((i=>i.layer===t)),o)}function H(e,t){if(!e||e.type!=="media-3d"||e.suspended)return!1;const o=e.layer.source;return!!o&&(o instanceof k||o instanceof F?o===t:"hasElement"in o&&o.hasElement(t))}let l=class extends _{grabbableForEvent(){return!0}constructor(e){super(e),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new b.EventEmitter,this.addHandles(O((()=>this.selected),(t=>this.events.emit("select-changed",{action:t?"select":"deselect"})),V))}destroy(){this._set("view",null)}intersectionDistance(e){const{view:t,layer:o,element:i}=this;if(!I(t,o,i))return null;const s=t.toMap(e,{include:{layer:o,element:i}});return s&&S(s,w,t.renderSpatialReference)?D(w,t.state.camera.eye):null}onElevationChange(){}onViewChange(){}};n([r({constructOnly:!0,nonNullable:!0})],l.prototype,"element",void 0),n([r({constructOnly:!0,nonNullable:!0})],l.prototype,"layer",void 0),n([r({constructOnly:!0,nonNullable:!0})],l.prototype,"view",void 0),n([r()],l.prototype,"interactive",void 0),n([r()],l.prototype,"selectable",void 0),n([r()],l.prototype,"grabbable",void 0),n([r()],l.prototype,"grabbing",void 0),n([r()],l.prototype,"dragging",void 0),n([r()],l.prototype,"hovering",void 0),n([r()],l.prototype,"selected",void 0),n([r()],l.prototype,"cursor",void 0),l=n([g("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],l);const w=A(),C=Symbol();let c=class extends b.EventedAccessor{get operations(){var e;return(e=this._controller)==null?void 0:e.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){const e=this.view.allLayerViews.find((t=>t.layer===this.layer));return(e==null?void 0:e.type)==="media-3d"?e:null}get visible(){return H(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){var e;return!!((e=this._controller)!=null&&e.updating)}get _controllerClass(){var e;return this.tool==="transform"||((e=this.element.georeference)==null?void 0:e.type)!=="control-points"?h:u}constructor(e){super(e),this.tool="transform"}initialize(){this.addHandles([O((()=>this._controllerClass),(e=>this._updateController(e)),L),z((()=>this._layerView),"element-render-changed",(({element:e})=>{this.element===e&&this.emit("committed")}))])}toMap(e){const{layer:t,element:o}=this;return this.view.toMap(e,{include:{layer:t,element:o}})}createManipulator(e){const{view:t,layer:o,element:i}=this;return new l({view:t,layer:o,element:i,...e})}_updateController(e){if(this._controller&&this._controller instanceof e)return;this.removeHandles(C);const{view:t,layer:o,element:i}=this,s=()=>{this.emit("modified-externally")};this._controller=new e({view:t,layer:o,element:i,onModifiedExternally:s}),s(),this.addHandles(v(this._controller),C)}};n([r({constructOnly:!0})],c.prototype,"view",void 0),n([r({constructOnly:!0})],c.prototype,"layer",void 0),n([r({constructOnly:!0})],c.prototype,"element",void 0),n([r()],c.prototype,"tool",void 0),n([r()],c.prototype,"_controller",void 0),n([r()],c.prototype,"elevationInfo",null),n([r()],c.prototype,"_layerView",null),n([r()],c.prototype,"visible",null),n([r()],c.prototype,"updating",null),n([r()],c.prototype,"_controllerClass",null),c=n([g("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],c);export{c as ManipulatedObject3DMediaElement};
