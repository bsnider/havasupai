import{n4 as Me,e as J,ar as X,bW as G,ap as _,aq as b,t2 as y,r as l,m as r,d as R,t3 as Te,mv as Ce,cQ as Ee,av as L,u as O,qj as M,t4 as p,t5 as T,ff as Se,fs as S,t6 as j,fp as E,t7 as Y,fq as ee,fO as d,aW as A,aV as te,t8 as ie,fl as q,fe as H,aU as N,fn as B,t9 as xe,ta as D,j3 as ae,h3 as $e,eJ as se,ng as ke,c1 as ne,fa as Le,fc as He,aT as ce,tb as de,mV as ye,aS as Oe,on as _e,dk as le}from"./index-DtL3GvY-.js";import{o as Re,s as ze,m as Ie,f as Ge,d as Ae,y as Be}from"./analysisViewUtils-CMW_StFO.js";import{c as ve}from"./SlicePlane-4-CNVTeA.js";import{C as Fe}from"./BuildingComponentSublayer-BIEvEj8V.js";import{x as Ue,L as Ke,V as je,R as we,I as qe,H as Ne,w as re,v as We,j as ge,A as Pe,l as oe,_ as he,s as Ze,r as Je,M as x,e as Qe,C as V,c as W,u as Xe,m as Ye,p as et,g as tt,a as me,t as fe,b as it,d as at}from"./SlicePlaneMaterial.glsl-D57Ifihl.js";import{t as st,w as nt}from"./ShadedColorMaterial.glsl-C9NbFDzz.js";import{l as lt,n as rt}from"./Factory-BlRX26om.js";import{m as ot,M as Ve,r as F,t as U,p as ht,f as ut,h as pt,j as ct}from"./sliceToolConfig-DQ6KABpw.js";import{T as $}from"./dragEventPipeline3D-CbKvizuD.js";import{p as k}from"./InteractiveToolBase-BrCFa2VJ.js";import{o as dt}from"./ToolIntersector-Cb27K2CS.js";import{h as yt}from"./lineStippleUtils-C89mzWlO.js";import"./capabilities-DoKz1UAZ.js";import"./I3SIndexInfo-CSzMUt-X.js";import"./I3SLayerDefinitions-R4uY9oGi.js";import"./I3SUtil-C98ge0NP.js";import"./featurePopupQueryUtils-B4niRvqf.js";import"./I3SBinaryReader-Cn_XmJzB.js";import"./popupUtils-6HdFWfaZ.js";import"./ImageMaterial.glsl-D_uwocDV.js";import"./DefaultLayouts-BltAGPwH.js";import"./TriangleMaterial-h_iuqJHY.js";import"./ColorMaterial.glsl-DjSLvcHy.js";import"./VisualElement-CJZRdrnY.js";import"./line-B8eVciUl.js";import"./EditGeometryOperations-B8ZqwVEI.js";function _t(i){switch(i.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"viewshed":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case"parquet":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return Me(i.type),!1}}let P=class extends J{constructor(i){super(i),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",(i=>{const e=i.item;e!=null&&(e instanceof X||e instanceof Fe)?e instanceof X&&_t(e)?(G.getLogger(this).error("excludedLayers",`Layer '${e.title}, id:${e.id}' of type '${e.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),i.preventDefault()):this.analysis.excludedLayers.includes(e)&&i.preventDefault():(G.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),i.preventDefault())}))),gt(this.view,this),this.addHandles([_((()=>this.analysisViewData.plane),(()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()}),b),_((()=>this.analysis.excludeGroundSurface),(()=>this._updateLayerViews()),b),this.analysis.excludedLayers.on("change",(()=>this._updateLayerViews())),_((()=>[this.analysisViewData.active,this.analysisViewData.visible]),(()=>{this._updateActiveController(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()}),b),_((()=>this._allLayerAndSubLayerViews),(()=>this._updateLayerViews()))]),this.addHandles([_((()=>this.analysis.shape),(()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())}),b),_((()=>{var i;return((i=this.analysis.origin)==null?void 0:i.type)!=="web-scene"}),(()=>this._updateViewSlicePlaneDecoration()),b)],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slice.plane=null,this._updateActiveController(),this._updateViewSlicePlane()),Pt(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const i=this.view.allLayerViews.items;return i.concat(i.filter(Ue).flatMap((({sublayerViews:e})=>e.items)))}_updateBoundedPlaneFromSlicePlane(){const i=this.analysis.shape,e=this._currentSlicePlane;if(e==null&&i==null||e!=null&&i!=null&&i.equals(e))return;let t=null,a=null;if((i==null?void 0:i.position)!=null){const s=i.position.spatialReference,n=Ke(i,this.view);n==null&&st(this.analysis,s,G.getLogger(this)),t=je(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},y()),t!=null&&(a={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=t,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const i=this.analysisViewData.plane,e=we(i,this.view,this.view.spatialReference,new ve);let t=null;e!=null&&(t={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height}),this._currentSlicePlane=t,this._internalChange=!0,this.analysis.shape=e,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(K)return;const i=Q(this.view);if(i)if(this.analysisViewData.active)i.activeController!=null&&i.activeController!==this?(K=!0,i.activeController.analysisViewData.active=!1,K=!1):i.activeController!=null&&i.activeController,this._updateLayerViews(),i.activeController=this;else{if(i.activeController!=null&&i.activeController!==this)return;i.activeController!=null&&i.activeController===this&&(i.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){vt(this.view)}_updateViewSlicePlaneDecoration(){wt(this.view)}_updateLayerViews(){const i=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,e=[],t=a=>{"layers"in a?a.layers.forEach(t):e.push(a)};this.analysis.excludedLayers.forEach(t),this.view.allLayerViews.forEach((a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=i&&!e.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach((s=>{s.slicePlaneEnabled=i&&!e.includes(s.sublayer)})))})),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=i&&!this.analysis.excludeGroundSurface)}};l([r()],P.prototype,"view",void 0),l([r()],P.prototype,"analysis",void 0),l([r()],P.prototype,"analysisViewData",void 0),l([r()],P.prototype,"_allLayerAndSubLayerViews",null),P=l([R("esri.views.3d.analysis.Slice.SliceController")],P);const m=new Map;let K=!1;function vt(i){const e=Q(i),t=e==null?void 0:e.activeController;(t==null?void 0:t.analysisViewData.plane)!=null&&t.analysisViewData.visible?i.slice.plane=t.analysisViewData.plane:i.slice.plane=null}function wt(i){var a;const e=Q(i),t=e==null?void 0:e.activeController;i.slice.isDecoration=((a=t==null?void 0:t.analysis.origin)==null?void 0:a.type)!=="web-scene"}function gt(i,e){var t;m.has(i)||m.set(i,{all:[],activeController:null}),(t=m.get(i))==null||t.all.push(e)}function Q(i){return m.get(i)}function Pt(i,e){if(!m.has(i))throw new Error("view expected in global slice register");const t=m.get(i),a=(t==null?void 0:t.all.lastIndexOf(e))??-1;if(!t||a===-1)throw new Error("controller expected in global slice register");t.all.splice(a,1),t.all.length===0&&m.delete(i)}var Z,f;let u=(f=class extends Re{constructor(e){super(e),this._clock=Te,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._mode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=ot,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=y(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Ce(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=dt(e.view.state.viewingMode)}initialize(){var o;if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const e=h=>{this._updateManipulatorsInteractive(h),h.grabbing||(this.analysisViewData.plane!=null&&p(this.analysisViewData.plane,this._startPlane),this.inputState=null)},t=new qe(this.view,Ne.CENTER_ON_ARROW);this.shiftManipulator=t,this.manipulators.add(t),this.addHandles([this._createShiftDragPipeline(t),t.events.on("grab-changed",(h=>{this._onShiftGrab(h),e(t)}))]);const a=!((o=this.view.stage)!=null&&o.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result),s=new re(this.view,((h,v)=>lt(this.view.stage.textures,{accentColor:h,contrastColor:v,preMultiplyAlpha:a})));this.rotateHeadingManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateHeadingDragPipeline(s),s.events.on("grab-changed",(h=>{this._onRotateHeadingGrab(h),e(s)}))]);const n=new re(this.view,((h,v)=>rt(this.view.stage.textures,{accentColor:h,contrastColor:v,preMultiplyAlpha:a})));this.rotateTiltManipulator=n,this.manipulators.add(n),this.addHandles([this._createRotateTiltDragPipeline(n),n.events.on("grab-changed",(h=>{this._onRotateTiltGrab(h),e(n)}))]),this.resizeManipulators=this._resizeHandles.map(((h,v)=>{const w=new We(this.view,h);return this.addHandles([this._createResizeDragPipeline(w),w.events.on("grab-changed",(z=>{this._onResizeGrab(z,v),e(w)}))]),w})),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=ge(this.view),this._previewPlaneOutlineVisualElement=Pe(this.view),this._previewPlaneOutlineVisualElement.width=Ve,this.addHandles(_((()=>[this.analysisViewData.plane,this.analysis.tiltEnabled]),(()=>this._updateManipulators()),b)),this.addHandles([Ee((()=>this.state==="sliced"),(()=>{this.finishToolCreation(),this.stop()}),L),_((()=>this.view.state.camera),(()=>this._onCameraChange()))])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=O(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=O(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this.active?this._placingSlicePlane||this.mode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null:null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",e)}get mode(){return this._mode}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=e!=null&&e.type==="resize",this._updateMaterials()}get _placingSlicePlane(){return this.active&&!this.inputState&&this._mode==="place"}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}start(e){this._finishToolCreationIfValid(),this._mode=e,this.active||(this.view.activeTool=this)}stop(){this.active&&(this.view.activeTool=null)}onActivate(){this._finishToolCreationIfValid(),this._mode==="none"&&this.analysisViewData.plane==null&&(this._mode="place")}onDeactivate(){this._mode="none",this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this._updateManipulators(),e||this._clearPointerMoveTimeout()}onInputEvent(e){switch(e.type){case"pointer-drag":if(!pe(e))return;this._placingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!pe(e))return;this._mode==="exclude"?e.defer((async()=>{await this._onClickExcludeLayer(e)&&e.stopPropagation()})):this._onClickPlacePlane(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&t!=null&&t.type==="shift"){const a=M(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:a,screenPoint:a}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(M(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const t=M(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),p(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(!this._placingSlicePlane)return!1;const t=M(e),a=y();if(this._pickPlane(t,!1,this._activeKeyModifiers,a)){if(e.type==="pointer-drag"){const s=T(this.view.state.camera,t,C);this.inputState=ue(s,e.pointerId,a.origin,a)}return p(a,this._startPlane),this.analysis.shape=we(a,this.view,this.view.spatialReference,new ve),e.type!=="pointer-drag"&&this.stop(),!0}return!1}async _onClickExcludeLayer(e){if(this.mode!=="exclude")return!1;const t=await this.view.hitTest(M(e)),a=t.results.at(0);if(a){const s=a.type==="graphic"&&a.graphic;if(s){const n=s.sourceLayer||s.layer;n&&this.analysis.excludedLayers.push(n)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0;return this.stop(),!0}_onKeyDown(e){return(e.key===F||e.key===U)&&(this._activeKeyModifiers[e.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==F&&e.key!==U||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=T(this.view.state.camera,e.screenPoint,C);p(this.analysisViewData.plane,this._startPlane),this.inputState=ue(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return k(e,((t,a,s)=>{const n=this.inputState;if(n==null||n.type!=="shift")return;const o=this.analysisViewData.plane!=null?p(this.analysisViewData.plane,y()):null;a.next($(this.view,n.shiftPlane)).next(this._shiftDragAdjustSensitivity(n)).next(this._shiftDragUpdatePlane(n)),s.next((()=>{o!=null&&this._updateBoundedPlane(o)}))}))}_shiftDragAdjustSensitivity(e){return t=>{if(this.analysisViewData.plane==null)return null;const a=.001,s=Math.min((1-Math.abs(S(j(this.analysisViewData.plane),t.ray.direction)/E(t.ray.direction)))/a,1),n=-Y(this._startPlane.plane,t.renderEnd),o=-Y(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-s)+n*s-o,t}}_shiftDragUpdatePlane(e){return()=>{if(this.analysisViewData.plane==null)return;const t=ee(d.get(),this._startPlane.origin),a=ee(d.get(),j(this._startPlane));A(a,a,-e.depth),te(a,a,t);const s=ie(a,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,y());this._updateBoundedPlane(s)}}_onRotateHeadingGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=oe(this.analysisViewData.plane,this.view.renderCoordsHelper,he.HEADING,q()),a=T(this.view.state.camera,e.screenPoint,C),s=N();H(t,a,s)&&(p(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:s})}_createRotateHeadingDragPipeline(e){return k(e,((t,a,s)=>{const n=this.inputState;if(n==null||n.type!=="rotate")return;const o=this.analysisViewData.plane!=null?p(this.analysisViewData.plane,y()):null;a.next($(this.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdatePlaneFromRotate()),s.next((()=>{o!=null&&this._updateBoundedPlane(o)}))}))}_onRotateTiltGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=oe(this.analysisViewData.plane,this.view.renderCoordsHelper,he.TILT,q()),a=T(this.view.state.camera,e.screenPoint,C),s=N();H(t,a,s)&&(p(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:s})}_createRotateTiltDragPipeline(e){return k(e,((t,a,s)=>{const n=this.inputState;if(n==null||n.type!=="rotate")return;const o=this.analysisViewData.plane!=null?p(this.analysisViewData.plane,y()):null;a.next($(this.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdatePlaneFromRotate()),s.next((()=>{o!=null&&this._updateBoundedPlane(o)}))}))}_rotateDragRenderPlaneToRotate(e){return t=>{if(this.analysisViewData.plane==null)return null;const a=B(e.rotatePlane),s=nt(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,a);return{...t,rotateAxis:a,rotateAngle:s}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(this.analysisViewData.plane==null)return;const t=xe(D.get(),e.rotateAngle,e.rotateAxis);if(t==null)return;const a=ae(d.get(),this._startPlane.basis1,t),s=ae(d.get(),this._startPlane.basis2,t),n=ie(this.analysisViewData.plane.origin,a,s,y());this._updateBoundedPlane(n)}}_onResizeGrab(e,t){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const a=T(this.view.state.camera,e.screenPoint,C),s=d.get();H(this.analysisViewData.plane.plane,a,s)&&(p(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:$e(s)})}_createResizeDragPipeline(e){return k(e,((t,a,s)=>{const n=this.inputState;if(n==null||n.type!=="resize"||this.analysisViewData.plane==null)return;const o=p(this.analysisViewData.plane,y());a.next($(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(n)),s.next((()=>{this._updateBoundedPlane(o)}))}))}_resizeDragUpdatePlane(e){return t=>{if(this.analysisViewData.plane==null)return;const a=this._resizeHandles[e.activeHandleIdx],s=Ze(a,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,p(this.analysisViewData.plane));this._updateBoundedPlane(s)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(t==null)throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){if(this.mode==="exclude")return;let a=this._previewPlane;if(this._previewPlane=null,e==null)return this._removeFrameTask(),void this._updateManipulators();if(this.active){const s=a??y();if(a=a!=null?p(a,mt):null,this._pickPlane(e,!0,t,s)){const n=ut;let o=!1;a!=null&&(o=S(B(a.plane),B(s.plane))<n||S(se(d.get(),a.basis1),se(d.get(),s.basis1))<n),o&&(this._previewPlaneOpacity=0),this._previewPlane=s}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=ke({update:({deltaTime:s})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+s/(1e3*ht),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=ne(this._frameTask)}_pickMinResult(e){const t=Le(e,He.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,a,s){const n=this._pickMinResult(e),o=d.get();if(!n.getIntersectionPoint(o))return!1;const h=n.getTransformedNormal(d.get()),v=this.view.state.camera;S(h,v.viewForward)>0&&A(h,h,-1);const w=Je(o,v),z=(t?1:-1)*w*pt,I=A(d.get(),h,z);te(I,I,o);const be=this.analysis.tiltEnabled?x.TILTED:x.HORIZONTAL_OR_VERTICAL,De=a[F]?x.VERTICAL:a[U]?x.HORIZONTAL:be;return Qe(I,h,w,w,v,De,this.view.renderCoordsHelper,s),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=ne(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=V,this.rotateHeadingManipulator.state|=V,this.rotateTiltManipulator.state|=V,this._prevPointerMoveTimeout=this._clock.setTimeout((()=>{this.shiftManipulator.state&=~V,this.rotateHeadingManipulator.state&=~V,this.rotateTiltManipulator.state&=~V}),this._pointerMoveTimerMs)}_updateManipulators(){if(Z.disableEngineLayers)return;let e,t,a=!1;if(this.analysisViewData.plane!=null)e=this.analysisViewData.plane,t=this._previewPlane??e,a=!1;else{if(this._previewPlane==null)return this._setManipulatorVisibility(!1),void this._setPreviewPlaneVisibility(!1);t=e=this._previewPlane,a=!0}if(this._setManipulatorVisibility(!a),!a){const s=W(e,D.get());Xe(this.shiftManipulator,s,e,this.view.state.camera),Ye(this.rotateHeadingManipulator,s,e,this.view.renderCoordsHelper),et(this.rotateTiltManipulator,s,e),this.resizeManipulators.forEach(((n,o)=>tt(n,this._resizeHandles[o],s,e)))}this._setPreviewPlaneVisibility(!this._creatingPointerId&&(a||this._mode==="place")),this._updatePreviewPlaneTransform(t),this._updateMaterials()}_setManipulatorVisibility(e){this.shiftManipulator.available=e,this.rotateHeadingManipulator.available=e,this.rotateTiltManipulator.available=e&&this.analysis.tiltEnabled,this.resizeManipulators.forEach((t=>t.available=e))}_updatePreviewPlaneTransform(e){const t=W(e,D.get()),a=ce(d.get(),E(e.basis1),E(e.basis2),1),s=de(D.get(),a),n=ye(s,t,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n}_setPreviewPlaneVisibility(e){const t=this._previewPlaneOutlineVisualElement,a=this._previewPlaneGridVisualElement;e&&(t.attached=!0,a.attached=!0),t.visible=e,a.visible=e}_updateMaterials(){const e=me(this.view.effectiveTheme);e[3]*=this._previewPlaneOpacity;const t=Oe(fe);t[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=e,this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=_e}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach((t=>{t.interactive=!0}));this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach((t=>{t.interactive=t===e}))}_finishToolCreationIfValid(){this.analysis.valid&&this.finishToolCreation()}get test(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}},Z=f,f.disableEngineLayers=!1,f);function ue(i,e,t,a){const s=it(t,j(a),i.direction,q()),n=N();return H(s,i,n)?{type:"shift",creatingPointerId:e,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function pe(i){return i.pointerType!=="mouse"||i.button===0}l([r()],u.prototype,"_clock",void 0),l([r({constructOnly:!0})],u.prototype,"view",void 0),l([r()],u.prototype,"analysisViewData",void 0),l([r({readOnly:!0})],u.prototype,"state",null),l([r({readOnly:!0})],u.prototype,"cursor",null),l([r()],u.prototype,"analysis",null),l([r()],u.prototype,"removeIncompleteOnCancel",void 0),l([r()],u.prototype,"_mode",void 0),l([r()],u.prototype,"mode",null),l([r({value:null})],u.prototype,"inputState",null),l([r()],u.prototype,"_placingSlicePlane",null),l([r()],u.prototype,"_creatingPointerId",null),u=Z=l([R("esri.views.3d.analysis.Slice.SliceTool")],u);const mt=y(),C=Se();let g=class extends J{constructor(i){super(i),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const i=this.analysisViewData;if(i==null)throw new Error("expected internal object to be valid");this._gridVisualElement=ge(this.view),this._outlineVisualElement=Pe(this.view),this.addHandles([_((()=>{const e=i.plane!=null&&this.analysisViewData.visible,{active:t}=this.analysisViewData,{preview:a,showGrid:s,view:n}=this,{effectiveTheme:o}=n;return{visible:e,active:t,preview:a,showGrid:s,gridColor:at(o),outlineColor:me(o)}}),(e=>this._updateMaterials(e)),L),_((()=>i.plane),(e=>this._updatePlane(e)),L),le(this._gridVisualElement),le(this._outlineVisualElement),_((()=>{var e,t;return((t=(e=this.analysis)==null?void 0:e.origin)==null?void 0:t.type)!=="web-scene"}),(e=>{this._gridVisualElement.isDecoration=e,this._outlineVisualElement.isDecoration=e}),L)])}destroy(){this.set("view",null)}_updatePlane(i){if(i==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const e=ce(d.get(),E(i.basis1),E(i.basis2),1),t=de(D.get(),e),a=W(i,D.get()),s=ye(t,a,t);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:i,active:e,preview:t,showGrid:a,gridColor:s,outlineColor:n}){this._outlineVisualElement.color=n,this._outlineVisualElement.width=t?Ve:ct,this._outlineVisualElement.stipplePattern=e?null:yt(5),this._gridVisualElement.backgroundColor=fe,this._gridVisualElement.gridColor=a?s:_e,this._gridVisualElement.visible=i,this._outlineVisualElement.visible=i}};l([r()],g.prototype,"view",void 0),l([r()],g.prototype,"analysis",void 0),l([r()],g.prototype,"analysisViewData",void 0),l([r()],g.prototype,"showGrid",void 0),l([r()],g.prototype,"preview",void 0),g=l([R("esri.views.3d.analysis.Slice.SliceVisualization")],g);let c=class extends ze(J){constructor(i){super(i),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.plane=null,this.active=!0,this.userOperation=null,this._analysisVisualization=null,this._analysisController=null}initialize(){this._analysisVisualization=new g({view:this.view,analysis:this.analysis,analysisViewData:this}),this._analysisController=new P({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(Ie(this,u))}destroy(){Ge(this),this._analysisVisualization=O(this._analysisVisualization),this._analysisController=O(this._analysisController)}get editable(){return!this._analysisVisualization.preview}set editable(i){this._analysisVisualization.preview=!i}get showGrid(){var i;return((i=this._analysisVisualization)==null?void 0:i.showGrid)??!1}set showGrid(i){this._analysisVisualization&&(this._analysisVisualization.showGrid=i)}get testData(){}place(i){return this.active=!0,Ae(this,{placementOptions:i,onToolActivated:e=>e.start("place")})}async pickLayerToExclude(i){return this.active=!0,Be(this,{abortOptions:i,onToolActivated:e=>e.start("exclude")})}};l([r({readOnly:!0})],c.prototype,"type",void 0),l([r({constructOnly:!0,nonNullable:!0})],c.prototype,"analysis",void 0),l([r()],c.prototype,"tool",void 0),l([r()],c.prototype,"plane",void 0),l([r()],c.prototype,"active",void 0),l([r()],c.prototype,"editable",null),l([r()],c.prototype,"showGrid",null),l([r()],c.prototype,"userOperation",void 0),l([r()],c.prototype,"_analysisVisualization",void 0),l([r()],c.prototype,"_analysisController",void 0),c=l([R("esri.views.3d.analysis.SliceAnalysisView3D")],c);const Nt=c;export{Nt as default};
