import{Z as zt,P as Tt,aZ as O,ba as L,b8 as tt,b9 as et,kN as Ut,kQ as Ot,b7 as Ct,a_ as V,bk as Vt,a$ as Nt,bj as Gt,bl as N,o8 as jt,o9 as kt,bm as Ft,h0 as Ht,oa as Wt,ob as Zt,oc as lt,ml as K,od as ut,oe as ht,kO as qt,bK as Q,of as Jt,dN as Kt,bc as Qt,aU as I,ln as Xt,h6 as Y,ha as Yt,mL as te,m2 as ee,og as se,oh as ne,b4 as pt,m_ as ae,oi as oe,oj as ie,ok as re,ol as ce,om as le,ab as ue,on as he,aT as G,j3 as W,fR as dt,eI as Et,eJ as st,oo as pe,op as de,oq as ge,or as me,l_ as fe,os as ye,fq as be,fm as gt}from"./index-CxDa6KP7.js";import{t as _e,e as mt}from"./SnappingCandidate-DGkpYqI6.js";import{a as xe}from"./renderingInfoUtils-DFMKSoKW.js";import{c as Se,a as It,p as At}from"./triangulationUtils-CCjeV0QS.js";function Fe(s,t,e){const a=(t.length>0?t[0]:s.length/3)-1,n=Se(s,a,e);if(n!==Ut.Z){s=s.slice();for(let o=0;o<s.length;o+=3)s[o+n]=s[o+2]}return Ot(s,t,3)}function He(s){const t=[[O.POSITION,new L(s.attributeData.position,s.indices,3,!0)]],e=Ct(s.indices.length);return s.attributeData.colorFeature!=null?t.push([O.COLORFEATUREATTRIBUTE,new L([s.attributeData.colorFeature],e,1,!0)]):s.attributeData.color&&t.push([O.COLOR,new L(s.attributeData.color,e,4,!0)]),s.attributeData.uvMapSpace&&t.push([O.UVMAPSPACE,new L(s.attributeData.uvMapSpace,s.indices,4,!0)]),s.attributeData.boundingRect&&t.push([O.BOUNDINGRECT,new L(s.attributeData.boundingRect,s.indices,9,!0)]),new tt(s.material,t,s.mapPositions,et.Mesh,s.attributeData.objectAndLayerIdColor)}function We(s,t=null){const e=[[O.POSITION,new L(s.attributeData.position,s.indices,3,!0)],[O.UV0,new L(s.attributeData.uv0,s.indices,2,!0)]];return new tt(s.material,e,s.mapPositions,et.Mesh,t)}function Pe(s){switch(s.type){case"extent":if(s instanceof zt)return Tt.fromExtent(s);break;case"polygon":return s}return null}let Ze=class{constructor(t,e,a){this.renderData=t,this.layerViewUid=e,this.graphicUid=a,this.outGeometries=new Array}};function we(s,t,e,a){const n=It(s.rings,!!s.hasZ&&a.mode!=="on-the-ground",At.CCW_IS_HOLE,s.spatialReference),o=V(n.position.length),i=Vt(n.position,s.spatialReference,0,o,0,n.position,0,n.position.length/3,t,e,a),l=i!=null;return new Ee(n.position,o,vt(n.polygons,n.position,o),Mt(n.outlines,n.position,o),l,i)}function Je(s,t){const e=It(s.rings,!1,At.CCW_IS_HOLE),a=Nt(e.position,s.spatialReference,0,e.position,t,0);for(let n=2;n<e.position.length;n+=3)e.position[n]=Gt;return{position:e.position,polygons:vt(e.polygons,e.position),outlines:Mt(e.outlines,e.position),projectionSuccess:a}}function Mt(s,t,e=null){return s.filter((({count:a})=>a>1)).map((({index:a,count:n})=>{const o=3*a,i=3*n;return e!=null?new Rt(a,n,N(t,o,i),N(e,o,i)):new nt(a,n,N(t,o,i))}))}function vt(s,t,e=null){const a=new Array;for(const{index:n,count:o,holeIndices:i,pathLengths:l}of s){if(o<=1)continue;const c=3*n,m=3*o,f=i.map((g=>g-n)),d=e!=null?new Oe(n,o,N(t,3*n,3*o),N(e,c,m),f,l):new Ce(n,o,N(t,3*n,3*o),f,l);a.push(d)}return a}class nt{constructor(t,e,a){this.index=t,this.count=e,this.position=a}}class Rt extends nt{constructor(t,e,a,n){super(t,e,a),this.mapPositions=n}}class Oe extends Rt{constructor(t,e,a,n,o,i){super(t,e,a,n),this.holeIndices=o,this.pathLengths=i}}class Ce extends nt{constructor(t,e,a,n,o){super(t,e,a),this.holeIndices=n,this.pathLengths=o}}class Ee{constructor(t,e,a,n,o,i){this.position=t,this.mapPositions=e,this.polygons=a,this.outlines=n,this.projectionSuccess=o,this.sampledElevation=i}}const Ie=["polygon","extent"];class Ke extends jt{constructor(t,e,a,n){super(t,e,a,n,$e(e)),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const g=kt(this._getSymbolSize());if(g)throw new Ft("graphics3dextrudesymbollayer:invalid-size",g)}const t=this.symbolLayer,e=t==null?void 0:t.material,a=e==null?void 0:e.color,n=this._getCombinedOpacityAndColor(a),o=Ht(n),i=n[3],l=this.needsDrivenTransparentPass,c=e==null?void 0:e.emissive,m={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:o,ambient:o,opacity:i,drivenOpacity:l,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:(c==null?void 0:c.strength)??0,emissiveSource:Zt.Color,offsetTransparentBackfaces:!0,normalType:Wt.Compressed},f=new lt(m,this._context);f.setParameters({cullFace:f.transparent?K.None:K.Back});const d=new lt({...m,cullFace:K.Back},this._context);this._materials[R.Main]=f,this._materials[R.Bottom]=d}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Ie,this.symbolLayer.type))return null;const a=this._getVertexOpacityAndColor(t.renderingInfo,this._getFallbackOpacityAndColor(),255),n=this.setGraphicElevationContext(e);return this._createAs3DShape(e,t.renderingInfo,a,n,e.uid)}layerOpacityChanged(t,e){var i,l,c,m;const a=(l=(i=this.symbolLayer)==null?void 0:i.material)==null?void 0:l.color,n=this._getCombinedOpacity(a);(c=this._materials[R.Main])==null||c.setParameters({opacity:n}),(m=this._materials[R.Bottom])==null||m.setParameters({opacity:n});const o=this._getLayerOpacity();t==null||t.forEach((f=>{var d;return(d=e(f))==null?void 0:d.layerOpacityChanged(o,this._context.isAsync)}))}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,ut)}slicePlaneEnabledChanged(t,e){var a,n;return(a=this._materials[R.Main])==null||a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(n=this._materials[R.Bottom])==null||n.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t==null||t.forEach((o=>{const i=e(o);i!=null&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){var e,a;const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return(e=this._materials[R.Main])==null||e.setParameters(t),(a=this._materials[R.Bottom])==null||a.setParameters(t),!0}_getExtrusionSize(t){let e;return e=t.size&&this._drivenProperties.size?xe(t.size,2)??0:this._getSymbolSize(),e/=this._context.renderCoordsHelper.unitInMeters,e}applyRendererDiff(t,e){return this._drivenPropertiesChanged(e)?ht.RecreateSymbol:ht.RecreateGraphics}async queryForSnapping(t,e,a,n){const o=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/qt(e),{objectId:i,target:l}=t,c=Q(l);switch(c.z=(c.z??0)+o,t.type){case"edge":{const{start:m,end:f}=t,d=Q(m),g=Q(f);return d.z=(d.z??0)+o,g.z=(g.z??0)+o,[mt(i,c,1/0,d,g)]}case"vertex":return[_e(i,c,1/0),mt(i,l,1/0,l,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,e,a,n,o){const i=Pe(t.geometry);if(i==null)return null;if(i.rings.length===0||!i.rings.some((A=>A.length>0)))return this._logGeometryValidationWarnings(i.rings,"rings","ExtrudeSymbol3DLayer"),null;const l=we(i,this._context.elevationProvider,this._context.renderCoordsHelper,n);this._logGeometryCreationWarnings(l,i.rings,"rings","ExtrudeSymbol3DLayer");const c=Jt(i);if(c==null)return null;const m=new Array,f=new Array,d=Kt(),g=Y(),E=I(),u=this._context.renderCoordsHelper.viewingMode===Qt.Global;u||this._context.renderCoordsHelper.worldUpAtPosition(null,E),Xt(i.spatialReference,[c.x,c.y,0],g,this._context.renderCoordsHelper.spatialReference);const b=Y();Yt(b,g);const y=ee();te(y,b);const{polygons:x,mapPositions:p,position:_}=l,h=new Map,P=this._materials[R.Main];for(const A of x){const D=A.count;if(this._context.clippingExtent&&(se(A.mapPositions,d),!ne(d,this._context.clippingExtent)))continue;const B=Ot(A.mapPositions,A.holeIndices,3);if(B.length===0)continue;const z=B.length,$=6*D,T=pt($+z),Z=pt(z),k=V(3*$),at=V(3*$),ot=V(3*$),it=V($);Ae(_,p,B,A,k,ot,at,it,T,Z,this._getExtrusionSize(e),E,u),ae(k,k,b);const rt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerViewUid:this._context.layerViewUid}),q=new Ue(k,ot,oe(at),it),J=ft(P,T,T.length-Z.length,q,a,rt),Lt=D,Dt=D,Bt=2*A.count,ct=new Ve(Lt,Dt,Bt,z/3);$t(J,ct,g),h.set(J,ct),m.push(J,ft(this._materials[R.Bottom],Z,0,q,a,rt)),f.push(q.heights)}if(m.length===0)return null;const r=new ie({geometries:m,layerViewUid:this._context.layerViewUid,graphicUid:o,isElevationSource:!0});r.transformation=g;const S=re(this.symbolLayer,{opacity:this._getLayerOpacity()}),w=S?new ce(this._materials[R.Main],S,this._context.slicePlaneEnabled):null,M=new le(this,r,null,((A,D,B,z,$)=>Re(A,D,B,z,$,f,h)),n,w);return M.alignedSampledElevation=l.sampledElevation,M.needsElevationUpdates=ut(n.mode),M}_getFallbackOpacityAndColor(){var e,a;const t=(a=(e=this.symbolLayer)==null?void 0:e.material)==null?void 0:a.color;return ue.toUnitRGBA(t)??he}}function ft(s,t,e,a,n,o){const i=Ct(t.length),l=[[O.POSITION,new L(a.positions,t,3,!0)],[O.NORMALCOMPRESSED,new L(a.normals,t,2,!0)],[O.COLOR,new L(n,i,4,!0)]];return new tt(s,l,a.elevation,et.Mesh,o,e)}function Ae(s,t,e,a,n,o,i,l,c,m,f,d,g){const E=e.length/3;let u=2*a.count;Me(s,t,a.index,a.count,e,0,E,n,o,i,l,c,m,u,f,d,g);let b=0,y=2*a.count;u=0;const x=a.pathLengths[0];yt(n,o,l,i,b,x,a.count,y,c,u,f),y+=4*x,u+=2*x,b+=x;for(let p=1;p<a.pathLengths.length;++p){const _=a.pathLengths[p];yt(n,o,l,i,b,_,a.count,y,c,u,f),y+=4*_,u+=2*_,b+=_}}function Me(s,t,e,a,n,o,i,l,c,m,f,d,g,E,u,b,y){be(v,b),c??(c=[]),m??(m=[]),f??(f=[]);const x=u>0?1:-1;let p=3*e,_=0,h=3*_,P=a,r=3*P;for(let M=0;M<a;++M){const A=s[p],D=s[p+1],B=s[p+2];y&&(v[0]=A,v[1]=D,v[2]=B,st(v,v)),l[h+0]=A,l[h+1]=D,l[h+2]=B;const z=t[p+0],$=t[p+1],T=t[p+2];c[h+0]=z,c[h+1]=$,c[h+2]=T,m[h+0]=-x*v[0],m[h+1]=-x*v[1],m[h+2]=-x*v[2],f[_]=0,l[r+0]=A+u*v[0],l[r+1]=D+u*v[1],l[r+2]=B+u*v[2],c[r+0]=z,c[r+1]=$,c[r+2]=T,f[P]=u,h+=3,r+=3,p+=3,_+=1,P+=1}p=3*o,h=0,r=3*E;const S=u<0?wt:Pt,w=u<0?Pt:wt;for(let M=0;M<i;++M)g[h]=n[p+S[0]],g[h+1]=n[p+S[1]],g[h+2]=n[p+S[2]],d[r]=n[p+w[0]]+a,d[r+1]=n[p+w[1]]+a,d[r+2]=n[p+w[2]]+a,h+=3,r+=3,p+=3}function F(s,t,e,a,n,o,i){a[o]=a[i],i*=3,s[o*=3]=s[i],s[o+1]=s[i+1],s[o+2]=s[i+2],t[o]=t[i],t[o+1]=t[i+1],t[o+2]=t[i+2],e[o]=n[0],e[o+1]=n[1],e[o+2]=n[2]}const j=I();function yt(s,t,e,a,n,o,i,l,c,m,f){t??(t=[]),e??(e=[]),a??(a=[]);let d=n,g=n+1,E=n+i,u=n+i+1,b=l,y=l+1,x=l+2*o,p=l+2*o+1;f<0&&(d=n+i+1,u=n);let _=3*m;for(let h=0;h<o;++h)h===o-1&&(g=n,f>0?u=n+i:d=n+i),ve(s,d,g,E,j),F(s,t,a,e,j,b,d),F(s,t,a,e,j,y,g),F(s,t,a,e,j,x,E),F(s,t,a,e,j,p,u),c[_]=b,c[_+1]=x,c[_+2]=p,c[_+3]=b,c[_+4]=p,c[_+5]=y,_+=6,d++,g++,E++,u++,b+=2,y+=2,x+=2,p+=2}const X=I(),bt=I(),_t=I(),xt=I(),St=I();function ve(s,t,e,a,n){t*=3,e*=3,a*=3,G(X,s[t++],s[t++],s[t++]),G(bt,s[e++],s[e++],s[e++]),G(_t,s[a++],s[a++],s[a++]),gt(xt,bt,X),gt(St,_t,X),Et(n,St,xt),st(n,n)}const U=I();function Re(s,t,e,a,n,o,i){const l=s.stageObject,c=l.geometries,m=c.length,f=t.mode!=="absolute-height";let d=0;const g=l.transformation,E=de(Y(),g);for(let u=0;u<m;u+=2){const b=c[u];if(!ge(b))continue;const y=b.getMutableAttribute(O.POSITION).data,x=o[u/2],p=new me(b.mapPositions),_=y.length/3;let h=!1,P=0;{let r=0;for(let S=0;S<_;S++){U[0]=y[r],U[1]=y[r+1],U[2]=y[r+2],a(p,H),f&&(P+=H.sampledElevation),ye.TESTS_DISABLE_OPTIMIZATIONS?(G(C,p.array[p.offset],p.array[p.offset+1],H.z+x[r/3]),e!=null&&n.toRenderCoords(C,e,C),W(C,C,E)):(G(C,y[r],y[r+1],y[r+2]),W(C,C,g),n.setAltitude(C,H.z+x[r/3]),W(C,C,E)),y[r]=C[0],y[r+1]=C[1],y[r+2]=C[2];const w=Le/n.unitInMeters;(Math.abs(U[0]-y[r])>=w||Math.abs(U[1]-y[r+1])>=w||Math.abs(U[2]-y[r+2])>=w)&&(h=!0),p.offset+=3,r+=3}}if(h){const r=i.get(b);r&&$t(b,r,g),l.geometryVertexAttributeUpdated(c[u],O.NORMALCOMPRESSED),b.invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(c[u],O.POSITION),c[u+1].invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(c[u+1],O.POSITION)}d+=P/_}return d/m}function $t(s,t,e){const a=s.getMutableAttribute(O.POSITION),n=s.getMutableAttribute(O.NORMALCOMPRESSED).data,{topVertexStart:o,topVertexCount:i,topFaceStart:l,topFaceCount:c}=t,m=a.data,f=i,d=s.attributes.get(O.POSITION).indices,g=l+c,E=o+i,u=V(3*f);for(let h=0;h<f;++h){const P=3*h;u[P+0]=0,u[P+1]=0,u[P+2]=0}const b=De,y=Be,x=ze,p=Te,_=v;for(let h=l;h<g;++h){const P=3*h;for(let r=0;r<3;++r){const S=d[P+r];p[r]=S;const w=3*S;G(C,m[w+0],m[w+1],m[w+2]),W(b[r],C,e)}dt(y,b[1],b[0]),dt(x,b[2],b[0]),Et(_,y,x),st(_,_);for(let r=0;r<3;++r){const S=3*(p[r]-o);u[S+0]+=_[0],u[S+1]+=_[1],u[S+2]+=_[2]}}for(let h=o;h<E;++h){const P=3*(h-o),r=u[P+0],S=u[P+1],w=u[P+2],M=Math.sqrt(r*r+S*S+w*w);pe(n,h,r/M,S/M,w/M)}}function $e(s){var t,e;return(((e=(t=s.material)==null?void 0:t.color)==null?void 0:e.a)??1)===1}const C=I(),v=I(),H=new fe,Pt=[0,2,1],wt=[0,1,2],Le=.01,De=[I(),I(),I()],Be=I(),ze=I(),Te=[0,0,0];var R;(function(s){s[s.Main=0]="Main",s[s.Bottom=1]="Bottom"})(R||(R={}));class Ue{constructor(t,e,a,n){this.positions=t,this.elevation=e,this.normals=a,this.heights=n}}class Ve{constructor(t,e,a,n){this.topVertexStart=t,this.topVertexCount=e,this.topFaceStart=a,this.topFaceCount=n}}export{We as a,Pe as b,Je as c,Ze as g,Fe as l,He as m,Ae as n,we as p,Ke as s};
