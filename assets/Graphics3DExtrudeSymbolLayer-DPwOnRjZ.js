import{z as Bt,P as Tt,aM as w,aZ as L,aX as tt,aY as et,kQ as Ut,kT as wt,aW as Ct,aN as V,b7 as Vt,aO as Nt,b6 as Gt,b8 as N,ob as jt,oc as Ft,L as kt,h0 as Ht,od as Wt,oe as qt,of as lt,mo as Q,og as ut,oh as ht,kR as Zt,bv as Y,oi as Xt,dl as Qt,a$ as Yt,aH as I,lq as Jt,h6 as K,ha as Kt,mO as te,m5 as ee,oj as se,ok as ne,aT as pt,n1 as ae,ol as oe,om as ie,on as re,oo as ce,op as le,a0 as ue,oq as he,aG as G,j8 as W,fq as dt,eh as Et,ei as st,or as pe,os as de,ot as ge,ou as me,m1 as fe,ov as ye,e$ as be,eX as gt}from"./index-Ds3x37R4.js";import{t as _e,e as mt}from"./SnappingCandidate-DGkpYqI6.js";import{a as xe}from"./renderingInfoUtils-BM-uPzZg.js";import{c as Se,a as It,p as At}from"./triangulationUtils-C7XMlhsz.js";function ke(s,t,e){const a=(t.length>0?t[0]:s.length/3)-1,n=Se(s,a,e);if(n!==Ut.Z){s=s.slice();for(let o=0;o<s.length;o+=3)s[o+n]=s[o+2]}return wt(s,t,3)}function He(s){const t=[[w.POSITION,new L(s.attributeData.position,s.indices,3,!0)]],e=Ct(s.indices.length);return s.attributeData.colorFeature!=null?t.push([w.COLORFEATUREATTRIBUTE,new L([s.attributeData.colorFeature],e,1,!0)]):s.attributeData.color&&t.push([w.COLOR,new L(s.attributeData.color,e,4,!0)]),s.attributeData.uvMapSpace&&t.push([w.UVMAPSPACE,new L(s.attributeData.uvMapSpace,s.indices,4,!0)]),s.attributeData.boundingRect&&t.push([w.BOUNDINGRECT,new L(s.attributeData.boundingRect,s.indices,9,!0)]),new tt(s.material,t,s.mapPositions,et.Mesh,s.attributeData.objectAndLayerIdColor)}function We(s,t=null){const e=[[w.POSITION,new L(s.attributeData.position,s.indices,3,!0)],[w.UV0,new L(s.attributeData.uv0,s.indices,2,!0)]];return new tt(s.material,e,s.mapPositions,et.Mesh,t)}function Pe(s){switch(s.type){case"extent":if(s instanceof Bt)return Tt.fromExtent(s);break;case"polygon":return s}return null}let qe=class{constructor(t,e,a){this.renderData=t,this.layerViewUid=e,this.graphicUid=a,this.outGeometries=new Array}};function Oe(s,t,e,a){const n=It(s.rings,!!s.hasZ&&a.mode!=="on-the-ground",At.CCW_IS_HOLE,s.spatialReference),o=V(n.position.length),i=Vt(n.position,s.spatialReference,0,o,0,n.position,0,n.position.length/3,t,e,a),l=i!=null;return new Ee(n.position,o,Mt(n.polygons,n.position,o),vt(n.outlines,n.position,o),l,i)}function Xe(s,t){const e=It(s.rings,!1,At.CCW_IS_HOLE),a=Nt(e.position,s.spatialReference,0,e.position,t,0);for(let n=2;n<e.position.length;n+=3)e.position[n]=Gt;return{position:e.position,polygons:Mt(e.polygons,e.position),outlines:vt(e.outlines,e.position),projectionSuccess:a}}function vt(s,t,e=null){return s.filter((({count:a})=>a>1)).map((({index:a,count:n})=>{const o=3*a,i=3*n;return e!=null?new $t(a,n,N(t,o,i),N(e,o,i)):new nt(a,n,N(t,o,i))}))}function Mt(s,t,e=null){const a=new Array;for(const{index:n,count:o,holeIndices:i,pathLengths:l}of s){if(o<=1)continue;const c=3*n,m=3*o,f=i.map((g=>g-n)),d=e!=null?new we(n,o,N(t,3*n,3*o),N(e,c,m),f,l):new Ce(n,o,N(t,3*n,3*o),f,l);a.push(d)}return a}class nt{constructor(t,e,a){this.index=t,this.count=e,this.position=a}}class $t extends nt{constructor(t,e,a,n){super(t,e,a),this.mapPositions=n}}class we extends $t{constructor(t,e,a,n,o,i){super(t,e,a,n),this.holeIndices=o,this.pathLengths=i}}class Ce extends nt{constructor(t,e,a,n,o){super(t,e,a),this.holeIndices=n,this.pathLengths=o}}class Ee{constructor(t,e,a,n,o,i){this.position=t,this.mapPositions=e,this.polygons=a,this.outlines=n,this.projectionSuccess=o,this.sampledElevation=i}}const Ie=["polygon","extent"];class Qe extends jt{constructor(t,e,a,n){super(t,e,a,n,Re(e)),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const g=Ft(this._getSymbolSize());if(g)throw new kt("graphics3dextrudesymbollayer:invalid-size",g)}const t=this.symbolLayer,e=t==null?void 0:t.material,a=e==null?void 0:e.color,n=this._getCombinedOpacityAndColor(a),o=Ht(n),i=n[3],l=this.needsDrivenTransparentPass,c=e==null?void 0:e.emissive,m={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:o,ambient:o,opacity:i,drivenOpacity:l,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:(c==null?void 0:c.strength)??0,emissiveSource:qt.Color,offsetTransparentBackfaces:!0,normalType:Wt.Compressed},f=new lt(m,this._context);f.setParameters({cullFace:f.transparent?Q.None:Q.Back});const d=new lt({...m,cullFace:Q.Back},this._context);this._materials[$.Main]=f,this._materials[$.Bottom]=d}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Ie,this.symbolLayer.type))return null;const a=this._getVertexOpacityAndColor(t.renderingInfo,this._getFallbackOpacityAndColor(),255),n=this.setGraphicElevationContext(e);return this._createAs3DShape(e,t.renderingInfo,a,n,e.uid)}layerOpacityChanged(t,e){var i,l,c,m;const a=(l=(i=this.symbolLayer)==null?void 0:i.material)==null?void 0:l.color,n=this._getCombinedOpacity(a);(c=this._materials[$.Main])==null||c.setParameters({opacity:n}),(m=this._materials[$.Bottom])==null||m.setParameters({opacity:n});const o=this._getLayerOpacity();t==null||t.forEach((f=>{var d;return(d=e(f))==null?void 0:d.layerOpacityChanged(o,this._context.isAsync)}))}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,ut)}slicePlaneEnabledChanged(t,e){var a,n;return(a=this._materials[$.Main])==null||a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(n=this._materials[$.Bottom])==null||n.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t==null||t.forEach((o=>{const i=e(o);i!=null&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){var e,a;const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return(e=this._materials[$.Main])==null||e.setParameters(t),(a=this._materials[$.Bottom])==null||a.setParameters(t),!0}_getExtrusionSize(t){let e;return e=t.size&&this._drivenProperties.size?xe(t.size,2)??0:this._getSymbolSize(),e/=this._context.renderCoordsHelper.unitInMeters,e}applyRendererDiff(t,e){return this._drivenPropertiesChanged(e)?ht.RecreateSymbol:ht.RecreateGraphics}async queryForSnapping(t,e,a,n){const o=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/Zt(e),{objectId:i,target:l}=t,c=Y(l);switch(c.z=(c.z??0)+o,t.type){case"edge":{const{start:m,end:f}=t,d=Y(m),g=Y(f);return d.z=(d.z??0)+o,g.z=(g.z??0)+o,[mt(i,c,1/0,d,g)]}case"vertex":return[_e(i,c,1/0),mt(i,l,1/0,l,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,e,a,n,o){const i=Pe(t.geometry);if(i==null)return null;if(i.rings.length===0||!i.rings.some((A=>A.length>0)))return this._logGeometryValidationWarnings(i.rings,"rings","ExtrudeSymbol3DLayer"),null;const l=Oe(i,this._context.elevationProvider,this._context.renderCoordsHelper,n);this._logGeometryCreationWarnings(l,i.rings,"rings","ExtrudeSymbol3DLayer");const c=Xt(i);if(c==null)return null;const m=new Array,f=new Array,d=Qt(),g=K(),E=I(),u=this._context.renderCoordsHelper.viewingMode===Yt.Global;u||this._context.renderCoordsHelper.worldUpAtPosition(null,E),Jt(i.spatialReference,[c.x,c.y,0],g,this._context.renderCoordsHelper.spatialReference);const b=K();Kt(b,g);const y=ee();te(y,b);const{polygons:x,mapPositions:p,position:_}=l,h=new Map,P=this._materials[$.Main];for(const A of x){const D=A.count;if(this._context.clippingExtent&&(se(A.mapPositions,d),!ne(d,this._context.clippingExtent)))continue;const z=wt(A.mapPositions,A.holeIndices,3);if(z.length===0)continue;const B=z.length,R=6*D,T=pt(R+B),q=pt(B),F=V(3*R),at=V(3*R),ot=V(3*R),it=V(R);Ae(_,p,z,A,F,ot,at,it,T,q,this._getExtrusionSize(e),E,u),ae(F,F,b);const rt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerViewUid:this._context.layerViewUid}),Z=new Ue(F,ot,oe(at),it),X=ft(P,T,T.length-q.length,Z,a,rt),Lt=D,Dt=D,zt=2*A.count,ct=new Ve(Lt,Dt,zt,B/3);Rt(X,ct,g),h.set(X,ct),m.push(X,ft(this._materials[$.Bottom],q,0,Z,a,rt)),f.push(Z.heights)}if(m.length===0)return null;const r=new ie({geometries:m,layerViewUid:this._context.layerViewUid,graphicUid:o,isElevationSource:!0});r.transformation=g;const S=re(this.symbolLayer,{opacity:this._getLayerOpacity()}),O=S?new ce(this._materials[$.Main],S,this._context.slicePlaneEnabled):null,v=new le(this,r,null,((A,D,z,B,R)=>$e(A,D,z,B,R,f,h)),n,O);return v.alignedSampledElevation=l.sampledElevation,v.needsElevationUpdates=ut(n.mode),v}_getFallbackOpacityAndColor(){var e,a;const t=(a=(e=this.symbolLayer)==null?void 0:e.material)==null?void 0:a.color;return ue.toUnitRGBA(t)??he}}function ft(s,t,e,a,n,o){const i=Ct(t.length),l=[[w.POSITION,new L(a.positions,t,3,!0)],[w.NORMALCOMPRESSED,new L(a.normals,t,2,!0)],[w.COLOR,new L(n,i,4,!0)]];return new tt(s,l,a.elevation,et.Mesh,o,e)}function Ae(s,t,e,a,n,o,i,l,c,m,f,d,g){const E=e.length/3;let u=2*a.count;ve(s,t,a.index,a.count,e,0,E,n,o,i,l,c,m,u,f,d,g);let b=0,y=2*a.count;u=0;const x=a.pathLengths[0];yt(n,o,l,i,b,x,a.count,y,c,u,f),y+=4*x,u+=2*x,b+=x;for(let p=1;p<a.pathLengths.length;++p){const _=a.pathLengths[p];yt(n,o,l,i,b,_,a.count,y,c,u,f),y+=4*_,u+=2*_,b+=_}}function ve(s,t,e,a,n,o,i,l,c,m,f,d,g,E,u,b,y){be(M,b),c??(c=[]),m??(m=[]),f??(f=[]);const x=u>0?1:-1;let p=3*e,_=0,h=3*_,P=a,r=3*P;for(let v=0;v<a;++v){const A=s[p],D=s[p+1],z=s[p+2];y&&(M[0]=A,M[1]=D,M[2]=z,st(M,M)),l[h+0]=A,l[h+1]=D,l[h+2]=z;const B=t[p+0],R=t[p+1],T=t[p+2];c[h+0]=B,c[h+1]=R,c[h+2]=T,m[h+0]=-x*M[0],m[h+1]=-x*M[1],m[h+2]=-x*M[2],f[_]=0,l[r+0]=A+u*M[0],l[r+1]=D+u*M[1],l[r+2]=z+u*M[2],c[r+0]=B,c[r+1]=R,c[r+2]=T,f[P]=u,h+=3,r+=3,p+=3,_+=1,P+=1}p=3*o,h=0,r=3*E;const S=u<0?Ot:Pt,O=u<0?Pt:Ot;for(let v=0;v<i;++v)g[h]=n[p+S[0]],g[h+1]=n[p+S[1]],g[h+2]=n[p+S[2]],d[r]=n[p+O[0]]+a,d[r+1]=n[p+O[1]]+a,d[r+2]=n[p+O[2]]+a,h+=3,r+=3,p+=3}function k(s,t,e,a,n,o,i){a[o]=a[i],i*=3,s[o*=3]=s[i],s[o+1]=s[i+1],s[o+2]=s[i+2],t[o]=t[i],t[o+1]=t[i+1],t[o+2]=t[i+2],e[o]=n[0],e[o+1]=n[1],e[o+2]=n[2]}const j=I();function yt(s,t,e,a,n,o,i,l,c,m,f){t??(t=[]),e??(e=[]),a??(a=[]);let d=n,g=n+1,E=n+i,u=n+i+1,b=l,y=l+1,x=l+2*o,p=l+2*o+1;f<0&&(d=n+i+1,u=n);let _=3*m;for(let h=0;h<o;++h)h===o-1&&(g=n,f>0?u=n+i:d=n+i),Me(s,d,g,E,j),k(s,t,a,e,j,b,d),k(s,t,a,e,j,y,g),k(s,t,a,e,j,x,E),k(s,t,a,e,j,p,u),c[_]=b,c[_+1]=x,c[_+2]=p,c[_+3]=b,c[_+4]=p,c[_+5]=y,_+=6,d++,g++,E++,u++,b+=2,y+=2,x+=2,p+=2}const J=I(),bt=I(),_t=I(),xt=I(),St=I();function Me(s,t,e,a,n){t*=3,e*=3,a*=3,G(J,s[t++],s[t++],s[t++]),G(bt,s[e++],s[e++],s[e++]),G(_t,s[a++],s[a++],s[a++]),gt(xt,bt,J),gt(St,_t,J),Et(n,St,xt),st(n,n)}const U=I();function $e(s,t,e,a,n,o,i){const l=s.stageObject,c=l.geometries,m=c.length,f=t.mode!=="absolute-height";let d=0;const g=l.transformation,E=de(K(),g);for(let u=0;u<m;u+=2){const b=c[u];if(!ge(b))continue;const y=b.getMutableAttribute(w.POSITION).data,x=o[u/2],p=new me(b.mapPositions),_=y.length/3;let h=!1,P=0;{let r=0;for(let S=0;S<_;S++){U[0]=y[r],U[1]=y[r+1],U[2]=y[r+2],a(p,H),f&&(P+=H.sampledElevation),ye.TESTS_DISABLE_OPTIMIZATIONS?(G(C,p.array[p.offset],p.array[p.offset+1],H.z+x[r/3]),e!=null&&n.toRenderCoords(C,e,C),W(C,C,E)):(G(C,y[r],y[r+1],y[r+2]),W(C,C,g),n.setAltitude(C,H.z+x[r/3]),W(C,C,E)),y[r]=C[0],y[r+1]=C[1],y[r+2]=C[2];const O=Le/n.unitInMeters;(Math.abs(U[0]-y[r])>=O||Math.abs(U[1]-y[r+1])>=O||Math.abs(U[2]-y[r+2])>=O)&&(h=!0),p.offset+=3,r+=3}}if(h){const r=i.get(b);r&&Rt(b,r,g),l.geometryVertexAttributeUpdated(c[u],w.NORMALCOMPRESSED),b.invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(c[u],w.POSITION),c[u+1].invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(c[u+1],w.POSITION)}d+=P/_}return d/m}function Rt(s,t,e){const a=s.getMutableAttribute(w.POSITION),n=s.getMutableAttribute(w.NORMALCOMPRESSED).data,{topVertexStart:o,topVertexCount:i,topFaceStart:l,topFaceCount:c}=t,m=a.data,f=i,d=s.attributes.get(w.POSITION).indices,g=l+c,E=o+i,u=V(3*f);for(let h=0;h<f;++h){const P=3*h;u[P+0]=0,u[P+1]=0,u[P+2]=0}const b=De,y=ze,x=Be,p=Te,_=M;for(let h=l;h<g;++h){const P=3*h;for(let r=0;r<3;++r){const S=d[P+r];p[r]=S;const O=3*S;G(C,m[O+0],m[O+1],m[O+2]),W(b[r],C,e)}dt(y,b[1],b[0]),dt(x,b[2],b[0]),Et(_,y,x),st(_,_);for(let r=0;r<3;++r){const S=3*(p[r]-o);u[S+0]+=_[0],u[S+1]+=_[1],u[S+2]+=_[2]}}for(let h=o;h<E;++h){const P=3*(h-o),r=u[P+0],S=u[P+1],O=u[P+2],v=Math.sqrt(r*r+S*S+O*O);pe(n,h,r/v,S/v,O/v)}}function Re(s){var t,e;return(((e=(t=s.material)==null?void 0:t.color)==null?void 0:e.a)??1)===1}const C=I(),M=I(),H=new fe,Pt=[0,2,1],Ot=[0,1,2],Le=.01,De=[I(),I(),I()],ze=I(),Be=I(),Te=[0,0,0];var $;(function(s){s[s.Main=0]="Main",s[s.Bottom=1]="Bottom"})($||($={}));class Ue{constructor(t,e,a,n){this.positions=t,this.elevation=e,this.normals=a,this.heights=n}}class Ve{constructor(t,e,a,n){this.topVertexStart=t,this.topVertexCount=e,this.topFaceStart=a,this.topFaceCount=n}}export{We as a,Pe as b,Xe as c,qe as g,ke as l,He as m,Ae as n,Oe as p,Qe as s};
