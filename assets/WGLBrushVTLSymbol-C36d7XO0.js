import{uQ as ee,kY as te,cw as k,uR as w,pt as O,l6 as N,E as ae,l4 as ie,o as ne,uS as H,l1 as Y,uT as G,l3 as b,cb as re,uU as A,uV as q,bF as B,ca as se,uW as Q}from"./index-BdmtnMtL.js";let F=class{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(i,t){}draw(i,t,e){}drawMany(i,t,e){for(const n of t)n.visible&&this.draw(i,n,e)}},pe=class extends F{constructor(){super(...arguments),this._color=ee(1,0,0,1),this._patternMatrix=te(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(i,t){const{context:e,painter:n,requestRender:l,allowDelayedRender:_}=i;this._loadWGLResources(i);const f=i.displayLevel,s=i.styleLayer,h=s.backgroundMaterial,d=n.vectorTilesMaterialManager,P=s.getPaintValue("background-color",f),p=s.getPaintValue("background-opacity",f),S=s.getPaintValue("background-pattern",f),y=S!==void 0,v=1|window.devicePixelRatio,M=i.spriteMosaic;let x,E;const u=v>H?2:1,m=this._programOptions;m.pattern=y;const r=d.getMaterialProgram(e,h,m);if(!_||l==null||r.compiled){if(e.bindVAO(this._vao),e.useProgram(r),y){const a=M.getMosaicItemPosition(S,!0);if(a!=null){const{tl:c,br:g,page:o}=a;x=g[0]-c[0],E=g[1]-c[1];const T=M.getPageSize(o);T!=null&&(M.bind(e,k.LINEAR,o,w),r.setUniform4f("u_tlbr",c[0],c[1],g[0],g[1]),r.setUniform2fv("u_mosaicSize",T),r.setUniform1i("u_texture",w))}r.setUniform1f("u_opacity",p)}else{const a=P[3]*p;this._color[0]=a*P[0],this._color[1]=a*P[1],this._color[2]=a*P[2],this._color[3]=a,r.setUniform4fv("u_color",this._color)}r.setUniform1f("u_depth",s.z||0);for(const a of t){if(r.setUniform1f("u_coord_range",a.rangeX),r.setUniformMatrix3fv("u_dvsMat3",a.transforms.displayViewScreenMat3),y){const c=Math.max(2**(Math.round(f)-a.key.level),1),g=u*a.width*c,o=g/Y(x),T=g/Y(E);this._patternMatrix[0]=o,this._patternMatrix[4]=T,r.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}e.setStencilFunction(O.EQUAL,0,255),e.drawArrays(N.TRIANGLE_STRIP,0,4)}}else l()}_loadWGLResources(i){if(this._vao)return;const{context:t,styleLayer:e}=i,n=e.backgroundMaterial,l=new Int8Array([0,0,1,0,0,1,1,1]),_=ae.createVertex(t,ie.STATIC_DRAW,l),f=new ne(t,n.getAttributeLocations(),n.getLayoutInfo(),new Map([["geometry",_]]));this._vao=f}};class me extends F{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(i,t){const{context:e,displayLevel:n,requiredLevel:l,state:_,painter:f,spriteMosaic:s,styleLayerUID:h,requestRender:d,allowDelayedRender:P}=i;if(!t.some((r=>{var a;return((a=r.layerData.get(h))==null?void 0:a.circleIndexCount)??!1})))return;const p=i.styleLayer,S=p.circleMaterial,y=f.vectorTilesMaterialManager,v=1.2,M=p.getPaintValue("circle-translate",n),x=p.getPaintValue("circle-translate-anchor",n),E=this._programOptions,u=y.getMaterialProgram(e,S,E);if(P&&d!=null&&!u.compiled)return void d();e.useProgram(u),u.setUniformMatrix3fv("u_displayMat3",x===G.VIEWPORT?_.displayMat3:_.displayViewMat3),u.setUniform2fv("u_circleTranslation",M),u.setUniform1f("u_depth",p.z),u.setUniform1f("u_antialiasingWidth",v);let m=-1;for(const r of t){if(!r.layerData.has(h))continue;r.key.level!==m&&(m=r.key.level,S.setDataUniforms(u,n,p,m,s));const a=r.layerData.get(h);if(!a.circleIndexCount)continue;a.prepareForRendering(e);const c=a.vao;c!=null&&(e.bindVAO(c),u.setUniformMatrix3fv("u_dvsMat3",r.transforms.displayViewScreenMat3),l!==r.key.level?e.setStencilFunction(O.EQUAL,r.stencilRef,255):e.setStencilFunction(O.GREATER,255,255),e.drawElements(N.TRIANGLES,a.circleIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.circleIndexStart),r.triangleCount+=a.circleIndexCount/3)}}}const X=1/65536;class ye extends F{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(i,t){const{displayLevel:e,renderPass:n,spriteMosaic:l,styleLayerUID:_}=i;let f=!1;for(const u of t)if(u.layerData.has(_)){const m=u.layerData.get(_);if(m.fillIndexCount>0||m.outlineIndexCount>0){f=!0;break}}if(!f)return;const s=i.styleLayer,h=s.getPaintProperty("fill-pattern"),d=h!==void 0,P=d&&h.isDataDriven;let p;if(d&&!P){const u=h.getValue(e);p=l.getMosaicItemPosition(u,!0)}const S=!d&&s.getPaintValue("fill-antialias",e);let y=!0,v=1;if(!d){const u=s.getPaintProperty("fill-color"),m=s.getPaintProperty("fill-opacity");if(!(u!=null&&u.isDataDriven)&&!(m!=null&&m.isDataDriven)){const r=s.getPaintValue("fill-color",e);v=s.getPaintValue("fill-opacity",e)*r[3],v>=1&&(y=!1)}}if(y&&n==="opaque")return;const M=s.getPaintValue("fill-translate",e),x=s.getPaintValue("fill-translate-anchor",e);(y||n!=="translucent")&&this._drawFill(i,_,s,t,M,x,d,p,P);const E=!s.hasDataDrivenOutlineColor&&s.outlineUsesFillColor&&v<1;S&&n!=="opaque"&&!E&&this._drawOutline(i,_,s,t,M,x)}_drawFill(i,t,e,n,l,_,f,s,h){if(f&&!h&&s==null)return;const{context:d,displayLevel:P,state:p,painter:S,pixelRatio:y,spriteMosaic:v,requestRender:M,allowDelayedRender:x}=i,E=e.fillMaterial,u=S.vectorTilesMaterialManager,m=y>H?2:1,r=this._fillProgramOptions;r.pattern=f;const a=u.getMaterialProgram(d,E,r);if(x&&M!=null&&!a.compiled)return void M();if(d.useProgram(a),s!=null){const{page:g}=s,o=v.getPageSize(g);o!=null&&(v.bind(d,k.LINEAR,g,w),a.setUniform2fv("u_mosaicSize",o),a.setUniform1i("u_texture",w))}a.setUniformMatrix3fv("u_displayMat3",_===G.VIEWPORT?p.displayMat3:p.displayViewMat3),a.setUniform2fv("u_fillTranslation",l),a.setUniform1f("u_depth",e.z+X);let c=-1;for(const g of n){if(!g.layerData.has(t))continue;g.key.level!==c&&(c=g.key.level,E.setDataUniforms(a,P,e,c,v));const o=g.layerData.get(t);if(!o.fillIndexCount)continue;o.prepareForRendering(d);const T=o.fillVAO;if(T!=null){if(d.bindVAO(T),a.setUniformMatrix3fv("u_dvsMat3",g.transforms.displayViewScreenMat3),d.setStencilFunction(O.EQUAL,g.stencilRef,255),f){const U=Math.max(2**(Math.round(P)-g.key.level),1),R=g.rangeX/(m*g.width*U);a.setUniform1f("u_patternFactor",R)}if(h){const U=o.patternMap;if(!U)continue;for(const[R,D]of U){const z=v.getPageSize(R);z!=null&&(v.bind(d,k.LINEAR,R,w),a.setUniform2fv("u_mosaicSize",z),a.setUniform1i("u_texture",w),d.drawElements(N.TRIANGLES,D[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*D[0]))}}else d.drawElements(N.TRIANGLES,o.fillIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*o.fillIndexStart);g.triangleCount+=o.fillIndexCount/3}}}_drawOutline(i,t,e,n,l,_){const{context:f,displayLevel:s,state:h,painter:d,pixelRatio:P,spriteMosaic:p,requestRender:S,allowDelayedRender:y}=i,v=e.outlineMaterial,M=d.vectorTilesMaterialManager,x=.75/P,E=this._outlineProgramOptions,u=M.getMaterialProgram(f,v,E);if(y&&S!=null&&!u.compiled)return void S();f.useProgram(u),u.setUniformMatrix3fv("u_displayMat3",_===G.VIEWPORT?h.displayMat3:h.displayViewMat3),u.setUniform2fv("u_fillTranslation",l),u.setUniform1f("u_depth",e.z+X),u.setUniform1f("u_outline_width",x);let m=-1;for(const r of n){if(!r.layerData.has(t))continue;r.key.level!==m&&(m=r.key.level,v.setDataUniforms(u,s,e,m,p));const a=r.layerData.get(t);if(a.prepareForRendering(f),!a.outlineIndexCount)continue;const c=a.outlineVAO;c!=null&&(f.bindVAO(c),u.setUniformMatrix3fv("u_dvsMat3",r.transforms.displayViewScreenMat3),f.setStencilFunction(O.EQUAL,r.stencilRef,255),f.drawElements(N.TRIANGLES,a.outlineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.outlineIndexStart),r.triangleCount+=a.outlineIndexCount/3)}}}class _e extends F{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(i,t){const{context:e,displayLevel:n,state:l,painter:_,pixelRatio:f,spriteMosaic:s,styleLayerUID:h,requestRender:d,allowDelayedRender:P}=i;if(!t.some((U=>{var R;return((R=U.layerData.get(h))==null?void 0:R.lineIndexCount)??!1})))return;const p=i.styleLayer,S=p.lineMaterial,y=_.vectorTilesMaterialManager,v=p.getPaintValue("line-translate",n),M=p.getPaintValue("line-translate-anchor",n),x=p.getPaintProperty("line-pattern"),E=x!==void 0,u=E&&x.isDataDriven;let m,r;if(E&&!u){const U=x.getValue(n);m=s.getMosaicItemPosition(U)}let a=!1;if(!E){const U=p.getPaintProperty("line-dasharray");if(r=U!==void 0,a=r&&U.isDataDriven,r&&!a){const R=U.getValue(n),D=p.getDashKey(R,p.getLayoutValue("line-cap",n));m=s.getMosaicItemPosition(D)}}const c=1/f,g=this._programOptions;g.pattern=E,g.sdf=r;const o=y.getMaterialProgram(e,S,g);if(P&&d!=null&&!o.compiled)return void d();if(e.useProgram(o),o.setUniformMatrix3fv("u_displayViewMat3",l.displayViewMat3),o.setUniformMatrix3fv("u_displayMat3",M===G.VIEWPORT?l.displayMat3:l.displayViewMat3),o.setUniform2fv("u_lineTranslation",v),o.setUniform1f("u_depth",p.z),o.setUniform1f("u_antialiasing",c),m&&m!=null){const{page:U}=m,R=s.getPageSize(U);R!=null&&(s.bind(e,k.LINEAR,U,w),o.setUniform2fv("u_mosaicSize",R),o.setUniform1i("u_texture",w))}let T=-1;for(const U of t){if(!U.layerData.has(h))continue;U.key.level!==T&&(T=U.key.level,S.setDataUniforms(o,n,p,T,s));const R=2**(n-T)/f;o.setUniform1f("u_zoomFactor",R);const D=U.layerData.get(h);if(!D.lineIndexCount)continue;D.prepareForRendering(e);const z=D.vao;if(z!=null){if(e.bindVAO(z),o.setUniformMatrix3fv("u_dvsMat3",U.transforms.displayViewScreenMat3),e.setStencilFunction(O.EQUAL,U.stencilRef,255),u||a){const W=D.patternMap;if(!W)continue;for(const[I,C]of W){const L=s.getPageSize(I);L!=null&&(s.bind(e,k.LINEAR,I,w),o.setUniform2fv("u_mosaicSize",L),o.setUniform1i("u_texture",w),e.drawElements(N.TRIANGLES,C[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*C[0]))}}else e.drawElements(N.TRIANGLES,D.lineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*D.lineIndexStart);U.triangleCount+=D.lineIndexCount/3}}}}const oe=256/360,le=1/Math.LN2;function ue(V,i){return(V%=i)>=0?V:V+i}function j(V){return ue(V*oe,256)}function Me(V){return Math.log(V)*le}const ce=1/65536;class Ue extends F{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=re()}dispose(){}drawMany(i,t){const e=i.styleLayer;this._drawIcons(i,e,t),this._drawText(i,e,t)}_drawIcons(i,t,e){const{context:n,displayLevel:l,painter:_,spriteMosaic:f,state:s,styleLayerUID:h,requestRender:d,allowDelayedRender:P}=i,p=t.iconMaterial,S=_.vectorTilesMaterialManager;let y,v=!1;for(const o of e)if(o.layerData.has(h)&&(y=o.layerData.get(h),y.iconPerPageElementsMap.size>0)){v=!0;break}if(!v)return;const M=t.getPaintValue("icon-translate",l),x=t.getPaintValue("icon-translate-anchor",l);let E=t.getLayoutValue("icon-rotation-alignment",l);E===A.AUTO&&(E=t.getLayoutValue("symbol-placement",l)===q.POINT?A.VIEWPORT:A.MAP);const u=E===A.MAP,m=t.getLayoutValue("icon-keep-upright",l)&&u,r=y.isIconSDF,a=this._iconProgramOptions;a.sdf=r;const c=S.getMaterialProgram(n,p,a);if(P&&d!=null&&!c.compiled)return void d();n.useProgram(c),c.setUniformMatrix3fv("u_displayViewMat3",E===A.MAP?s.displayViewMat3:s.displayMat3),c.setUniformMatrix3fv("u_displayMat3",x===G.VIEWPORT?s.displayMat3:s.displayViewMat3),c.setUniform2fv("u_iconTranslation",M),c.setUniform1f("u_depth",t.z),c.setUniform1f("u_mapRotation",j(s.rotation)),c.setUniform1f("u_keepUpright",m?1:0),c.setUniform1f("u_level",10*l),c.setUniform1i("u_texture",w),c.setUniform1f("u_fadeDuration",B/1e3);let g=-1;for(const o of e){if(!o.layerData.has(h)||(o.key.level!==g&&(g=o.key.level,p.setDataUniforms(c,l,t,g,f)),y=o.layerData.get(h),y.iconPerPageElementsMap.size===0))continue;y.prepareForRendering(n),y.updateOpacityInfo();const T=y.iconVAO;if(T!=null){n.bindVAO(T),c.setUniformMatrix3fv("u_dvsMat3",o.transforms.displayViewScreenMat3),c.setUniform1f("u_time",(performance.now()-y.lastOpacityUpdate)/1e3);for(const[U,R]of y.iconPerPageElementsMap)this._renderIconRange(i,c,R,U,o)}}}_renderIconRange(i,t,e,n,l){const{context:_,spriteMosaic:f}=i;this._spritesTextureSize[0]=f.getWidth(n)/4,this._spritesTextureSize[1]=f.getHeight(n)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),f.bind(_,k.LINEAR,n,w),this._setStencilState(i,l),_.drawElements(N.TRIANGLES,e[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),l.triangleCount+=e[1]/3}_drawText(i,t,e){const{context:n,displayLevel:l,glyphMosaic:_,painter:f,pixelRatio:s,spriteMosaic:h,state:d,styleLayerUID:P,requestRender:p,allowDelayedRender:S}=i,y=t.textMaterial,v=f.vectorTilesMaterialManager;let M,x=!1;for(const L of e)if(L.layerData.has(P)&&(M=L.layerData.get(P),M.glyphPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const E=t.getPaintProperty("text-opacity");if(E&&!E.isDataDriven&&E.getValue(l)===0)return;const u=t.getPaintProperty("text-color"),m=!u||u.isDataDriven||u.getValue(l)[3]>0,r=t.getPaintProperty("text-halo-width"),a=t.getPaintProperty("text-halo-color"),c=(!r||r.isDataDriven||r.getValue(l)>0)&&(!a||a.isDataDriven||a.getValue(l)[3]>0);if(!m&&!c)return;const g=24/8;let o=t.getLayoutValue("text-rotation-alignment",l);o===A.AUTO&&(o=t.getLayoutValue("symbol-placement",l)===q.POINT?A.VIEWPORT:A.MAP);const T=o===A.MAP,U=t.getLayoutValue("text-keep-upright",l)&&T,R=.8*g/s;this._glyphTextureSize||(this._glyphTextureSize=se(_.width/4,_.height/4));const D=t.getPaintValue("text-translate",l),z=t.getPaintValue("text-translate-anchor",l),W=this._sdfProgramOptions,I=v.getMaterialProgram(n,y,W);if(S&&p!=null&&!I.compiled)return void p();n.useProgram(I),I.setUniformMatrix3fv("u_displayViewMat3",o===A.MAP?d.displayViewMat3:d.displayMat3),I.setUniformMatrix3fv("u_displayMat3",z===G.VIEWPORT?d.displayMat3:d.displayViewMat3),I.setUniform2fv("u_textTranslation",D),I.setUniform1f("u_depth",t.z+ce),I.setUniform2fv("u_mosaicSize",this._glyphTextureSize),I.setUniform1f("u_mapRotation",j(d.rotation)),I.setUniform1f("u_keepUpright",U?1:0),I.setUniform1f("u_level",10*l),I.setUniform1i("u_texture",Q),I.setUniform1f("u_antialiasingWidth",R),I.setUniform1f("u_fadeDuration",B/1e3);let C=-1;for(const L of e){if(!L.layerData.has(P)||(L.key.level!==C&&(C=L.key.level,y.setDataUniforms(I,l,t,C,h)),M=L.layerData.get(P),M.glyphPerPageElementsMap.size===0))continue;M.prepareForRendering(n),M.updateOpacityInfo();const $=M.textVAO;if($==null)continue;n.bindVAO($),I.setUniformMatrix3fv("u_dvsMat3",L.transforms.displayViewScreenMat3),this._setStencilState(i,L);const K=(performance.now()-M.lastOpacityUpdate)/1e3;I.setUniform1f("u_time",K),M.glyphPerPageElementsMap.forEach(((Z,J)=>{this._renderGlyphRange(n,Z,J,_,I,c,m,L)}))}}_renderGlyphRange(i,t,e,n,l,_,f,s){n.bind(i,k.LINEAR,e,Q),_&&(l.setUniform1f("u_halo",1),i.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),s.triangleCount+=t[1]/3),f&&(l.setUniform1f("u_halo",0),i.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),s.triangleCount+=t[1]/3)}_setStencilState(i,t){const{context:e,is3D:n,stencilSymbols:l}=i;if(e.setStencilTestEnabled(!0),l)return e.setStencilWriteMask(255),void e.setStencilFunction(O.ALWAYS,t.stencilRef,255);e.setStencilWriteMask(0),n?e.setStencilFunction(O.EQUAL,t.stencilRef,255):e.setStencilFunction(O.GREATER,255,255)}}export{Ue as d,Me as e,ye as f,me as n,_e as s,F as t,pe as u};
