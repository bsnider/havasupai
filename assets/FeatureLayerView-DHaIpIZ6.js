import{lH as S,r as o,m as u,lI as $,eO as N,d as D,ap as U,dz as b,av as Q,lJ as V,aC as q,dR as W,lK as j,bW as g,lL as G,au as C,dS as v,lM as _,lN as H,lO as O,lP as A,lQ as B,lR as f,lS as J,lT as M,lU as h,cZ as z,cJ as L}from"./index-BdmtnMtL.js";import{e as Z}from"./FeatureIdInfo-iL5WjyEH.js";import{E as K}from"./constants-B4mRqufT.js";import{s as X,r as Y}from"./featurePopupQueryUtils-CSNfJ58c.js";import{o as T}from"./floorFilterUtils-MtPgm5NF.js";import{e as ee}from"./featureServiceUtils-CWGpEJc6.js";import{n as k,p as P}from"./popupUtils-B6p4SpQd.js";class te{constructor(i){this._fieldsIndex=i,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some((i=>i.currentUserRequired))}}visitClientWhereClause(i){i&&this._clauses.push(S(i,this._fieldsIndex))}visitFeatureReduction(i){if(i)switch(i.type){case"binning":case"cluster":this.visitLabelingInfo(i.labelsVisible,i.labelingInfo)}}visitLabelingInfo(i,t){if(i&&t!=null)for(const e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(i,t){if(i)for(const e of(t==null?void 0:t.filters)??[])this.visitClientWhereClause(e.where)}visitFilter(i){this.visitClientWhereClause(i==null?void 0:i.where)}visitTrackInfo(i){i!=null&&(this.visitLabelingInfo(i==null?void 0:i.latestObservations.labelsVisible,i==null?void 0:i.latestObservations.labelingInfo),this.visitLabelingInfo(i==null?void 0:i.previousObservations.labelsVisible,i==null?void 0:i.previousObservations.labelingInfo),this.visitLabelingInfo(i==null?void 0:i.trackLines.labelsVisible,i==null?void 0:i.trackLines.labelingInfo))}}const ue=w=>{let i=class extends w{constructor(...t){super(...t),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([U((()=>{var l,s,a,p,r;const t=this.layer,e=this.view;return[t&&"elevationInfo"in t?(l=t.elevationInfo)==null?void 0:l.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,((s=e==null?void 0:e.requiredFieldsOptions)==null?void 0:s.featureTitleFields)&&t&&"featureTitleFields"in t&&t.featureTitleFields,((a=e==null?void 0:e.requiredFieldsOptions)==null?void 0:a.utilityNetworkFields)&&V(e,t),t.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,(t==null?void 0:t.type)==="knowledge-graph-sublayer"&&t.parentCompositeLayer.type==="link-chart"&&((r=(p=t.parentCompositeLayer.linkChart)==null?void 0:p.linkChartProperties.nonspatialDataDisplay)==null?void 0:r.mode),(t==null?void 0:t.type)==="parquet"&&t.popupTemplate]}),(()=>this._handleChange()),Q),b((()=>{var t;return(t=this.view)==null?void 0:t.floors}),"change",(()=>this._handleChange())),b((()=>{var t;return(t=this.layer.displayFilterInfo)==null?void 0:t.filters}),"change",(()=>this._handleChange())),b((()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null),"change",(()=>this._handleChange()))])}get availableFields(){if(!this.layer)return[];const{layer:t,layer:{fieldsIndex:e},requiredFields:l}=this;return"outFields"in t&&t.outFields?q(e,[...W(e,t.outFields),...l]):q(e,l)}get displayFilterEnabled(){var t,e;return(((t=this.view)==null?void 0:t.displayFilterEnabled)??!0)&&(!("displayFilterEnabled"in this.layer)||(((e=this.layer)==null?void 0:e.displayFilterEnabled)??!0))}get effectiveDisplayFilter(){const t=this.layer;return this.displayFilterEnabled&&t.displayFilterInfo?j(t.displayFilterInfo,this.view):null}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){g.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){var t;return(t=this.layer)!=null&&t.url?G(this.layer.url):Promise.resolve(null)}highlight(t,e){throw new Error("missing implementation")}createQuery(){var l;const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new C(t);return"floorInfo"in this.layer&&this.layer.floorInfo&&(e.where=v(e.where,T(this))),this.displayFilterEnabled&&(e.where=v(e.where,(l=this.effectiveDisplayFilter)==null?void 0:l.where)),this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new C(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(t,e){const l=await this._createPopupQuery(t.map((s=>{var a;return((a=s.origin)==null?void 0:a.layer)??s.layer})),e);return await X(this.layer,t,l,{getPopupTemplate:s=>s&&"popupEnabled"in s&&s.popupEnabled?P(s,e):null,hasRequiredFields:(s,a)=>this._popupFeatureHasRequiredFields(s,a),...e})}_handleChange(){const t=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then((()=>{}));return this._set("_updatingRequiredPromise",t),t.then((()=>{this._updatingRequiredPromise===t&&this._set("_updatingRequiredPromise",null)})),t}async _updateClientWhereClauseRequirements(){var l;if(!this.layer||!this.view)return;const{layer:t}=this,e=new te(t.fieldsIndex);if(e.visitFilter(this.filter),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction),"labelingInfo"in t&&e.visitLabelingInfo(t.labelsVisible,t.labelingInfo),"trackInfo"in t&&e.visitTrackInfo(t.trackInfo),this.view.type==="2d"&&(e.visitFilter((l=this.featureEffect)==null?void 0:l.filter),e.visitDisplayFilter(this.displayFilterEnabled,t.displayFilterInfo),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction)),t.type==="subtype-group")for(const s of t.sublayers)e.visitLabelingInfo(s.labelsVisible,s.labelingInfo);try{const s=await e.finish();this._set("requiresCurrentUser",s.requiresCurrentUser)}catch(s){g.getLogger(this).error(s)}}async _updateRequiredFields(){var c,m,E,x;if(!this.layer||!this.view)return;const t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:l}}=this,s="renderer"in e&&e.renderer,a="orderBy"in e&&e.orderBy,p="featureReduction"in e?e.featureReduction:null,r=new Set,d=[s?s.collectRequiredFields(r,l):null,_(r,e),t&&"elevationInfo"in e?H(r,e):null,this.filter!=null?O(r,e,this.filter):null,t||this.featureEffect==null?null:O(r,e,this.featureEffect.filter),!t&&p?A(r,e,p):null,!t&&a?B(r,e,a):null];if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&f(r,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"timeInfo"in e&&e.timeInfo&&"trackInfo"in e&&e.trackInfo){const{trackInfo:n}=e;f(r,e.fieldsIndex,[e.timeInfo.trackIdField]),e.type!=="feature"&&n.timeField!=="startTimeField"||f(r,e.fieldsIndex,[e.timeInfo.startField]),n.timeField==="endTimeField"&&f(r,e.fieldsIndex,[e.timeInfo.endField]),await J(r,e)}if("floorInfo"in e&&e.floorInfo&&f(r,e.fieldsIndex,[e.floorInfo.floorField]),"featureTitleFields"in e&&((m=(c=this.view)==null?void 0:c.requiredFieldsOptions)!=null&&m.featureTitleFields)&&e.featureTitleFields&&f(r,e.fieldsIndex,e.featureTitleFields),e.type==="feature"&&e.globalIdField&&((x=(E=this.view)==null?void 0:E.requiredFieldsOptions)!=null&&x.globalIdField)&&f(r,e.fieldsIndex,[e.globalIdField]),this.displayFilterEnabled&&d.push(M(r,e,e.displayFilterInfo)),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&g.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),f(r,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){h(r,l,e.subtypeField);const n=e.sublayers.map((F=>{var R;return Promise.all([(R=F.renderer)==null?void 0:R.collectRequiredFields(r,l),_(r,F)])}));d.push(Promise.all(n))}if(e.type==="catalog-footprint"&&e.parent){const n=e.parent;f(r,l,[n.itemNameField,n.itemSourceField,n.itemTypeField,n.maxScaleField,n.minScaleField])}e.type==="knowledge-graph-sublayer"&&e.parentCompositeLayer.type==="link-chart"&&h(r,l,K),e.type==="parquet"&&d.push(k(e,e.popupTemplate).then((n=>{for(const F of n)r.add(F)})));const y=await Promise.allSettled(d);if(t)h(r,l,e.objectIdField);else for(const n of Z(ee(e)))h(r,l,n);t&&"displayField"in e&&e.displayField&&h(r,l,e.displayField);for(const n of y)n.status==="rejected"&&g.getLogger(this).error(n.reason);const I=Array.from(r).sort();this._set("requiredFields",I)}_popupFeatureHasRequiredFields(t,e){return z(t,e)}async _createPopupQuery(t,e){const l=this.layer.createQuery(),s=new Set;let a=!1;const p=t??[this.layer];for(const r of p){if(!("popupEnabled"in r))continue;const d=P(r,e);if(d==null)continue;const y=await Y(d);L(e);const I=y&&y.arcadeUtils.hasGeometryOperations(d);a=!(this.layer.geometryType!=="point"&&!I);const c=await k(this.layer,d);L(e);for(const m of c)s.add(m)}return l.returnGeometry=a,l.returnZ=a,l.returnM=a,l.outFields=Array.from(s),l.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(l.where=v(l.where,T(this))),l}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return o([u()],i.prototype,"_updatingRequiredPromise",void 0),o([u({readOnly:!0})],i.prototype,"availableFields",null),o([u({readOnly:!0})],i.prototype,"displayFilterEnabled",null),o([u({readOnly:!0})],i.prototype,"effectiveDisplayFilter",null),o([u({type:$})],i.prototype,"featureEffect",null),o([u({type:N})],i.prototype,"filter",void 0),o([u()],i.prototype,"layer",void 0),o([u({type:Number})],i.prototype,"maximumNumberOfFeatures",null),o([u({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),o([u()],i.prototype,"requiresCurrentUser",void 0),o([u({readOnly:!0})],i.prototype,"requiredFields",void 0),o([u({readOnly:!0})],i.prototype,"signedInUser",null),o([u()],i.prototype,"suspended",void 0),o([u()],i.prototype,"view",void 0),i=o([D("esri.views.layers.FeatureLayerView")],i),i};export{ue as S};
