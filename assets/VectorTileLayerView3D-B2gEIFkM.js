import{gq as z,cJ as O,cm as A,sd as U,s3 as P,sT as G,sU as j,mb as F,s5 as p,bG as H,pt as W,ow as T,cp as k,bm as Z,sV as K,sW as Y,dm as J,ap as Q,av as X,dw as ee,el as te,u as B,r as g,m as y,d as le}from"./index-DXVHLZmj.js";import{p as ie,t as se}from"./TileInfoViewPOT-HJbFnep1.js";import{d as ae,u as ne,n as re,s as oe,f as he}from"./WGLBrushVTLSymbol-BrBgmZkI.js";import{p as ce}from"./VTLMaterialManager-C2K0a9mm.js";import{o as D}from"./StyleRepository-CzcATIEd.js";import{l as ue}from"./LayerView3D-CYJ7SBHi.js";import{p as de}from"./TiledLayerView3D-BwtNFrdu.js";import{u as ge}from"./LayerView-DESWoILy.js";import"./Rect-CUzevAry.js";import"./pbf-C72WgCEE.js";import"./rasterizingUtils-CA-FxWnb.js";import"./ShaderCompiler-C94JGjW7.js";import"./programUtils-CwiKxPbA.js";class me{constructor(e,t,s){this._scale=e,this._shift=t,this._levelShift=s}getLevelRowColumn(e){const t=this.getLevelShift(e[0]),s=this._shift+t;return s?[e[0]-t,e[1]>>s,e[2]>>s]:e}getLevelShift(e){return Math.min(e,this._levelShift)}getOffset(e,t){let s=0,i=0;const l=this._shift+this.getLevelShift(e[0]);if(l){const o=(1<<l)-1,a=t/(this._scale*(1<<l-1));s=(e[2]&o)*a,i=(e[1]&o)*a}return[s,i]}getScale(e){return this._scale*(1<<this._shift+this.getLevelShift(e))}}class V extends ie{constructor(e,t,s,i){super(e,t,s,e.tileInfo.lods.length-1),this._memCache=i,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new se(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t){const s=new z(e[0],e[1],e[2],0);let i=this._memCache.get(s.id);if(i)return i.retain(),i;const l=await this._getVectorTileData(s);if(O(t),!this._layer)return null;if(i=this._memCache.get(s.id),i)return i.retain(),i;const o=this._layer.tileInfo.getTileBounds(A(),s),a=this._tileInfoView.getTileResolution(e[0]);return i=new U(s,a,o[0],o[3],P,P,this._styleRepository,this._memCache),i.setData(l),l&&(i.retain(),this._memCache.put(s.id,i,G)),i.neededForCoverage=!0,i.transforms.tileUnitsToPixels=j(1/8,0,0,0,1/8,0,0,0,1),i}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const s=new AbortController,i={signal:s.signal},l=this._getParsedVectorTileData(e,i).then((o=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),o))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,l),this._ongoingRequestToController.set(t,s),l}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((s=>this.parseTileData({key:e,data:s},t)))}}const v={vtlBackground:ne,vtlFill:he,vtlLine:oe,vtlCircle:re,vtlSymbol:ae},f=1e-6;class q{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache={vtlBackground:null,vtlFill:null,vtlLine:null,vtlCircle:null,vtlSymbol:null},this._vtlMaterialManager=new ce}dispose(){var e,t,s,i,l;(e=this._brushCache.vtlBackground)==null||e.dispose(),(t=this._brushCache.vtlFill)==null||t.dispose(),(s=this._brushCache.vtlLine)==null||s.dispose(),(i=this._brushCache.vtlCircle)==null||i.dispose(),(l=this._brushCache.vtlSymbol)==null||l.dispose(),this._brushCache=null,this._vtlMaterialManager=F(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,s){const i=s.layers;e.renderPass="translucent";let l=this._brushCache.vtlSymbol;l==null&&(l=new v.vtlSymbol,this._brushCache.vtlSymbol=l),m[0]=t;for(let o=0;o<i.length;o++){const a=i[o];if(a.type!==p.SYMBOL)continue;const h=a.getLayoutProperty("visibility");if(h&&h.getValue()===H.NONE)continue;const n=e.displayLevel;a.minzoom!==void 0&&a.minzoom>n+f||a.maxzoom!==void 0&&a.maxzoom<=n-f||(e.styleLayerUID=a.uid,e.styleLayer=a,l.drawMany(e,m))}m[0]=null}drawBackground(e,t,s){if(s.backgroundBucketIds.length===0)return;const{context:i,displayLevel:l,requiredLevel:o}=e;t.key.level=o,i.setBlendingEnabled(!0),i.setDepthTestEnabled(!1),i.setStencilTestEnabled(!1),e.renderPass="background";let a=this._brushCache.vtlBackground;a==null&&(a=new v.vtlBackground,this._brushCache.vtlBackground=a),m[0]=t,s.backgroundBucketIds.forEach((h=>{const n=s.getLayerById(h);if(n.type!==p.BACKGROUND)return;const C=n.getLayoutProperty("visibility");C&&C.getValue()===H.NONE||n.minzoom!==void 0&&n.minzoom>l+f||n.maxzoom!==void 0&&n.maxzoom<=l-f||(e.styleLayerUID=n.uid,e.styleLayer=n,a.drawMany(e,m))})),m[0]=null}drawTile(e,t,s,i){const{context:l}=e,o=s.layers;l.setBlendingEnabled(!1),l.setDepthTestEnabled(!0),l.setDepthWriteEnabled(!0),l.setDepthFunction(W.LEQUAL);const a=o.filter((h=>{if(i!=null&&i!==h.type||!t.layerData.has(h.uid))return!1;const n=h.getLayoutProperty("visibility");return(n==null?void 0:n.getValue())!==H.NONE}));e.renderPass="opaque";for(let h=a.length-1;h>=0;--h)this._renderStyleLayer(a[h],e,t);l.setDepthWriteEnabled(!1),l.setBlendingEnabled(!0),l.setBlendFunctionSeparate(T.ONE,T.ONE_MINUS_SRC_ALPHA,T.ONE,T.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent",a.forEach((h=>this._renderStyleLayer(h,e,t))),l.setDepthTestEnabled(!1),l.bindVAO()}_renderStyleLayer(e,t,s){const{renderPass:i}=t;let l;switch(e.type){case p.BACKGROUND:if(i!=="background")return;l=this._brushCache.vtlBackground,l||(l=new v.vtlBackground,this._brushCache.vtlBackground=l);break;case p.FILL:if(i!=="opaque"&&t.renderPass!=="translucent")return;l=this._brushCache.vtlFill,l==null&&(l=new v.vtlFill,this._brushCache.vtlFill=l);break;case p.LINE:if(i!=="translucent")return;l=this._brushCache.vtlLine,l==null&&(l=new v.vtlLine,this._brushCache.vtlLine=l);break;case p.CIRCLE:if(i!=="translucent")return;l=this._brushCache.vtlCircle,l==null&&(l=new v.vtlCircle,this._brushCache.vtlCircle=l);break;case p.SYMBOL:if(i!=="translucent")return;l=this._brushCache.vtlSymbol,l==null&&(l=new v.vtlSymbol,this._brushCache.vtlSymbol=l)}const{displayLevel:o}=t,{minzoom:a,maxzoom:h}=e;if(a!==void 0&&a>o+f||h!==void 0&&h<=o-f)return;const{context:n}=t;n.setStencilTestEnabled(!1),n.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,m[0]=s,l.drawMany(t,m),m[0]=null}}const m=[null];let d=class extends de(ue(ge)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=k("disable-feature:vtl-level-shift")?0:1}initialize(){if(this.layer.fullExtent==null)return void this.addResolvingPromise(Promise.reject(new Z("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:r,spatialReference:e,state:t,viewingMode:s}=this.view,i=s==="local"&&!K(e)||Y.force512VTL?this.layer.tileInfo:this.layer.tileInfo.getCompatibleForVTL(256),l=this._getTileInfoSupportError(i,this.layer.fullExtent);if(l!=null)return this.addResolvingPromise(Promise.reject(l));const o=J((()=>{var c,u;return(u=(c=this.view)==null?void 0:c.basemapTerrain)==null?void 0:u.tilingSchemeLocked})).then((()=>{var w,R;const c=r.tilingScheme,u=c.pixelSize,x=u===256?1:2,_=(w=r.spatialReference)!=null&&w.isGeographic&&u===256?1:0,L=(R=r.spatialReference)!=null&&R.isGeographic||u!==256?0:1;let b;this.schemaHelper=new me(x,_,this.levelShift+L),b=u===256||u===512?this.layer.tileInfo.getCompatibleForVTL(u):this.layer.tileInfo;const S=this._getTileInfoCompatibilityError(b,c);if(S)throw S;this.tileInfo=b}));this._tileHandlerController=new AbortController;const a=this.view.resourceController;this._memCache=a.memoryController.newCache(`vtl-${this.layer.uid}`,(c=>c.release())),this.addHandles(Q((()=>this.view.qualitySettings.memoryLimit),(c=>this._memCache.maxSize=Math.ceil(c/10*1048576)),X));const h=new D(this.layer.currentStyleInfo.style);this._tileHandler=new V(this.layer,h,t.contentPixelRatio,this._memCache);const n=this._tileHandlerController.signal,C=ye(a),I=this._tileHandler.start({signal:n,schedule:C}),E=this._tileHandler.spriteMosaic;E.then((c=>{!ee(n)&&this._tileHandler&&(this.painter=new q(c,this._tileHandler.glyphMosaic))})),I.then((()=>this._tileHandlerController=null));const M=()=>{var S;this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const c=this.layer.currentStyleInfo.style,u=((S=this.view.state)==null?void 0:S.contentPixelRatio)??1,x=new D(c),_=new V(this.layer,x,u,this._memCache),L=_.start({signal:this._tileHandlerController.signal,schedule:C}),b=_.spriteMosaic;L.then((()=>this._tileHandlerController=null)),this._updatingHandles.addPromise(Promise.all([L,b]).then((([,w])=>{const R=this._tileHandler,$=this.painter;this.painter=new q(w,_.glyphMosaic),this._tileHandler=_,this.emit("data-changed"),R.destroy(),$&&$.dispose()})))};this._updatingHandles.add((()=>{var c;return{style:this.layer.currentStyleInfo.style,pixelRatio:(c=this.view.state)==null?void 0:c.contentPixelRatio}}),M),this.addHandles([this.layer.on("paint-change",(()=>this.emit("data-changed"))),this.layer.on("style-layer-change",M),this.layer.on("delete-style-layer",M),this.layer.on("spriteSource-change",(()=>this.emit("data-changed"))),this.layer.on("layout-change",(()=>this.emit("data-changed"))),this.layer.on("style-layer-visibility-change",(()=>this.emit("data-changed")))]);const N=Promise.all([o,I,E]);this.addResolvingPromise(N)}destroy(){this.painter=F(this.painter),this._tileHandlerController=te(this._tileHandlerController),this._tileHandler=B(this._tileHandler),this._memCache=B(this._memCache)}get contentZoom(){return k("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){const r=this.tileInfo.lods,e=this.layer.minScale||r[0].scale,t=this.layer.maxScale||r[r.length-1].scale,s=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale?s.maxLevel++:s.maxLevel+=this.levelShift,s}get dataScaleRange(){const r=this.tileInfo.lods;return{minScale:r[0].scale,maxScale:r[r.length-1].scale}}get dataLevelRange(){const{minScale:r,maxScale:e}=this.dataScaleRange,t=this.levelRangeFromScaleRange(r,e);return t.minLevel===1&&this.tileInfo.size[0]===256&&(t.minLevel=0),t.maxLevel+=this.levelShift,t}async fetchTile(r,e){const t=this.schemaHelper.getLevelRowColumn(r);return this._tileHandler.getVectorTile(t,e)}get hasVisibleFeatures(){return!0}};g([y()],d.prototype,"layer",void 0),g([y()],d.prototype,"levelShift",void 0),g([y()],d.prototype,"contentZoom",null),g([y()],d.prototype,"displayLevelRange",null),g([y()],d.prototype,"tileInfo",void 0),g([y()],d.prototype,"dataScaleRange",null),g([y()],d.prototype,"dataLevelRange",null),g([y()],d.prototype,"updatingProgressValue",void 0),d=g([le("esri.views.3d.layers.VectorTileLayerView3D")],d);const He=d;function ye(r){return e=>r.immediate.schedule(e)}export{He as default};
