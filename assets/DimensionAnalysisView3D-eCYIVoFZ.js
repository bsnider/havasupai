import{xR as zt,eW as st,xS as ot,aU as C,fq as T,gm as kt,xT as Et,xU as Vt,xV as Lt,xW as we,fS as ce,fO as f,kN as Gt,t9 as Le,d_ as Ge,h6 as Te,j3 as Ue,fR as k,eI as j,fs as V,eJ as Ut,wX as rt,p6 as X,aL as U,fv as Z,aM as It,xX as Ie,e as J,m6 as _e,dk as se,xY as jt,ap as v,av as x,iw as Ft,bW as lt,r as c,m as u,d as N,ab as F,g0 as Bt,f$ as Nt,x3 as dt,mm as qt,fy as ee,dJ as ue,aW as oe,wz as z,vO as Wt,c as te,fx as ct,xZ as Xt,fp as ut,mS as pt,aT as mt,e9 as A,fm as ht,fo as Pe,fl as Ce,t7 as je,aX as q,aP as D,x_ as Jt,fn as Yt,eU as be,b8 as Qt,aZ as Fe,ba as Be,ir as Zt,mp as ft,h as Kt,kj as ei,aq as $e,x$ as ti,ed as Ne,cH as ii,u as xe,cQ as pe,ec as ni,y0 as Oe,at as ai,sn as qe,y1 as si,c1 as oi,t3 as ri,uQ as li,sX as di,y2 as ci,on as Y,y3 as ui,y4 as pi,y5 as mi,oY as hi,el as fi}from"./index-DXVHLZmj.js";import{o as gi,s as _i,m as vi,f as yi,d as We}from"./analysisViewUtils-WTsLDpqe.js";import{t as g,r as Si,c as Mi}from"./LengthDimension-CLc6XfLu.js";import{m as B,f as wi}from"./Segment-CDtMJ_6A.js";import{e as ve,f as Pi,a as H,b as gt,O as Ae,j as le,w as Ci,d as I,c as bi,r as $i,t as Oi}from"./ShadedColorMaterial.glsl-DqFnyfHP.js";import{z as He,B as Di,T as _t}from"./dragEventPipeline3D-C4eO9ZVr.js";import{p as re,h as Re,w as Ti}from"./InteractiveToolBase-BN_OWso1.js";import{l as Xe}from"./Factory-BAHyl_jn.js";import{R as xi}from"./SnappingVisualizer3D-BhaVp1_v.js";import{d as Ai}from"./VerticesVisualElement-DCb-TRQK.js";import{_ as Hi}from"./ImageMaterial.glsl-CUUrJ6iD.js";import{h as me}from"./lineStippleUtils-C89mzWlO.js";import{E as Ri,p as zi,P as ki}from"./EditGeometryOperations-CEqU9PsX.js";import{e as Ei}from"./SnappingContext-Bgs6zuNU.js";import{f as Vi}from"./SnappingDragPipelineStep-C9N9XB5k.js";import{a as Li}from"./SnappingManagerPool-BfpAfYfi.js";import{p as Gi}from"./SnappingOperation-BKNWFsve.js";import{o as Ui}from"./ToolIntersector-ClZVnz5W.js";import{g as Ii}from"./quantityFormatUtils-71Dk--WZ.js";import{R as ji,b as Fi}from"./line-DrbIf2F9.js";import{I as vt}from"./LineMarker.glsl-yRm16HGB.js";import"./VisualElement-BDHzl0mr.js";import"./ColorMaterial.glsl-D1ipRF8B.js";import"./TriangleMaterial-DRxVUA_H.js";import"./ExtendedLineVisualElement-D5WDZxWr.js";import"./EngineVisualElement-eAtWakCE.js";import"./LaserlinePath.glsl-CwXlD9wR.js";import"./PointVisualElement-5O5MhDJI.js";import"./DefaultLayouts-BDDrcQ8l.js";import"./PointSnappingHint-DMy3TXLQ.js";import"./dehydratedFeatureComparison-DaZxsFf_.js";let Bi=class{constructor(t,i,n,a,o,s){this.elevationAlignedStartPoint=t,this.elevationAlignedEndPoint=i,this.directSegment=n,this.dimensionSegment=a,this.primaryOffsetAxis=o,this.spatialReference=s}};const Je=kt(U);function Ni(e,t,i,n){if(e==null)return null;let a;if(t===g.Horizontal)a=n.autoDistanceBetweenPoints2D(Je(e.elevationAlignedStartPoint),Je(e.elevationAlignedEndPoint));else{const{startRenderSpace:s,endRenderSpace:l}=e.dimensionSegment;a=Et(s,l,e.spatialReference)}if(a==null)return null;const o=t===g.Vertical?Vt(a.value,a.unit,i):Lt(a.value,a.unit,i);return st(a,o)}function he(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:a,orientation:o}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,offset:n,measureType:a,orientation:o}}function fe({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:n,orientation:a},o,s=null){if(e==null||t==null)return null;const l=St((s==null?void 0:s.directSegment)??new B,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},o),r=(s==null?void 0:s.primaryOffsetAxis)??C();ye(r,{measureType:n,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:l,orientation:a,renderCoordsHelper:o});const d=(s==null?void 0:s.dimensionSegment)??new B;return ze({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&n===g.Vertical?(T(d.startRenderSpace,l.startRenderSpace),T(d.endRenderSpace,l.endRenderSpace)):Mt(d,r,i,l,o),new Bi(e,t,l,d,r,o.spatialReference)}function Ye(e,t,i,n){return t===ie.Start?(T(e.startRenderSpace,i.startRenderSpace),T(e.endRenderSpace,n.startRenderSpace)):(T(e.startRenderSpace,i.endRenderSpace),T(e.endRenderSpace,n.endRenderSpace)),e}var ie;function qi(e,t,i,n){ce(e.startRenderSpace,t.startRenderSpace,i,n),ce(e.endRenderSpace,t.endRenderSpace,i,n)}function yt(e,t,i,n){switch(t){case g.Direct:return St(e,i,n);case g.Horizontal:case g.Vertical:{const{elevationAlignedStartPoint:a,elevationAlignedEndPoint:o,dimension:s,geometry:l}=i;let r;s.measureType===g.Direct?(r=Wi(l,n)===a.z>o.z,t===g.Horizontal&&(r=!r)):r=!Xi(l);const[d,m]=r?[a,o]:[o,a],h=Z(m,Ji);return t===g.Horizontal?h.z=d.z:(h.x=d.x,h.y=d.y),n.toRenderCoords(d,e.startRenderSpace),n.toRenderCoords(h,e.endRenderSpace),e}}}function St(e,t,i){return i.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),i.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}function Wi(e,t){const i=e.directSegment.eval(.5,f.get()),n=t.worldUpAtPosition(i,f.get()),a=e.dimensionSegment.eval(.5,f.get()),o=k(f.get(),a,i);return!rt(o,X)&&V(o,n)>0}function Xi(e){const{startRenderSpace:t,endRenderSpace:i}=e.dimensionSegment,{startRenderSpace:n,endRenderSpace:a}=e.directSegment;return Ie(n,t)<Ie(a,i)}(function(e){e[e.Start=0]="Start",e[e.End=1]="End"})(ie||(ie={}));const Ji=It(0,0,0,null);function Yi(e,t,i,n){const{directSegment:a}=i,o=ye(f.get(),{measureType:t,directSegment:a,renderCoordsHelper:n}),s=Mt(Qi,o,0,a,n).eval(.5,f.get()),l=k(f.get(),e,s);return V(l,o)*n.unitInMeters}const Qi=new B;function ye(e,t){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:a,directSegment:{startRenderSpace:o,endRenderSpace:s},directSegment:l,renderCoordsHelper:r}=t,d=l.eval(.5,f.get()),m=r.worldUpAtPosition(d,f.get()),h=r.worldBasisAtPosition(d,Gt.Y,f.get());switch(i){case g.Horizontal:T(e,m);break;case g.Vertical:V(o,m)<V(s,m)?k(e,s,o):k(e,o,s),j(e,e,m),j(e,e,m);break;case g.Direct:{const p=t.orientation??0;if(ze({elevationAlignedStartPoint:n,elevationAlignedEndPoint:a}))Le(de,-Ge(p),m),Ue(e,h,de);else{const _=k(f.get(),s,o),y=j(f.get(),_,m);j(y,y,_),Le(de,Ge(p),_),Ue(e,y,de)}break}}return rt(e,X)?T(e,h):Ut(e,e)}const de=Te();function ze({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return e!=null&&t!=null&&e.x===t.x&&e.y===t.y}function Mt(e,t,i,n,a){const{startRenderSpace:o,endRenderSpace:s}=n,l=i/a.unitInMeters,[r,d]=Zi(o,s,t,l);return ce(e.startRenderSpace,n.startRenderSpace,t,r),ce(e.endRenderSpace,n.endRenderSpace,t,d),e}function Zi(e,t,i,n=0){const a=V(t,i),o=V(e,i),s=Math.abs(a-o)+n;return a>o?[s,n]:[n,s]}function Se(e,t,i){const n=t.directSegment.eval(.5,f.get());return i.worldUpAtPosition(n,e)}function ke(e,t){const{startRenderSpace:i,endRenderSpace:n}=t.directSegment;return k(e,n,i)}function Ee(e,t,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:a}=t.dimensionSegment;return i.invert?k(e,n,a):k(e,a,n)}function De(e,t){const i=e.directSegment.eval(.5,f.get());return t.headingAtPosition(i,e.primaryOffsetAxis)}function Ki(e,t){return we(Ee(en,e))/t**2}const en=C();function wt(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i}=e;if(t==null||i==null)return!1;const n=zt(t,i);return n!=null&&st(n,"meters").value>ot}function ne(e){return e.geometry!=null}let G=class extends J{constructor(t){super(t)}initialize(){const t=_e((()=>this.analysisViewData.computations),(({computation:i})=>this._watchComputation(i)));this.addHandles(se(t))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return jt(this.view)}_watchComputation(t){return v((()=>he(t)),(i=>{const{measureType:n}=i;if(wt(i)&&n!==g.Direct){const o=Math.round(Ft(ot,"meters","kilometers"));return lt.getLogger(this).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${o} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const a=fe(i,this.view.renderCoordsHelper,t.geometry);t.geometry=a,t.result.length=Ni(a,n,this._defaultUnit,this.automaticLengthMeasurementUtils)}),x)}};c([u({constructOnly:!0})],G.prototype,"analysisViewData",void 0),c([u({constructOnly:!0})],G.prototype,"view",void 0),c([u({constructOnly:!0})],G.prototype,"automaticLengthMeasurementUtils",void 0),c([u()],G.prototype,"analysis",null),c([u()],G.prototype,"_defaultUnit",null),G=c([N("esri.views.3d.analysis.Dimension.DimensionController")],G);function ae(e){return Bt(e.accentColor,.5)}function Qe(e){return Nt(e.accentColor)}const Pt=5,tn=new F([127,127,127,.5]),Ct=.8,nn=4,an=6,sn=.1,bt=.5,on=18,rn=2,ln=.3,dn=2,cn=.25,un=20,pn=5,Ze=5,Ke=10,mn=2500,hn=50,fn=2;class gn{constructor(t){this.start=t.start,this.end=t.end,this.offset=t.offset,this.heading=t.heading,this.rotation=t.rotation,this.direct=t.direct,this.horizontal=t.horizontal,this.vertical=t.vertical}manipulatorName(t){return Object.keys(this).find((i=>this.hasOwnProperty(i)&&t===this[i]))}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(t){for(const i of Si)t(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(t){switch(t){case g.Direct:return this.direct;case g.Horizontal:return this.horizontal;case g.Vertical:return this.vertical}}}class _n extends ve{constructor(t,i){const n=Pi(F.toUnitRGBA(ae(t.effectiveTheme))),a=[new H(qt(n,1,32,32),E)];super({view:t,renderObjects:a,metadata:i.metadata,available:!1,grabCursor:"crosshair",radius:Pt,collisionPriority:1}),this._themeHandle=v((()=>({color:F.toUnitRGBA(ae(t.effectiveTheme))})),(o=>n.setParameters(o)))}destroy(){this._themeHandle.remove(),super.destroy()}}function vn(e,t){const i=[ue(-.5,0,0),ue(.5,0,0)],n=ee(t.unfocusedMaterial,i.map((o=>oe(C(),o,bt)))),a=n.instantiate({material:t.focusedMaterial});return new ve({view:e,renderObjects:[new H(n,z.Unfocused|z.Selected|E),new H(a,z.Focused|E)],collisionType:{type:"line",paths:[i]},radius:Ve(t.lineSizePt)/2,metadata:t.metadata,available:!1,...gt})}class et extends ve{constructor(t,{lineSizePt:i,material:n,metadata:a}){super({view:t,autoScaleRenderObjects:!1,collisionPriority:1,metadata:a}),this._options={calloutColor:Wt(),lineSizePt:i,material:n},this._themeHandle=v((()=>F.toUnitRGBA(ae(t.effectiveTheme))),(o=>{this._options.calloutColor=o,it(this,tt({...this._options,metadata:this.metadata}))}),te)}update({lineSizePt:t,material:i}){this._options.lineSizePt=t,this._options.material=i,it(this,tt({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function tt({calloutColor:e,lineSizePt:t,material:i,metadata:n}){return{calloutLength:.25*Jt*Ct*A(t)+on,calloutColor:e,calloutWidth:rn,customStateMask:E,discScale:ln,focusMultiplier:dn,material:i,metadata:n}}function yn(e,t){const i=[ue(-.5,0,0),ue(.5,0,0)],n=ee(t.thinOffsetManipulatorMaterial,i),a=ee(t.unfocusedMaterial,i.map((s=>oe(C(),s,bt)))),o=a.instantiate({material:t.focusedMaterial});return new ve({view:e,renderObjects:[new H(a,z.Unfocused|E),new H(o,z.Focused|E),new H(n,E)],collisionType:{type:"line",paths:[i]},radius:Ve(t.lineSizePt)/2,available:!1,metadata:t.metadata,...gt})}function Sn(e,{isStart:t,createSnappingPipelineStep:i,dimension:n,onUpdate:a,view:o}){const s=t?"startPoint":"endPoint";return[re(e,((r,d,m,h)=>{const p=He(r),{snappingStep:_,cancelSnapping:y}=i(h);m=m.next(p).next(Re(n,[s,"measureType","orientation"])).next(y),d.next(p).next(Di(o)).next(..._).next((M=>{const S=Z(M.mapEnd,new U);a(s==="startPoint"?{startPoint:S}:{endPoint:S})}))}))]}function Mn(e,{computation:t,view:i}){return[re(e,((n,a,o)=>{if(!ne(t)||!n.selected)return;const{geometry:s,dimension:l}=t,r=He(n);a.next(r).next(Ot(i,l,s.dimensionSegment,s.primaryOffsetAxis)),o.next(r).next(Re(l,["offset"]))}))]}function wn(e,{computation:t,view:i}){return[re(e,((n,a,o)=>{$t({cancel:o,computation:t,settingHeading:!0,steps:a,view:i})}))]}function Pn(e,{computation:t,view:i}){return[re(e,((n,a,o)=>{$t({cancel:o,computation:t,settingHeading:!1,steps:a,view:i})})),e.events.on("immediate-click",(n=>{Cn(n,t,i)}))]}function Cn(e,t,i){const{dimension:n,geometry:a}=t;if(n.orientation===90||n.orientation===270)return n.orientation=0,void e.stopPropagation();if(a==null)return;const{renderCoordsHelper:o}=i,s=fe({...he(t),orientation:90},o),l=fe({...he(t),orientation:270},o);if(s==null||l==null)return;const r=De(s,o),d=De(l,o),m=Dt(a,i),h=be.shortestSignedDiff(m,r),p=be.shortestSignedDiff(m,d);n.orientation=Math.abs(h)<Math.abs(p)?90:270,e.stopPropagation()}function $t(e){const{cancel:t,computation:i,settingHeading:n,steps:a,view:o}=e;if(!ne(i))return;const{renderCoordsHelper:s}=o,{dimension:l,geometry:r}=i,d=C(),m=xt(C(),r,r.directSegment,s),h=At(f.get(),{forHeading:n,geometry:r,renderCoordsHelper:s}),p=Pe(m,h,Ce()),_=n?l.orientation??De(r,o.renderCoordsHelper):l.orientation??0;a.next(_t(o,p)).next((y=>{y.action==="start"&&T(d,y.renderStart);const M=Yt(p),S=Ci(d,y.renderEnd,m,M);let L=_-Zt(S);n||(L=bn(L)),l.orientation=L})),t.next(Re(l,["orientation"]))}function bn(e){const t=be.normalize(e)%90;return t<Ze?e-t:90-t<Ze?e+(90-t):e}function $n(e,{computation:t,manipulatorMeasureType:i,view:n}){let a=g.Direct,o=0,s=0;return[e.events.on("grab-changed",(l=>{if(l.action!=="start"||!ne(t))return;const{dimension:r,geometry:d}=t;a=r.measureType,o=r.offset,s=r.orientation;const m=T(f.get(),e.renderLocation);r.measureType=i,r.offset=Yi(m,i,d,n.renderCoordsHelper),r.orientation=0})),re(e,((l,r,d)=>{if(!ne(t))return;const{geometry:m,dimension:h}=t,{renderCoordsHelper:p}=n,_=yt(Ht,i,t,p),y=ye(f.get(),{measureType:i,directSegment:m.directSegment,renderCoordsHelper:p}),M=He(l);r.next(M).next(Ot(n,h,_,y)),d.next(M).next((S=>(h.measureType=a,h.offset=o,h.orientation=s,S)))}))]}function Ot(e,t,i,n){const a=ht(f.get(),i.endRenderSpace,i.startRenderSpace);j(a,a,n);const o=Pe(i.startRenderSpace,a,Ce()),s=Pe(i.startRenderSpace,n,Ce()),l=t.offset;let r,d=0;const m=new Ti;return m.next(_t(e,o)).next((h=>{h.action==="start"&&(d=je(s,h.renderStart));const p=(je(s,h.renderEnd)-d)*e.renderCoordsHelper.unitInMeters;t.offset=l+p,r=h})),h=>(m.execute(h),r)}function Dt(e,t){const{directSegment:i}=e,{renderCoordsHelper:n}=t,a=Se(f.get(),e,n),o=ke(f.get(),e),s=j(f.get(),o,a),{viewForward:l}=t.state.camera;V(s,l)>0&&oe(s,s,-1);const r=i.eval(.5,f.get());return n.headingAtPosition(r,s)}function On(e,t,i){const{dimensionSegment:n,primaryOffsetAxis:a}=t,o=Ee(K,t),s=ct(o,X)?Xt(ge):Ae(o,a,X,ge),l=Math.max(ut(o),sn/i.unitInMeters);pt(s,s,mt(K,l,l,l)),e.modelTransform=s,e.renderLocation=n.eval(.5,K)}function Dn(e,t,i){Tt(e,t,i,{forHeading:!0})}function Tn(e,t,i){Tt(e,t,i,{forHeading:!1})}function Tt(e,t,i,{forHeading:n}){const{dimension:a,geometry:o}=t,{primaryOffsetAxis:s}=o,l=oe(xn,s,a.offset>=0?1:-1),r=At(An,{forHeading:n,geometry:o,renderCoordsHelper:i});j(r,r,l);const d=Ae(l,r,X,ge);e.modelTransform=d,e.renderLocation=xt(K,o,o.dimensionSegment,i)}const xn=C(),An=C();function Hn(e,t,i,n){const{geometry:a}=t,o=yt(Ht,i,t,n),s=ye(K,{measureType:i,directSegment:a.directSegment,renderCoordsHelper:n}),l=k(Me,o.endRenderSpace,o.startRenderSpace),r=Ae(l,s,X,ge),d=ut(l);pt(r,r,mt(Me,d,d,d)),e.modelTransform=r,e.renderLocation=o.eval(.5,Me)}function xt(e,t,i,n){const{startRenderSpace:a,endRenderSpace:o}=i,s=Rn(t,n)?a:o;return T(e,s)}function At(e,{forHeading:t,geometry:i,renderCoordsHelper:n}){return t?Se(e,i,n):Ee(e,i,{invert:!0})}function Rn(e,t){const i=ke(zn,e),n=Se(kn,e,t);return V(i,n)>0}const zn=C(),kn=C();function En(e){return A(e)+nn}function Ve(e){return A(e)+an}function it(e,t){const i=t.material,n=t.focusMultiplier??le.focusMultiplier,a=t.calloutLength??le.calloutLength,o=le.discRadius*(t.discScale??1),s=o*n,l=(_,y)=>{const M=[0,1,2,2,3,0];return new Qt(y,[[Fe.POSITION,new Be([a-_,-_,0,a+_,-_,0,a+_,_,0,a-_,_,0],M,3,!0)],[Fe.UV0,new Be([0,0,1,0,1,1,0,1],M,2,!0)]])},r=t.calloutWidth??le.calloutWidth,d=new q({width:r,color:t.calloutColor,renderOccluded:D.OccludeAndTransparent,isDecoration:!0}),m=ee(d,[[0,0,0],[a-o,0,0]]),h=ee(d,[[0,0,0],[a-s,0,0]]),p=t.customStateMask??dt.None;e.collisionType={type:"disc",direction:[0,0,1],offset:[a,0,0]},e.focusMultiplier=n,e.metadata=t.metadata,e.radius=o,e.renderObjects=[new H(l(o,i),z.Unfocused|p),new H(m,z.Unfocused|p),new H(l(s,i),z.Focused|p),new H(h,z.Focused|p)]}const E=dt.Custom1,K=C(),Me=C(),ge=Te(),Ht=new B;var O;function Vn(e,t){return{enabled:t.effectiveFeatureEnabled,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,geometry:e.geometry}}function Ln(e,t){if(wt(e))return O.Direct;if(!e.enabled)return null;const{geometry:i}=e;if(i==null||ct(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:n}=t.state,a=Se(f.get(),i,t.renderCoordsHelper),o=ke(f.get(),i),s=oe(f.get(),a,V(o,a)),l=ht(f.get(),o,s),r=we(l),d=we(s),{startRenderSpace:m,endRenderSpace:h}=i.directSegment,p=Math.max(n.computeScreenPixelSizeAt(m)*Ke,n.computeScreenPixelSizeAt(h)*Ke)**2;return r<p?O.Vertical:d<p?O.Horizontal:null}function Gn(e,t,{constraint:i,view:n}){const{unconstrainedGeometry:a}=e;if(a==null)return;const{renderCoordsHelper:o,spatialReference:s}=n,{startRenderSpace:l,endRenderSpace:r}=a.directSegment,d=o.fromRenderCoords(l,new U({spatialReference:s})),m=o.fromRenderCoords(r,new U({spatialReference:s}));let h;h=t==="start"?{startPoint:d}:{endPoint:m},Rt(e,h,{constraint:i,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,unconstrainedGeometry:a,view:n})}function Rt(e,t,i){const{constraint:n,elevationAlignedStartPoint:a,elevationAlignedEndPoint:o,unconstrainedGeometry:s,view:l}=i,{dimension:r,previousConstraint:d,preConstraintProperties:m}=e;if(a==null||o==null)return;const h=()=>{"startPoint"in t?r.startPoint=t.startPoint:"endPoint"in t&&(r.endPoint=t.endPoint)};if(n==null)h(),d!=null&&m!=null&&(r.measureType=m.measureType,r.orientation=m.orientation);else switch(r.measureType=g.Direct,n){case O.Horizontal:if(n!==d&&(r.orientation=0),"startPoint"in t){const p=t.startPoint;p!=null&&(p.z=o.z),r.startPoint=p}else if("endPoint"in t){const p=t.endPoint;p!=null&&(p.z=a.z),r.endPoint=p}break;case O.Vertical:if(n!==d&&(r.orientation=Dt(s,l)),"startPoint"in t){const p=t.startPoint;p!=null&&(p.x=o.x,p.y=o.y),r.startPoint=p}else if("endPoint"in t){const p=t.endPoint;p!=null&&(p.x=a.x,p.y=a.y),r.endPoint=p}break;case O.Direct:n!==d&&m!=null&&(r.orientation=m.orientation),h()}e.previousConstraint=n,e.unconstrainedGeometry=s}(function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Direct=2]="Direct"})(O||(O={}));let w=class extends J{constructor(e){super(e),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new ft,this._updatingHandles=new Kt,this._getSnappingContext=ei((n=>new Ei({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new Ri(new zi("point",ki(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new xi})));const{view:t}=e;this._snappingManagerResult=Li(t),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:me(2)}),this._constraintSnappingIndicator=new I({view:t,attached:!0,width:1,renderOccluded:D.OccludeAndTransparent,stipplePattern:me(5),isDecoration:!0});const i=F.toUnitRGBA(tn);this._stagedStartIndicator=new Ai({view:t,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:e.view.renderCoordsHelper.spatialReference,color:i,size:2*Pt,outlineSize:0,renderOccluded:D.OccludeAndTransparent,isDecoration:!0})}initialize(){var o;const{view:e}=this;this._snappingOperation=new Gi({view:e});const t=ae(e.effectiveTheme),i=Qe(e.effectiveTheme),n=!((o=e.stage)!=null&&o.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._textureHandle=Xe(e.stage.textures,{accentColor:t,contrastColor:i,preMultiplyAlpha:n}),this._orientationManipulatorMaterial=new Hi({draped:!1,texture:this._textureHandle.texture,writeDepth:!1,renderOccluded:D.Opaque,isDecoration:!0});const a=_e((()=>this.analysisViewData.computations),(({computation:s})=>this._createManipulators(s)));this.addHandles([v((()=>({accentColor:ae(e.effectiveTheme),contrastColor:Qe(e.effectiveTheme)})),(({accentColor:s,contrastColor:l})=>{const r=this._textureHandle;this._textureHandle=Xe(e.stage.textures,{accentColor:s,contrastColor:l,preMultiplyAlpha:n}),this._orientationManipulatorMaterial.setParameters({texture:this._textureHandle.texture}),r==null||r.release();const d=F.toUnitRGBA(s);this._unfocusedOffsetManipulatorMaterial.setParameters({color:d}),this._focusedOffsetManipulatorMaterial.setParameters({color:d}),this._thinOffsetManipulatorMaterial.setParameters({color:d}),this._constraintSnappingIndicator.color=d}),te),se(a),v((()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation})),(({stagedPoint:s,stagedComputation:l})=>{if(l==null||s==null)return;const r=Z(s,new U);this._applyPointUpdate(l,{endPoint:r})}),$e),v((()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator})),((s,l)=>{const{stagedDimension:r,selectedComputation:d,firstGrabbedManipulator:m}=s;if(r===(l==null?void 0:l.stagedDimension)&&m===(l==null?void 0:l.firstGrabbedManipulator)){for(const h of[d,l==null?void 0:l.selectedComputation])if(h!=null){const p=this._computationManipulators.get(h);p!=null&&this._updateManipulators(h,p,s)}}else for(const[h,p]of this._computationManipulators)this._updateManipulators(h,p,s)}),x),v((()=>this.analysis.style.lineSize),(s=>this._updateManipulatorStyle(s)),te),v((()=>this.view.state.camera),(()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)})),v((()=>{const s=this._stagedComputation;if(!s)return null;const l=s.elevationAlignedStartPoint,r=C();return l!=null&&this.view.renderCoordsHelper.toRenderCoords(l,r)?r:null}),(s=>{s!=null?(this._stagedStartIndicator.vertices=[s],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1}))]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),ti(this,(()=>{const s=this._activeComputation,l=this._stagedComputation;if(s==null||l!=null){const r=this.view.inputManager.latestPointerType??"mouse",d=this._getSnappingContext(r);this._updatingHandles.addPromise(Ne(this._snappingOperation.snapAgainNearPreviousMapPoint(this._snappingManager,d)))}if(s!=null){const{start:r,end:d}=this._computationManipulators.get(s);if(r.grabbing||d.grabbing){const m=r.grabbing?"start":"end",h=this._computeConstraint(s);Gn(s,m,{constraint:h,view:this.view})}}}))}destroy(){this._textureHandle=ii(this._textureHandle),this._snappingOperation=xe(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:e}=this.analysisViewData;return this.hasGrabbedManipulators&&e!=null?e:null}get _stagedComputation(){var i;const e=this._stagedDimension,t=(i=this.analysisViewData.computations.at(-1))==null?void 0:i.computation;return e==null||t==null||t.dimension!==e?null:t}get _constraintHandles(){return[pe((()=>this.analysisViewData.selectedComputation),(e=>{e.previousConstraint=this._computeConstraint(e)}),{...x,equals:Oe}),v((()=>{const e=this._activeComputation;if(e==null)return null;const{measureType:t,orientation:i}=e.dimension;return{measureType:t,orientation:i,computation:e}}),((e,t)=>{if(e!=null&&t==null){const{measureType:i,orientation:n,computation:a}=e;switch(a.previousConstraint){case O.Horizontal:a.preConstraintProperties={measureType:g.Horizontal,orientation:0};break;case O.Vertical:a.preConstraintProperties={measureType:g.Vertical,orientation:0};break;case O.Direct:a.preConstraintProperties={measureType:g.Direct,orientation:n};break;default:a.preConstraintProperties={measureType:i,orientation:n}}}e==null&&t!=null&&(t.computation.preConstraintProperties=null)}),$e)]}get _snappingIndicatorHandles(){const e="snapping-indicator-event-handles";return[v((()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation})),(({stagedComputation:t,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(e),i!=null)if(i===t)n.attached=!0;else{const{start:a,end:o}=this._computationManipulators.get(i),s=()=>{n.attached=a.grabbing||o.grabbing};s(),this.addHandles([a.events.on("grab-changed",s),o.events.on("grab-changed",s)],e)}else n.attached=!1})),v((()=>{const t=this._activeComputation;return t!=null?{geometry:t.geometry,constraint:t.previousConstraint}:{}}),(({geometry:t,constraint:i})=>{const n=this._constraintSnappingIndicator;t!=null&&i!=null&&i!==O.Direct?(n.visible=!0,n.setGeometryFromSegment(t.directSegment)):n.visible=!1}))]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(e){const{_stagedDimension:t}=this;if(t==null){const i=this._onUnstagedClick(e);return this.analysis.dimensions.add(i),null}return this._onStagedClick(e),t}onPointerMove({mapPoint:e,pointerType:t}){if(t==="touch")return;const i=this._getSnappingContext(t);this._updatingHandles.addPromise(Ne(this._snappingOperation.snap({point:e},this._snappingManager,i)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:e,pointerType:t}){let i=e;if(t==="mouse"){const a=this._getSnappingContext(t);i=this._snappingManager.update({point:e,context:a})}const n=new Mi({startPoint:Z(i,new U),endPoint:null,measureType:g.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:e,pointerType:t}){const i=this._stagedComputation;if(i==null)return;let n=e;if(t==="mouse"){const o=this._getSnappingContext(t);n=this._snappingManager.update({point:e,context:o})}const a=Z(n,new U);this._applyPointUpdate(i,{endPoint:a}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(e){const t=this._setupPointManipulator(e,{isStart:!0}),i=this._setupPointManipulator(e,{isStart:!1}),n=this._setupOffsetManipulator(e),a=this._setupHeadingManipulator(e),o=this._setupRotationManipulator(e),s=this._setupMeasureTypeManipulator(e,g.Direct),l=this._setupMeasureTypeManipulator(e,g.Horizontal),r=this._setupMeasureTypeManipulator(e,g.Vertical),d=new gn({start:t,end:i,offset:n,heading:a,rotation:o,direct:s,horizontal:l,vertical:r});this._setupComputationToManipulatorsSync(e,d),this._computationManipulators.set(e,d),this.manipulators.addMany(d.values());const m=ni(d.values().map((h=>h.events.on("focus-changed",(()=>{d.values().some((p=>p.focused))&&this._resetSnappingState()})))));return{manipulators:d,remove:()=>{m.remove(),this._computationHandles.remove(e),this._computationManipulators.delete(e);for(const h of d.values())this.manipulators.remove(h)}}}_setupComputationToManipulatorsSync(e,t){this._computationHandles.add([v((()=>e.geometry),(()=>this._updateManipulators(e,t)),{...x,equals:Oe})],e)}_setupPointManipulator(e,t){const{view:i}=this,{dimension:n}=e,a=new _n(i,{metadata:n}),o=Sn(a,{isStart:t.isStart,createSnappingPipelineStep:s=>Vi({snappingContext:this._getSnappingContext(s),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:n,onUpdate:s=>this._applyPointUpdate(e,s),view:i});return this._computationHandles.add(o,e),a}_setupOffsetManipulator(e){const{view:t}=this,i=vn(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:e.dimension}),n=Mn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupHeadingManipulator(e){const{view:t}=this,i=new et(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=wn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupRotationManipulator(e){const{view:t}=this,i=new et(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=Pn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupMeasureTypeManipulator(e,t){const{view:i}=this,n=yn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:e.dimension}),a=$n(n,{computation:e,manipulatorMeasureType:t,view:i});return this._computationHandles.add(a,e),n}_updateManipulators(e,t,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:a,firstGrabbedManipulator:o}=i,{start:s,end:l,offset:r,heading:d,rotation:m}=t,h=a===e,p=ne(e),{dimension:_}=e;for(const S of t.values()){const L=p&&n==null&&(o==null||S===o);S===r?(S.available=L,S.selected=h):S.available=L&&h}if(!p)return;this._computeConstraint(e)!=null?t.forEachMeasureTypeManipulator((S=>S.available=!1)):t.manipulatorForMeasureType(_.measureType).available=!1;for(const S of[d,m])_.measureType===g.Direct&&_.offset!==0||(S.available=!1);ze(e)?m.available=!1:d.available=!1;const{geometry:y}=e;s.renderLocation=y.directSegment.startRenderSpace,l.renderLocation=y.directSegment.endRenderSpace;const{renderCoordsHelper:M}=this.view;On(r,y,M),d.available&&Dn(d,e,M),m.available&&Tn(m,e,M),t.forEachMeasureTypeManipulator(((S,L)=>{S.available&&Hn(S,e,L,M)}))}_updateManipulatorStyle(e){const t=En(e),i=Ve(e),n={lineSizePt:e,material:this._orientationManipulatorMaterial};for(const{offset:a,heading:o,rotation:s}of this._computationManipulators.values())a.radius=i/2,o.update(n),s.update(n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:t}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(e,t){const{view:i}=this,n=he(e);"startPoint"in t&&(n.elevationAlignedStartPoint=t.startPoint),"endPoint"in t&&(n.elevationAlignedEndPoint=t.endPoint);const a=fe(n,i.renderCoordsHelper);if(a==null)return;const o=this._computeConstraint({...n,geometry:a});Rt(e,t,{...n,constraint:o,unconstrainedGeometry:a,view:i}),e===this._stagedComputation&&this._updateStagedDimensionOffset(e)}_updateStagedDimensionOffset(e){if(e.geometry==null)return;e.geometry.directSegment.eval(.5,nt);const{state:t,renderCoordsHelper:i}=this.view,n=t.camera.computeScreenPixelSizeAt(nt);e.dimension.offset=hn*n*i.unitInMeters}_computeConstraint(e){return Ln(Vn(e,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new q({width:1,renderOccluded:D.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get test(){}};c([u({constructOnly:!0})],w.prototype,"analysis",void 0),c([u({constructOnly:!0})],w.prototype,"analysisViewData",void 0),c([u({constructOnly:!0})],w.prototype,"manipulators",void 0),c([u({constructOnly:!0})],w.prototype,"parentTool",void 0),c([u({constructOnly:!0,nonNullable:!0})],w.prototype,"view",void 0),c([u({readOnly:!0})],w.prototype,"updating",null),c([u()],w.prototype,"firstGrabbedManipulator",null),c([u()],w.prototype,"hasGrabbedManipulators",null),c([u()],w.prototype,"snappingOptions",null),c([u()],w.prototype,"_stagedDimension",void 0),c([u()],w.prototype,"_activeComputation",null),c([u()],w.prototype,"_stagedComputation",null),w=c([N("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],w);const nt=C();var W;(function(e){e.Ready="ready",e.Creating="creating",e.Created="created"})(W||(W={}));let b=class extends gi{constructor(e){super(e),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._placementMode=at,this._pointerMoveTimerMs=mn,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Ui(this.view.state.viewingMode),this._lengthDimensionSubTool=new w({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([se(this._lengthDimensionSubTool),ai((()=>this._clearPointerMoveTimeout())),pe((()=>this.state===W.Created),(()=>this.finishToolCreation()),x),pe((()=>this.firstGrabbedManipulator),(e=>{this.selectedDimension=e.metadata}),x),v((()=>this.selectedDimension),(()=>this._resetPointerMoveTimeout()),x)])}get state(){return this.analysis.dimensions.some((e=>e.type==="length"))?this._activeSubTool!=null?W.Creating:W.Created:W.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(e){this.analysisViewData.selectedDimension=e}place(e){this.selectedDimension=null,this._placementMode=e}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":this._keyDownHandler(e)}}onActivate(){this._placementMode=at,this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){var e;(e=this._activeSubTool)==null||e.onDeactivate(),this._activeSubTool=null}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(this._activeSubTool==null)return;const t=this._intersectScreen(e);t!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),this.selectedDimension&&this._placementMode==="single"&&(this.view.activeTool=null),e.stopPropagation())}_doubleClickHandler(e){this.active&&(this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const t=this._intersectScreen(e);t!=null&&this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_keyDownHandler(e){var t,i;qe.cancel===e.key?((t=this._activeSubTool)!=null&&t.removeStaged()&&this._placementMode==="multiple"&&e.stopPropagation(),this.active||(this.selectedDimension=null)):qe.delete.includes(e.key)&&((i=this._activeSubTool)==null||i.removeStaged(),this._removeSelected())}_intersectScreen(e){const t=si(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,n=f.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,new U({spatialReference:this.view.spatialReference})):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=oi(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach((e=>e.manipulator.state|=E)),this._prevPointerMoveTimeout=ri.setTimeout((()=>{this.manipulators.forEach((e=>e.manipulator.state&=~E))}),this._pointerMoveTimerMs)}get test(){}};c([u({constructOnly:!0})],b.prototype,"view",void 0),c([u({constructOnly:!0})],b.prototype,"analysis",void 0),c([u({readOnly:!0})],b.prototype,"state",null),c([u({readOnly:!0})],b.prototype,"updating",null),c([u({readOnly:!0})],b.prototype,"cursor",null),c([u({constructOnly:!0})],b.prototype,"analysisViewData",void 0),c([u()],b.prototype,"selectedDimension",null),c([u()],b.prototype,"automaticManipulatorSelection",void 0),c([u()],b.prototype,"_activeSubTool",void 0),c([u()],b.prototype,"_lengthDimensionSubTool",void 0),c([u()],b.prototype,"_placementMode",void 0),b=c([N("esri.views.3d.analysis.Dimension.DimensionTool")],b);const at="multiple";class Un extends bi{constructor(t,i){super(t),this._hasExternalMaterial=!1,this._renderOccluded=D.OccludeAndTransparent,this._width=1,this._color=li(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=i,this._hasExternalMaterial=i!=null,this.applyProperties(t)}setGeometryFromSegment(t,i){const n=t.endRenderSpace;this.transform=di(In,n),this._normal=i;const{points:a}=t.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[a]}get renderOccluded(){var t;return((t=this._material)==null?void 0:t.parameters.renderOccluded)??this._renderOccluded}set renderOccluded(t){var i;this._renderOccluded=t,(i=this._material)==null||i.setParameters({renderOccluded:t})}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get normal(){return this._normal}set normal(t){this._normal=t,this.recreateGeometry()}get width(){var t;return((t=this._material)==null?void 0:t.parameters.width)??this._width}set width(t){var i;this._width=t,(i=this._material)==null||i.setParameters({width:t})}get color(){var t;return((t=this._material)==null?void 0:t.parameters.color)??this._color}set color(t){var i;this._color=ci(t),(i=this._material)==null||i.setParameters({color:this._color})}get placement(){var t;return((t=this._material)==null?void 0:t.parameters.placement)??this._placement}set placement(t){var i;this._placement=t,(i=this._material)==null||i.setParameters({placement:this._placement})}get markerPrimitive(){var t;return((t=this._material)==null?void 0:t.parameters.markerPrimitive)??this._markerPrimitive}set markerPrimitive(t){var i;this._markerPrimitive=t,(i=this._material)==null||i.setParameters({markerPrimitive:t})}createExternalResources(){this._hasExternalMaterial||(this._material=new vt({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(t){for(const i of ji(this.geometry,this.normal)){const n=Fi(this._material,i);t.addGeometry(n)}}forEachMaterial(t){this._hasExternalMaterial||t(this._material)}}const In=Te();let jn=class{set visible(t){for(const i of this._visualElements.values())i.attached=t}constructor(t){this.destroyed=!1,this._handles=new ft,this._messages=null,this._labelSegment=new B;const{analysis:i,computation:n,view:a,messages:o,isDecoration:s}=t;this.analysis=i,this.computation=n,this.view=a,this._messages=o;const l=t.visible,r={view:a,attached:l,isDecoration:s},{fontSize:d,textColor:m,textBackgroundColor:h}=i.style;this._visualElements=new Wn({marker:new Un(r,t.markerMaterial),dimension:new I(r,t.dimensionLineMaterial),startOffset:new I(r,t.offsetLineMaterial),endOffset:new I(r,t.offsetLineMaterial),dimensionSmall:new I(r,t.smallDimensionLineMaterial),startOffsetSmall:new I(r,t.smallOffsetLineMaterial),endOffsetSmall:new I(r,t.smallOffsetLineMaterial),label:new wi({view:a,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:A(d),textColor:m.clone(),backgroundColor:h.clone(),isDecoration:s})}),this._handles.add([v((()=>n.geometry),(p=>{this.updateCameraDependentElements(a.state.camera,p,i.style),n.geometry!=null&&this._updateLines(n.geometry)}),{...te,equals:Oe}),v((()=>n.length),(p=>this._updateLabelContent(p)),te)])}destroy(){this.destroyed=!0,this._handles=xe(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){}_updateLines(t){const i=Ye(Bn,ie.Start,t.directSegment,t.dimensionSegment),n=Ye(Nn,ie.End,t.directSegment,t.dimensionSegment),a=this._visualElements;a.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),a.dimension.setGeometryFromSegment(t.dimensionSegment),a.startOffset.setGeometryFromSegment(i),a.endOffset.setGeometryFromSegment(n),a.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),a.startOffsetSmall.setGeometryFromSegment(i),a.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(t,i,n){const a=this._visualElements;if(i==null){for(const M of a.values())M.visible=!1;return}const o=t.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,qn)),s=Ki(i,o),l=s<(A(n.lineSize)*fn)**2,r=!l;a.marker.visible=r,a.dimension.visible=r,a.startOffset.visible=r,a.endOffset.visible=r,a.dimensionSmall.visible=l,a.startOffsetSmall.visible=l,a.endOffsetSmall.visible=l;const d=A(n.fontSize)*pn,{label:m}=a;if(m.visible=s>=d**2,!m.visible)return;const{dimensionSegment:h,primaryOffsetAxis:p}=i,{offset:_}=this.computation.dimension,y=(Math.sign(_)>=0?1:-1)*Fn(n)*o;qi(this._labelSegment,h,p,y),m.updateLabelPosition()}updateLabelStyle(t){const{label:i}=this._visualElements;i.fontSize=A(t.fontSize),i.textColor=t.textColor,i.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(t){const{label:i}=this._visualElements;t!=null&&this._messages!=null?i.text=Ii(this._messages,t,t.unit):i.text=""}};function Fn(e){return 1.5*A(e.fontSize)+un+A(e.lineSize/2)}const Bn=new B,Nn=new B,qn=C();class Wn{constructor(t){this.marker=t.marker,this.dimension=t.dimension,this.startOffset=t.startOffset,this.endOffset=t.endOffset,this.dimensionSmall=t.dimensionSmall,this.startOffsetSmall=t.startOffsetSmall,this.endOffsetSmall=t.endOffsetSmall,this.label=t.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let R=class extends J{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(e){super(e),this.loadingMessages=!1,this._messages=null}initialize(){const e=this.isDecoration;this._markerMaterial=new vt({width:1,anchor:ui.Tip,color:Y,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:D.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:e}),this._dimensionLineMaterial=new q({width:1,color:Y,renderOccluded:D.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:e}),this._offsetLineMaterial=new q({width:1,color:Y,renderOccluded:D.OccludeAndTransparent,stipplePattern:me(5),isDecoration:e}),this._smallDimensionLineMaterial=new q({width:1,color:Y,renderOccluded:D.OccludeAndTransparent,isDecoration:e}),this._smallOffsetLineMaterial=new q({width:1,color:Y,renderOccluded:D.OccludeAndTransparent,stipplePattern:me(5),isDecoration:e});const t=_e((()=>this.analysisViewData.computations),(({computation:i})=>this._createVisualization(i)));this._dimensionVisualizations=t,this.addHandles([se(t),v((()=>F.toUnitRGBA(this.analysis.style.color)),(i=>{for(const n of this._lineMaterials())n.setParameters({color:i})}),x),v((()=>this.analysis.style.lineSize),(i=>{const n=A(i);this._markerMaterial.setParameters({width:n*Ct}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const a=Math.max(n*cn,1);this._offsetLineMaterial.setParameters({width:a})}),x),v((()=>({camera:this.view.state.camera,style:Xn(this.analysis)})),(({camera:i,style:n})=>{for(const{visualization:a}of this._dimensionVisualizations)a.updateCameraDependentElements(i,a.computation.geometry,n),a.updateLabelStyle(n)})),v((()=>this.visible),(i=>{for(const{visualization:n}of this._dimensionVisualizations)n.visible=i}))]),this.addHandles([pi((()=>this._updateMessageBundle())),pe((()=>!this.loadingMessages),(()=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateUnitsMessages(this._messages)}),$e)]),this._updateMessageBundle()}get testInfo(){}_createVisualization(e){const t=new jn({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:t,remove:()=>t.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await mi("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Xn(e){const{fontSize:t,lineSize:i,textColor:n,textBackgroundColor:a}=e.style;return{fontSize:t,lineSize:i,textBackgroundColor:a.clone(),textColor:n.clone()}}c([u({constructOnly:!0})],R.prototype,"analysisViewData",void 0),c([u({constructOnly:!0,nonNullable:!0})],R.prototype,"view",void 0),c([u({constructOnly:!0})],R.prototype,"isDecoration",void 0),c([u()],R.prototype,"analysis",null),c([u()],R.prototype,"visible",null),c([u()],R.prototype,"loadingMessages",void 0),R=c([N("esri.views.3d.analysis.Dimension.DimensionVisualization")],R);let Q=class extends J{constructor(e){super(e),this.dimension=null,this.length=null}};c([u({constructOnly:!0,nonNullable:!0})],Q.prototype,"dimension",void 0),c([u()],Q.prototype,"length",void 0),Q=c([N("esri.views.analysis.LengthDimensionResult")],Q);let $=class extends J{constructor(e){super(e),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(e){const{dimension:t,...i}=e;return{result:new Q({dimension:t}),...i}}initialize(){this.addHandles([v((()=>this.dimension.startPoint),(e=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(e)),x),v((()=>this.dimension.endPoint),(e=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(e)),x)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};c([u({constructOnly:!0,nonNullable:!0})],$.prototype,"result",void 0),c([u({constructOnly:!0,nonNullable:!0})],$.prototype,"projectAndAlignPoint",void 0),c([u()],$.prototype,"dimension",null),c([u()],$.prototype,"length",null),c([u()],$.prototype,"geometry",void 0),c([u()],$.prototype,"unconstrainedGeometry",void 0),c([u()],$.prototype,"elevationAlignedStartPoint",void 0),c([u()],$.prototype,"elevationAlignedEndPoint",void 0),c([u()],$.prototype,"preConstraintProperties",void 0),c([u()],$.prototype,"previousConstraint",void 0),$=c([N("esri.views.3d.analysis.Dimension.LengthDimensionComputation")],$);let P=class extends _i(J){constructor(e){super(e),this.type="dimension-view-3d",this.analysis=null,this.tool=null,this.selectedDimension=null,this.userOperation=null,this._dimensionsToComputations=new Map,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(t==null)return null;const{spatialReference:i,elevationProvider:n}=this.view,a=$i(t,i,n);return a==null&&Oi(this.analysis,t.spatialReference,lt.getLogger(this)),a};const e=_e((()=>this.analysis.dimensions),(t=>this._createComputation(t)));this.computations=e,this.addHandles([vi(this,b),se(e)]),this._analysisVisualization=new R({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this.addResolvingPromise(hi().then((t=>{this._analysisController=new G({analysisViewData:this,view:this.view,automaticLengthMeasurementUtils:t})})))}destroy(){this.userOperation=fi(this.userOperation),yi(this),this._analysisVisualization=xe(this._analysisVisualization)}get updating(){var e;return((e=this._analysisVisualization)==null?void 0:e.loadingMessages)??!1}get results(){return this.analysis.dimensions.map((e=>this._dimensionsToComputations.get(e).result))}get selectedComputation(){const{selectedDimension:e}=this;return e==null?null:this._dimensionsToComputations.get(e)}get testInfo(){}async createLengthDimensions(e){this.selectedDimension=null,await We(this,{placementOptions:e,onToolActivated:t=>t.place("multiple")})}place(e){return this.selectedDimension=null,We(this,{placementOptions:e,onToolActivated:t=>t.place("single")})}_createComputation(e){const{_dimensionsToComputations:t}=this,i=new $({dimension:e,projectAndAlignPoint:this._projectAndAlignPoint});return t.set(e,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(e){const{dimension:t}=e;t===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(t),e.destroy()}};c([u({readOnly:!0})],P.prototype,"type",void 0),c([u({constructOnly:!0,nonNullable:!0})],P.prototype,"analysis",void 0),c([u()],P.prototype,"tool",void 0),c([u()],P.prototype,"updating",null),c([u({readOnly:!0})],P.prototype,"results",null),c([u()],P.prototype,"computations",void 0),c([u()],P.prototype,"selectedDimension",void 0),c([u()],P.prototype,"selectedComputation",null),c([u()],P.prototype,"userOperation",void 0),c([u()],P.prototype,"_analysisVisualization",void 0),c([u()],P.prototype,"_analysisController",void 0),c([u()],P.prototype,"_dimensionsToComputations",void 0),P=c([N("esri.views.3d.analysis.DimensionAnalysisView3D")],P);const Ta=P;export{Ta as default};
