import{ka as z,cj as j,ci as F}from"./index-CA3J3HgS.js";import{i as O}from"./CIMResourceManager-DrvCYrqi.js";import{a as G,h as T,u as $}from"./CIMSymbolHelper-C68tE6Wf.js";import{OverrideHelper as q}from"./OverrideHelper-Ccm_Yyhj.js";import{T as S,R as D}from"./rasterizingUtils-B1sATo4A.js";import"./BidiEngine-QXap_35O.js";import"./Rect-CUzevAry.js";import"./BoundingBox-G_oUBWBn.js";import"./callExpressionWithFeature-CdqjzejE.js";const A=96/72;class X{constructor(o){this._spatialReference=o,this._imageDataCanvas=null,this._cimResourceManager=new O}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(o,n,l,R,I,s,c,m,d,x){if(!o)return null;const{data:w}=o;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;const{symbol:C}=w;s||(s=z(C));const a=await q.resolveSymbolOverrides(w,n,this._spatialReference,I,s,c,m),u=this._cimResourceManager,b=[];G.fetchResources(a,u,b),G.fetchFonts(a,u,b),b.length>0&&await Promise.all(b);const{width:t,height:h}=l;let y=k(s,t,h,R,x);const e=G.getEnvelope(a,y,u);if(!e)return null;e.x===1/0&&(e.x=t+2),e.y===1/0&&(e.y=-h/2),e.width===-1/0&&(e.width=t),e.height===-1/0&&(e.height=h);let g=1,_=0,v=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;e.width>t&&(i=t/e.width);let r=1;e.height>h&&(r=h/e.height),R==="preview"&&(e.width<t&&(i=t/e.width),e.height<h&&(r=h/e.height)),g=Math.min(i,r),_=e.x+e.width/2,v=e.y+e.height/2}break;case"CIMLineSymbol":if(x){v=e.y+e.height/2,_=e.x+e.width/2;const i=e.width-t,r=e.height-h;y={paths:S(y.paths,{xmin:-1*e.width/2+i,xmax:e.width/2-i,ymin:-1*e.height/2+r,ymax:e.height/2-r,width:e.width-2*i,height:e.height-2*r})}}else{(d||e.height>h)&&(g=h/e.height),v=e.y+e.height/2;const i=e.x*g+t/2,r=(e.x+e.width)*g+t/2,M=j(y)?y.paths:F(y)?y.rings:null;if(M===null)throw new Error("Bad geometry, can't rasterise symbol!");M[0][0][0]-=i/g,M[0][2][0]-=(r-t)/g}break;case"CIMPolygonSymbol":if(x){v=e.y+e.height/2,_=e.x+e.width/2;const i=e.width-t,r=e.height-h;y={paths:S(y.rings,{xmin:-1*e.width/2+i,xmax:e.width/2-i,ymin:-1*e.height/2+r,ymax:e.height/2-r,width:e.width-2*i,height:e.height-2*r})}}else{_=e.x+e.width/2,v=e.y+e.height/2;const i=e.x*g+t/2,r=(e.x+e.width)*g+t/2,M=e.y*g+h/2,P=(e.y+e.height)*g+h/2,{rings:p}=y;i<0&&(p[0][0][0]-=i,p[0][3][0]-=i,p[0][4][0]-=i),M<0&&(p[0][0][1]+=M,p[0][1][1]+=M,p[0][4][1]+=M),r>t&&(p[0][1][0]-=r-t,p[0][2][0]-=r-t),P>h&&(p[0][2][1]+=P-h,p[0][3][1]+=P-h)}}const E={type:"cim",data:{type:"CIMSymbolReference",symbol:a}};return this.rasterize(E,t,h,_,v,g,s,1,y)}rasterize(o,n,l,R,I,s,c,m=0,d=null,x=window.devicePixelRatio||1){const{data:w}=o;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;const{symbol:C}=w,a=this._canvas,u=x*A;a.width=n*u,a.height=l*u,c||(c=z(C)),d||(d=k(c,n,l,"legend")),a.width+=2*m,a.height+=2*m;const b=a.getContext("2d",{willReadFrequently:!0}),t=T.createIdentity();return t.translate(-R,-I),t.scale(s*u,-s*u),t.translate(n*u/2+m,l*u/2+m),b.clearRect(0,0,a.width,a.height),new $(b,this._cimResourceManager,t,!0).drawSymbol(C,d),b.getImageData(0,0,a.width,a.height)}}function B(f,o,n,l){return o==="esriGeometryPolygon"?{rings:D(S(f.rings,{xmin:0,ymin:0,width:n,height:l}),-1*n/2,-1*l/2)}:o==="esriGeometryPolyline"?{paths:D(S(f.paths,{xmin:0,ymin:0,width:n,height:l}),-1*n/2,-1*l/2)}:null}function k(f,o,n,l,R){const s=-o/2+1,c=o/2-1,m=n/2-1,d=-n/2+1;if(R&&(f==="esriGeometryPolygon"||f==="esriGeometryPolyline")){const x=B(R,f,o,n);if(x)return x}switch(f){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[c,0]]]};default:return l==="legend"?{rings:[[[s,m],[c,0],[c,d],[s,d],[s,m]]]}:{rings:[[[s,m],[c,m],[c,d],[s,d],[s,m]]]}}}export{X as CIMSymbolRasterizer};
