import{e as b,cp as y,bW as O,bK as u,kU as v,kV as R,kW as S,r as a,m as f,d as T,kX as w,cO as F,cP as _,kY as M}from"./index-DXVHLZmj.js";const d=-1;let c=class extends b{constructor(t){super(t),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=y("mapview-transitions-duration"),this.effects=[]}set effect(t){if(this._get("effect")!==(t=t||"")){this._set("effect",t);try{this._transitionTo(g(t))}catch(e){this._transitionTo([]),O.getLogger(this).warn("Invalid Effect",{effect:t,error:e})}}}get final(){return this._final}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(t){this._updateForScale(t)}get transitioning(){return this._to!==null}canTransitionTo(t){try{return this.scale>0&&p(this._current,g(t),this.scale)}catch{return!1}}transitionStep(t,e){this._applyTimeTransition(t),this._updateForScale(e)}endTransition(){this._applyTimeTransition(this.duration)}_transitionTo(t){this.scale>0&&p(this._current,t,this.scale)?(this._final=t,this._to=u(t),V(this._current,this._to,this.scale),this._from=u(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=t),this._set("effects",this._current[0]?u(this._current[0].effects):[])}_applyTimeTransition(t){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=t;const e=Math.min(1,this._time/this.duration);for(let s=0;s<this._current.length;s++){const i=this._current[s],r=this._from[s],l=this._to[s];i.scale=C(r.scale,l.scale,e);for(let n=0;n<i.effects.length;n++){const o=i.effects[n],h=r.effects[n],m=l.effects[n];o.interpolate(h,m,e)}}e===1&&(this._current=this._final,this._set("effects",this._current[0]?u(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(t){if(this._set("scale",t),this._current.length===0)return;const e=this._current,s=this._current.length-1;let i,r,l=1;if(e.length===1||t>=e[0].scale)r=i=e[0].effects;else if(t<=e[s].scale)r=i=e[s].effects;else for(let n=0;n<s;n++){const o=e[n],h=e[n+1];if(o.scale>=t&&h.scale<=t){l=(t-o.scale)/(h.scale-o.scale),i=o.effects,r=h.effects;break}}for(let n=0;n<this.effects.length;n++)this.effects[n].interpolate(i[n],r[n],l)}};function g(t){const e=v(t)||[];return G(e)?[{scale:d,effects:e}]:e}function p(t,e,s){var i,r,l,n;return!((i=t[0])!=null&&i.effects)||!((r=e[0])!=null&&r.effects)?!0:!((((l=t[0])==null?void 0:l.scale)===d||((n=e[0])==null?void 0:n.scale)===d)&&(t.length>1||e.length>1)&&s<=0)&&R(t[0].effects,e[0].effects)}function V(t,e,s){const i=t.length>e.length?t:e,r=t.length>e.length?e:t,l=r[r.length-1],n=(l==null?void 0:l.scale)??s,o=(l==null?void 0:l.effects)??[];for(let h=r.length;h<i.length;h++)r.push({scale:n,effects:[...o]});for(let h=0;h<i.length;h++)r[h].scale=r[h].scale===d?s:r[h].scale,i[h].scale=i[h].scale===d?s:i[h].scale,S(r[h].effects,i[h].effects)}function C(t,e,s){return t+(e-t)*s}function G(t){const e=t[0];return!!e&&"type"in e}a([f()],c.prototype,"_to",void 0),a([f()],c.prototype,"duration",void 0),a([f({value:""})],c.prototype,"effect",null),a([f({readOnly:!0})],c.prototype,"effects",void 0),a([f({readOnly:!0})],c.prototype,"final",null),a([f({readOnly:!0})],c.prototype,"hasEffects",null),a([f({value:0})],c.prototype,"scale",null),a([f({readOnly:!0})],c.prototype,"transitioning",null),c=a([T("esri.layers.effects.EffectView")],c);let A=class extends w{constructor(){super(...arguments),this._childrenSet=new Set,this._needsSort=!1,this._children=[],this._childrenObservable=new F,this._effectView=null,this._highlightGradient=null}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode=e,this.requestRender()}get children(){return _(this._childrenObservable),this._children}get clips(){return this._clips}set clips(e){this._clips=e,this.children.forEach((s=>s.clips=e))}get computedEffects(){var e;return((e=this._effectView)==null?void 0:e.effects)??null}get effect(){var e;return((e=this._effectView)==null?void 0:e.effect)??""}set effect(e){(this._effectView||e)&&(this._effectView||(this._effectView=new c,this.addTransitionable(this._effectView)),this._effectView.effect=e,this.requestRender())}get highlightGradient(){return this._highlightGradient}set highlightGradient(e){this._highlightGradient=e,this.requestRender()}get hasBlending(){return!!this.blendMode}get hasHighlight(){return this.children.some((e=>e.hasHighlight))}get hasLabels(){return this.children.some((e=>e.hasLabels))}get requiresDedicatedFBO(){return this.children.some((e=>"blendMode"in e&&e.blendMode&&e.blendMode!=="normal"))}get isReady(){return this.children.every((e=>e.isReady))}get sortFunction(){return this._sortFunction}set sortFunction(e){this._sortFunction=e,e&&(this._needsSort=!0)}doRender(e){var r;const s=this.createRenderParams(e),{painter:i}=s;i.beforeRenderLayer(s,(r=this._clips)!=null&&r.length?255:0,this.computedOpacity),this.renderChildren(s),i.afterRenderLayer(s,this.computedOpacity)}addChild(e){return this.addChildAt(e,this.children.length)}addChildAt(e,s=this.children.length){if(!e||this.contains(e))return e;this._needsSort=!0;const i=e.parent;return i&&i!==this&&i.removeChild(e),s>=this.children.length?this.children.push(e):this.children.splice(s,0,e),this._childrenSet.add(e),e.parent=this,e.stage=this.stage,this!==this.stage&&(e.clips=this.clips),this.requestRender(),this._childrenObservable.notify(),e}contains(e){return _(this._childrenObservable),this._childrenSet.has(e)}removeAllChildren(){this._childrenSet.clear(),this._needsSort=!0;for(const e of this.children)this!==this.stage&&(e.clips=null),e.stage=null,e.parent=null;this.children.length=0,this._childrenObservable.notify()}removeChild(e){return this.contains(e)?this.removeChildAt(this.children.indexOf(e)):e}removeChildAt(e){if(e<0||e>=this.children.length)return null;this._needsSort=!0;const s=this.children.splice(e,1)[0];return this._childrenSet.delete(s),this!==this.stage&&(s.clips=null),s.stage=null,s.parent=null,this._childrenObservable.notify(),s}beforeRender(e){super.beforeRender(e),this.sortFunction&&this._needsSort&&(this.children.sort(this.sortFunction),this._needsSort=!1,this._childrenObservable.notify());for(const s of this.children)s.beforeRender(e)}afterRender(e){super.afterRender(e);for(const s of this.children)s.afterRender(e)}_createTransforms(){return{displayViewScreenMat3:M()}}onAttach(){super.onAttach();const e=this.stage;for(const s of this.children)s.stage=e}onDetach(){super.onDetach();for(const e of this.children)e.stage=null}renderChildren(e){for(const s of this.children)s.processRender(e)}createRenderParams(e){return{...e,requireFBO:this.requiresDedicatedFBO,blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:e.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition,highlightGradient:this._highlightGradient||e.highlightGradient}}isTransitioning(){return super.isTransitioning()||this.children.some((e=>e.transitioning))}};export{c as a,A as n};
