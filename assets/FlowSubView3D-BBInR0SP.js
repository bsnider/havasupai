import{sQ as w,dh as b,aK as S,sR as $,aB as y,dm as x,c7 as v,oy as R,ab as C,om as I,u as L,me as D,e as z,r as o,m as u,d as _,sS as E,dM as F,O as q,cr as G,af as j,dW as H,aR as M,cs as W,m2 as B,dO as T,fE as k,oS as O}from"./index-Ds3x37R4.js";import{c as P,u as A,g as N}from"./dataUtils-Cxih6PDB.js";import{s as U,h as V}from"./utils-DSFVOAAV.js";import{p as K}from"./SubView3D-Ml6i0v2s.js";import{R as Q,b as X}from"./line-CdAdATfH.js";function Y(t,e,s,r){const{spatialReference:n}=t;return Z(s.map((i=>i.map((l=>{const[a,d]=J(l,e),{absoluteZ:f}=w(a,d,0,n,t,r),m=b(a,d,f);return t.renderCoordsHelper.toRenderCoords(m,n,m),m})))))}function Z(t){const e=Q(t),s=new S({width:2,color:y(.1,.2,1,1),innerWidth:1,innerColor:y(.2,.4,1,1),cap:$.ROUND});return e.map((r=>X(s,r)))}function J({x:t,y:e},s){const{extent:r,size:[n,i]}=s;return[t/n*r.width+r.xmin,(i-e)/i*r.height+r.ymin]}function tt(t,e,s){let[r,n,i,l]=[null,null,null,null];for(e.reset(t);!e.done;){const a=e.next();if(a==null)continue;if(!a.visible){e.skipSubtree();continue}const d=a.extent;a.leaf&&a.rendered&&x(d,s)&&(r=g(d[0],r),n=g(d[1],n),i=p(d[2],i),l=p(d[3],l))}return r==null||n==null||i==null||l==null?null:v([r,n,i,l])}function p(t,e){return e==null?t:Math.max(t,e)}function g(t,e){return e==null?t:Math.min(t,e)}class et{constructor(e,s){this.streamlines=e,this._geometries=s,this._object3D=null,this._engineLayer=null}get attached(){return this._object3D!=null&&this._engineLayer!=null}attach(e){const{_geometries:s}=this;if(s==null)return;this.detach();const r=new R(e,{pickable:!1,updatePolicy:C.SYNC}),n=new I({geometries:s});n.visible=!0,r.add(n),this._object3D=n,this._engineLayer=r}detach(){this.attached&&(this._engineLayer=L(this._engineLayer),this._object3D=D(this._object3D))}}let c=class extends z{constructor(t){super(t),this.simulationSettings=null,this.loadImagery=null,this.createGeometry=null}async load(t,e){const s=await this.loadImagery(t,e);if(s==null)return null;const r=this._createFlowFieldFromData(s),n=this._getStreamlines(t,r),i=this.createGeometry(t,n);return new et(n,i)}_createFlowFieldFromData(t){return P(this.simulationSettings,t)}_getStreamlines(t,e){const{size:[s,r]}=t;return A(this.simulationSettings,e,s,r)}};o([u()],c.prototype,"simulationSettings",void 0),o([u()],c.prototype,"loadImagery",void 0),o([u()],c.prototype,"createGeometry",void 0),c=o([_("esri.views.3d.support.flow.StreamlinesStyle3D")],c);let h=class extends K{constructor(t){super(t),this.type="flow",this._preorderIterator=new E,this._abortController=null,this._debouncedLoad=F((async()=>{var a;const{view:e,_style:s}=this;if(s==null)return;const r=this._computeExtent();if(r==null)return;const n={extent:r,timeExtent:this.layer.timeExtent,size:this._viewSizeWithEqualRatio(r),pixelRatio:e.state.contentPixelRatio};this._abortController==null&&(this._abortController=new AbortController);const i=this._abortController,l=await s.load(n,i.signal);q(i.signal),l!=null&&((a=this._resources)==null||a.detach(),l.attach(e.stage),this._resources=l)})),this._loadImagery=(e,s)=>{const{extent:r,size:[n,i],timeExtent:l}=e;return N(this.layer,r,n,i,l,s)},this._createFlowGeometry=(e,s)=>Y(this.view,e,s,this.elevationInfo)}initialize(){this.addHandles([G((()=>this.newStyleRequired),(()=>this._updateStyle()),j)]),this.updatingHandles.add((()=>this._style),(()=>this._triggerLoad())),this._updateStyle(),this.updatingHandles.addWhen((()=>{var t;return!((t=this.view.basemapTerrain)!=null&&t.updating)}),(()=>this._triggerLoad()))}destroy(){this._abortController=H(this._abortController),this.clear()}get layer(){return this.layerView.layer}get flowRenderer(){const t=this.layer.renderer;return(t==null?void 0:t.type)!=="flow"?null:t}get elevationInfo(){return new M({mode:"absolute-height",offset:1e3})}get dataBounds(){const{fullExtent:t}=this.layer,{spatialReference:e}=this.view.basemapTerrain,s=W(t,e).geometry;return s==null?null:B(s)}get simulationSettings(){const{flowRenderer:t}=this;return t==null?null:U(t)}get newStyleRequired(){var s;const t=(s=this._style)==null?void 0:s.simulationSettings,e=this.simulationSettings;return t!=null&&e!=null&&!V(t,e)}doRefresh(){return this._triggerLoad()}clear(){var t;(t=this._resources)==null||t.detach(),this._resources=null}_triggerLoad(){return T(this.updatingHandles.addPromise(this._debouncedLoad()))}_updateStyle(){var e;const{simulationSettings:t}=this;t!=null&&((e=this._style)==null||e.destroy(),this._style=new c({simulationSettings:t,loadImagery:this._loadImagery,createGeometry:this._createFlowGeometry}))}_computeExtent(){const t=this.view.basemapTerrain,e=t==null?void 0:t.rootTiles;if(e==null||e.length===0)return null;const{spatialReference:s}=t,{dataBounds:r}=this;if(!s||r==null)return null;const n=tt(e,this._preorderIterator,r);return n==null?null:(O(n,r,n),k(n,s))}_viewSizeWithEqualRatio(t){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin),[s,r]=this.view.size;return s<r?[s,Math.floor(s/e)]:[Math.floor(r*e),r]}get test(){}};o([u()],h.prototype,"type",void 0),o([u()],h.prototype,"_style",void 0),o([u()],h.prototype,"layer",null),o([u()],h.prototype,"flowRenderer",null),o([u()],h.prototype,"elevationInfo",null),o([u()],h.prototype,"dataBounds",null),o([u()],h.prototype,"simulationSettings",null),o([u()],h.prototype,"newStyleRequired",null),h=o([_("esri.views.3d.layers.FlowSubView3D")],h);export{h as b};
