import{e as $t}from"./deduplicate-KKspL-e9.js";import{aH as x,ar as tt,na as At,aG as H,e$ as ot,f1 as J,eX as at,eh as ft,ei as dt,tg as xt,th as Nt,dz as gt,aI as St,or as Q,hz as ht,d$ as vt,df as pt,aM as T}from"./index-Ds3x37R4.js";import{RegularEdgeInstancesLayout as R,SilhouetteEdgeInstancesLayout as X,EdgeInputBufferLayout as Lt}from"./bufferLayouts-CsU3sRc7.js";class Ot{constructor(){this.position0=x(),this.position1=x(),this.faceNormal0=x(),this.faceNormal1=x(),this.componentIndex=0,this.cosAngle=0}}const k=-1;function bt(t,n,s){const a=t.vertices.position,i=t.vertices.componentIndex,u=m.position0,g=m.position1,h=m.faceNormal0,I=m.faceNormal1,{edges:r,normals:f}=Mt(t),w=r.length/4,$=n.allocate(w);let E=0;const F=w,N=s==null?void 0:s.allocate(F);let U=0,e=0,o=0;C.length=0;for(let d=0;d<w;++d){const v=4*d;a.getVec(r.data[v],u),a.getVec(r.data[v+1],g);const B=C.pushNew();B.index=4*d,B.length=At(u,g)}C.sort(((d,v)=>v.length-d.length));const l=new Array,c=new Array;C.forAll((({length:d,index:v})=>{const B=r.data[v],It=r.data[v+1],et=r.data[v+2],nt=r.data[v+3],st=nt===k;if(a.getVec(B,u),a.getVec(It,g),st){const A=3*et;H(h,f.data[A],f.data[A+1],f.data[A+2]),ot(I,h),m.componentIndex=i.get(B),m.cosAngle=J(h,I)}else{let A=3*et;if(H(h,f.data[A],f.data[A+1],f.data[A+2]),A=3*nt,H(I,f.data[A],f.data[A+1],f.data[A+2]),m.componentIndex=i.get(B),m.cosAngle=J(h,I),Vt(m,Ft))return;m.cosAngle<-.9999&&ot(I,h)}e+=d,o++,st||Et(m,Ut)?(n.write($,E++,m),l.push(d)):Bt(m,mt)&&(N&&s&&s.write(N,U++,m),c.push(d))}));const y=new Float32Array(l.reverse()),S=new Float32Array(c.reverse()),L=N&&s?{instancesData:N.slice(0,U),lodInfo:{lengths:S}}:void 0;return{regular:{instancesData:$.slice(0,E),lodInfo:{lengths:y}},silhouette:L,averageEdgeLength:e/o}}function Et(t,n){return t.cosAngle<n}function Vt(t,n){return t.cosAngle>n}function Bt(t,n){const s=xt(t.cosAngle);return Nt(rt,t.position1,t.position0),s*(J(ft(_t,t.faceNormal0,t.faceNormal1),rt)>0?-1:1)>n}function Mt(t){const n=t.faces.length/3,s=t.faces,a=t.neighbors,i=t.vertices.position;p.length=G.length=0;for(let u=0;u<n;u++){const g=3*u,h=a[g],I=a[g+1],r=a[g+2],f=s[g],w=s[g+1],$=s[g+2];i.getVec(f,V),i.getVec(w,D),i.getVec($,W),at(D,D,V),at(W,W,V),ft(V,D,W),dt(V,V),G.pushArray(V),(h===k||f<w)&&(p.push(f),p.push(w),p.push(u),p.push(h)),(I===k||w<$)&&(p.push(w),p.push($),p.push(u),p.push(I)),(r===k||$<f)&&(p.push($),p.push(f),p.push(u),p.push(r))}return{edges:p,normals:G}}class Pt{constructor(){this.index=0,this.length=0}}const C=new tt({allocator:t=>t||new Pt,deallocator:null}),p=new tt({deallocator:null}),G=new tt({deallocator:null}),m=new Ot,_t=x(),rt=x(),V=x(),D=x(),W=x(),mt=gt(4),Ft=Math.cos(mt),Tt=gt(35),Ut=Math.cos(Tt);function it(t,n,s){const a=n/3,i=new Uint32Array(s+1),u=new Uint32Array(s+1),g=(e,o)=>{e<o?i[e+1]++:u[o+1]++};for(let e=0;e<a;e++){const o=t[3*e],l=t[3*e+1],c=t[3*e+2];g(o,l),g(l,c),g(c,o)}let h=0,I=0;for(let e=0;e<s;e++){const o=i[e+1],l=u[e+1];i[e+1]=h,u[e+1]=I,h+=o,I+=l}const r=new Uint32Array(6*a),f=i[s],w=(e,o,l)=>{if(e<o){const c=i[e+1]++;r[2*c]=o,r[2*c+1]=l}else{const c=u[o+1]++;r[2*f+2*c]=e,r[2*f+2*c+1]=l}};for(let e=0;e<a;e++){const o=t[3*e],l=t[3*e+1],c=t[3*e+2];w(o,l,e),w(l,c,e),w(c,o,e)}const $=(e,o)=>{const l=2*e,c=o-e;for(let y=1;y<c;y++){const S=r[l+2*y],L=r[l+2*y+1];let d=y-1;for(;d>=0&&r[l+2*d]>S;d--)r[l+2*d+2]=r[l+2*d],r[l+2*d+3]=r[l+2*d+1];r[l+2*d+2]=S,r[l+2*d+3]=L}};for(let e=0;e<s;e++)$(i[e],i[e+1]),$(f+u[e],f+u[e+1]);const E=new Int32Array(3*a),F=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,N=(e,o)=>{const l=F(e,o);E[3*o+l]=-1},U=(e,o,l,c)=>{const y=F(e,o);E[3*o+y]=c;const S=F(l,c);E[3*c+S]=o};for(let e=0;e<s;e++){let o=i[e];const l=i[e+1];let c=u[e];const y=u[e+1];for(;o<l&&c<y;){const S=r[2*o],L=r[2*f+2*c];S===L?(U(e,r[2*o+1],L,r[2*f+2*c+1]),o++,c++):S<L?(N(e,r[2*o+1]),o++):(N(L,r[2*f+2*c+1]),c++)}for(;o<l;)N(e,r[2*o+1]),o++;for(;c<y;)N(r[2*f+2*c],r[2*f+2*c+1]),c++}return E}const K=.7;let wt=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?Dt:Ct}write(n,s,a){j.seed=this._edgeHashFunction(a);const i=j.getIntRange(0,255),u=j.getIntRange(0,this.settings.variants-1),g=j.getFloat(),h=255*(.5*Wt(-(1-Math.min(g/K,1))+Math.max(0,g-K)/(1-K),1.2)+.5);n.position0.setVec(s,a.position0),n.position1.setVec(s,a.position1),n.componentIndex.set(s,a.componentIndex),n.variantOffset.set(s,i),n.variantStroke.set(s,u),n.variantExtension.set(s,h)}};const O=new Float32Array(6),b=new Uint32Array(O.buffer),_=new Uint32Array(1);function Ct(t){return O[0]=t.position0[0],O[1]=t.position0[1],O[2]=t.position0[2],O[3]=t.position1[0],O[4]=t.position1[1],O[5]=t.position1[2],_[0]=31*(31*(31*(31*(31*(166811+b[0])+b[1])+b[2])+b[3])+b[4])+b[5],_[0]}function Dt(t){const n=O;n[0]=M(t.position0[0]),n[1]=M(t.position0[1]),n[2]=M(t.position0[2]),n[3]=M(t.position1[0]),n[4]=M(t.position1[1]),n[5]=M(t.position1[2]),_[0]=5381;for(let s=0;s<b.length;s++)_[0]=31*_[0]+b[s];return _[0]}const ct=1e4;function M(t){return Math.round(t*ct)/ct}function Wt(t,n){return Math.abs(t)**n*Math.sign(t)}const z=class z{constructor(){this._commonWriter=new wt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return R.createBuffer(n)}write(n,s,a){this._commonWriter.write(n,s,a),St(P,a.faceNormal0,a.faceNormal1),dt(P,P);const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;Q(i,s,P[0],P[1],P[2],u)}};z.Layout=R,z.glLayout=ht(R,1);let Y=z;const q=class q{constructor(){this._commonWriter=new wt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return X.createBuffer(n)}write(n,s,a){this._commonWriter.write(n,s,a);{const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;Q(i,s,a.faceNormal0[0],a.faceNormal0[1],a.faceNormal0[2],u)}{const{typedBuffer:i,typedBufferStride:u}=n.normal2Compressed;Q(i,s,a.faceNormal1[0],a.faceNormal1[1],a.faceNormal1[2],u)}}};q.Layout=X,q.glLayout=ht(X,1);let Z=q;const P=x(),j=new vt;function jt(t){const n=yt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return lt.updateSettings(t.writerSettings),ut.updateSettings(t.writerSettings),bt(n,lt,ut)}function yt(t,n,s,a){if(n){const g=it(s,a,t.count);return new kt(s,a,g,t)}const i=$t(t.buffer,t.stride/4,{originalIndices:s}),u=it(i.indices,a,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:u,vertices:Lt.createView(i.buffer)}}class kt{constructor(n,s,a,i){this.faces=n,this.facesLength=s,this.neighbors=a,this.vertices=i}}const lt=new Y,ut=new Z,zt=pt().vec3f(T.POSITION0).vec3f(T.POSITION1),qt=pt().vec3f(T.POSITION0).vec3f(T.POSITION1).u16(T.COMPONENTINDEX),Kt=Object.freeze(Object.defineProperty({__proto__:null,extract:jt,extractComponentsEdgeLocationsLayout:qt,extractEdgeInformation:yt,extractEdgeLocationsLayout:zt},Symbol.toStringTag,{value:"Module"}));export{Z as N,zt as d,Kt as e,jt as f,qt as g,bt as p,yt as u,Y as w};
