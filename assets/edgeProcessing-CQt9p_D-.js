import{e as At}from"./deduplicate-DlY1Xjvm.js";import{aU as x,aE as tt,n7 as $t,aT as R,fq as ot,fs as Z,fm as at,eI as ft,eJ as dt,td as xt,te as Nt,d_ as pt,aV as St,oo as G,hu as gt,eq as vt,dH as ht,aZ as U}from"./index-BdmtnMtL.js";import{RegularEdgeInstancesLayout as z,SilhouetteEdgeInstancesLayout as J,EdgeInputBufferLayout as Lt}from"./bufferLayouts-DKfLbDVD.js";class Et{constructor(){this.position0=x(),this.position1=x(),this.faceNormal0=x(),this.faceNormal1=x(),this.componentIndex=0,this.cosAngle=0}}const j=-1;function Ot(t,n,s){const a=t.vertices.position,i=t.vertices.componentIndex,u=m.position0,p=m.position1,g=m.faceNormal0,I=m.faceNormal1,{edges:r,normals:f}=Mt(t),w=r.length/4,A=n.allocate(w);let V=0;const T=w,N=s==null?void 0:s.allocate(T);let F=0,e=0,o=0;C.length=0;for(let d=0;d<w;++d){const v=4*d;a.getVec(r.data[v],u),a.getVec(r.data[v+1],p);const B=C.pushNew();B.index=4*d,B.length=$t(u,p)}C.sort(((d,v)=>v.length-d.length));const l=new Array,c=new Array;C.forAll((({length:d,index:v})=>{const B=r.data[v],It=r.data[v+1],et=r.data[v+2],nt=r.data[v+3],st=nt===j;if(a.getVec(B,u),a.getVec(It,p),st){const $=3*et;R(g,f.data[$],f.data[$+1],f.data[$+2]),ot(I,g),m.componentIndex=i.get(B),m.cosAngle=Z(g,I)}else{let $=3*et;if(R(g,f.data[$],f.data[$+1],f.data[$+2]),$=3*nt,R(I,f.data[$],f.data[$+1],f.data[$+2]),m.componentIndex=i.get(B),m.cosAngle=Z(g,I),bt(m,Tt))return;m.cosAngle<-.9999&&ot(I,g)}e+=d,o++,st||Vt(m,Ft)?(n.write(A,V++,m),l.push(d)):Bt(m,mt)&&(N&&s&&s.write(N,F++,m),c.push(d))}));const y=new Float32Array(l.reverse()),S=new Float32Array(c.reverse()),L=N&&s?{instancesData:N.slice(0,F),lodInfo:{lengths:S}}:void 0;return{regular:{instancesData:A.slice(0,V),lodInfo:{lengths:y}},silhouette:L,averageEdgeLength:e/o}}function Vt(t,n){return t.cosAngle<n}function bt(t,n){return t.cosAngle>n}function Bt(t,n){const s=xt(t.cosAngle);return Nt(rt,t.position1,t.position0),s*(Z(ft(_t,t.faceNormal0,t.faceNormal1),rt)>0?-1:1)>n}function Mt(t){const n=t.faces.length/3,s=t.faces,a=t.neighbors,i=t.vertices.position;h.length=K.length=0;for(let u=0;u<n;u++){const p=3*u,g=a[p],I=a[p+1],r=a[p+2],f=s[p],w=s[p+1],A=s[p+2];i.getVec(f,b),i.getVec(w,D),i.getVec(A,W),at(D,D,b),at(W,W,b),ft(b,D,W),dt(b,b),K.pushArray(b),(g===j||f<w)&&(h.push(f),h.push(w),h.push(u),h.push(g)),(I===j||w<A)&&(h.push(w),h.push(A),h.push(u),h.push(I)),(r===j||A<f)&&(h.push(A),h.push(f),h.push(u),h.push(r))}return{edges:h,normals:K}}class Pt{constructor(){this.index=0,this.length=0}}const C=new tt({allocator:t=>t||new Pt,deallocator:null}),h=new tt({deallocator:null}),K=new tt({deallocator:null}),m=new Et,_t=x(),rt=x(),b=x(),D=x(),W=x(),mt=pt(4),Tt=Math.cos(mt),Ut=pt(35),Ft=Math.cos(Ut);function it(t,n,s){const a=n/3,i=new Uint32Array(s+1),u=new Uint32Array(s+1),p=(e,o)=>{e<o?i[e+1]++:u[o+1]++};for(let e=0;e<a;e++){const o=t[3*e],l=t[3*e+1],c=t[3*e+2];p(o,l),p(l,c),p(c,o)}let g=0,I=0;for(let e=0;e<s;e++){const o=i[e+1],l=u[e+1];i[e+1]=g,u[e+1]=I,g+=o,I+=l}const r=new Uint32Array(6*a),f=i[s],w=(e,o,l)=>{if(e<o){const c=i[e+1]++;r[2*c]=o,r[2*c+1]=l}else{const c=u[o+1]++;r[2*f+2*c]=e,r[2*f+2*c+1]=l}};for(let e=0;e<a;e++){const o=t[3*e],l=t[3*e+1],c=t[3*e+2];w(o,l,e),w(l,c,e),w(c,o,e)}const A=(e,o)=>{const l=2*e,c=o-e;for(let y=1;y<c;y++){const S=r[l+2*y],L=r[l+2*y+1];let d=y-1;for(;d>=0&&r[l+2*d]>S;d--)r[l+2*d+2]=r[l+2*d],r[l+2*d+3]=r[l+2*d+1];r[l+2*d+2]=S,r[l+2*d+3]=L}};for(let e=0;e<s;e++)A(i[e],i[e+1]),A(f+u[e],f+u[e+1]);const V=new Int32Array(3*a),T=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,N=(e,o)=>{const l=T(e,o);V[3*o+l]=-1},F=(e,o,l,c)=>{const y=T(e,o);V[3*o+y]=c;const S=T(l,c);V[3*c+S]=o};for(let e=0;e<s;e++){let o=i[e];const l=i[e+1];let c=u[e];const y=u[e+1];for(;o<l&&c<y;){const S=r[2*o],L=r[2*f+2*c];S===L?(F(e,r[2*o+1],L,r[2*f+2*c+1]),o++,c++):S<L?(N(e,r[2*o+1]),o++):(N(L,r[2*f+2*c+1]),c++)}for(;o<l;)N(e,r[2*o+1]),o++;for(;c<y;)N(r[2*f+2*c],r[2*f+2*c+1]),c++}return V}const X=.7;let wt=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?Dt:Ct}write(n,s,a){q.seed=this._edgeHashFunction(a);const i=q.getIntRange(0,255),u=q.getIntRange(0,this.settings.variants-1),p=q.getFloat(),g=255*(.5*Wt(-(1-Math.min(p/X,1))+Math.max(0,p-X)/(1-X),1.2)+.5);n.position0.setVec(s,a.position0),n.position1.setVec(s,a.position1),n.componentIndex.set(s,a.componentIndex),n.variantOffset.set(s,i),n.variantStroke.set(s,u),n.variantExtension.set(s,g)}};const E=new Float32Array(6),O=new Uint32Array(E.buffer),_=new Uint32Array(1);function Ct(t){return E[0]=t.position0[0],E[1]=t.position0[1],E[2]=t.position0[2],E[3]=t.position1[0],E[4]=t.position1[1],E[5]=t.position1[2],_[0]=31*(31*(31*(31*(31*(166811+O[0])+O[1])+O[2])+O[3])+O[4])+O[5],_[0]}function Dt(t){const n=E;n[0]=M(t.position0[0]),n[1]=M(t.position0[1]),n[2]=M(t.position0[2]),n[3]=M(t.position1[0]),n[4]=M(t.position1[1]),n[5]=M(t.position1[2]),_[0]=5381;for(let s=0;s<O.length;s++)_[0]=31*_[0]+O[s];return _[0]}const ct=1e4;function M(t){return Math.round(t*ct)/ct}function Wt(t,n){return Math.abs(t)**n*Math.sign(t)}const k=class k{constructor(){this._commonWriter=new wt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return z.createBuffer(n)}write(n,s,a){this._commonWriter.write(n,s,a),St(P,a.faceNormal0,a.faceNormal1),dt(P,P);const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;G(i,s,P[0],P[1],P[2],u)}};k.Layout=z,k.glLayout=gt(z,1);let Q=k;const H=class H{constructor(){this._commonWriter=new wt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return J.createBuffer(n)}write(n,s,a){this._commonWriter.write(n,s,a);{const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;G(i,s,a.faceNormal0[0],a.faceNormal0[1],a.faceNormal0[2],u)}{const{typedBuffer:i,typedBufferStride:u}=n.normal2Compressed;G(i,s,a.faceNormal1[0],a.faceNormal1[1],a.faceNormal1[2],u)}}};H.Layout=J,H.glLayout=gt(J,1);let Y=H;const P=x(),q=new vt;function qt(t){const n=yt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return lt.updateSettings(t.writerSettings),ut.updateSettings(t.writerSettings),Ot(n,lt,ut)}function yt(t,n,s,a){if(n){const p=it(s,a,t.count);return new jt(s,a,p,t)}const i=At(t.buffer,t.stride/4,{originalIndices:s}),u=it(i.indices,a,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:u,vertices:Lt.createView(i.buffer)}}class jt{constructor(n,s,a,i){this.faces=n,this.facesLength=s,this.neighbors=a,this.vertices=i}}const lt=new Q,ut=new Y,kt=ht().vec3f(U.POSITION0).vec3f(U.POSITION1),Ht=ht().vec3f(U.POSITION0).vec3f(U.POSITION1).u16(U.COMPONENTINDEX),Xt=Object.freeze(Object.defineProperty({__proto__:null,extract:qt,extractComponentsEdgeLocationsLayout:Ht,extractEdgeInformation:yt,extractEdgeLocationsLayout:kt},Symbol.toStringTag,{value:"Module"}));export{Y as N,kt as d,Xt as e,qt as f,Ht as g,Ot as p,yt as u,Q as w};
