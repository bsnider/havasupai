import{E as he,l4 as oe,vx as m,vy as Ie,vz as le,vA as ye,aZ as o,mI as W,vB as x,pU as ce,p_ as D,e as ve,aN as Ee,h6 as F,mV as Te,aT as Ae,aU as L,mM as be,m2 as Ce,vC as Se,rE as Le,m1 as Re,dH as de,vD as k,mJ as Oe,rO as Me,vE as xe,vw as J,r as y,m as v,d as ue,n8 as B,vF as De,n6 as we,j3 as z,lu as Fe,vG as Ne,tB as He,vH as Ve,vI as G,hu as _e,dD as ge,dw as fe,cJ as pe,eF as $e,eH as Y,vJ as Ue,vK as Be,vL as ze,fj as Ge,vM as Pe,pC as N,eN as qe,f as H,tA as C,p3 as je,os as K,u2 as We,fm as V,u as ke,vN as $,vO as Je,fs as Q,bm as Z,hq as Ye,vP as Ke,aO as M,vQ as Qe,vR as Ze,vS as Xe,vT as et}from"./index-CA3J3HgS.js";class tt{constructor(e,s,i){this._elementSize=s,this._buffer=he.createVertex(e,oe.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,s,i,a=0){const n=new Uint8Array(this.array,e*this.elementSize,(s-e)*this.elementSize);new Uint8Array(i.array,a*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,s){const i=e*this._elementSize,a=s*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,a)}resize(e){const s=e*this._elementSize,i=new ArrayBuffer(s);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(s),this._capacity=e}}class st{constructor(e){this.modelOriginHi=e.getField(o.INSTANCEMODELORIGINHI,W),this.modelOriginLo=e.getField(o.INSTANCEMODELORIGINLO,W),this.model=e.getField(o.INSTANCEMODEL,x),this.modelNormal=e.getField(o.INSTANCEMODELNORMAL,x),this.featureAttribute=e.getField(o.INSTANCEFEATUREATTRIBUTE,ce),this.color=e.getField(o.INSTANCECOLOR,D),this.objectAndLayerIdColor=e.getField(o.INSTANCEOBJECTANDLAYERIDCOLOR,D)}}class it{constructor(e,s){this._rctx=e,this._instanceBufferLayout=s,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,s=this._tailIndex;return e>=s?e-s:e+this._capacity-s}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){var e;return((e=this._buffer)==null?void 0:e.usedMemory)??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){m(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){m(this._updating,"not updating"),this.size<Ie*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){m(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),m(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){m(this._updating,"not updating"),m(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(w,Math.floor(this._capacity*le));this._resize(e)}_shrink(){const e=Math.max(w,Math.floor(this._capacity*ye));this._resize(e)}_resize(e){if(m(this._updating,"not updating"),e===this._capacity)return;const s=new tt(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const i=this.size,a=this._compactInstances(s);m(a===i,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=a,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=s,this._view=new st(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const s=this._headIndex,i=this._tailIndex;return i<s?(this._buffer.copyRange(i,s,e),s-i):i>s?(this._buffer.copyRange(i,this._capacity,e),s>0&&this._buffer.copyRange(0,s,e,this._capacity-i),s+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,s){e<s?this._buffer.transferRange(e,s):e>s&&(s>0&&this._buffer.transferRange(0,s),this._buffer.transferRange(e,this._capacity))}}const w=64;var l;function at(t){let e=de().mat4f64(o.LOCALTRANSFORM).mat4f64(o.GLOBALTRANSFORM).vec4f64(o.BOUNDINGSPHERE).vec3f64(o.MODELORIGIN).mat3f(o.INSTANCEMODEL).mat3f(o.INSTANCEMODELNORMAL).vec2f(o.MODELSCALEFACTORS);return t.includes(o.FEATUREATTRIBUTE)&&(e=e.vec4f(o.FEATUREATTRIBUTE)),t.includes(o.COLOR)&&(e=e.vec4u8(o.COLOR)),t.includes(o.OLIDCOLOR)&&(e=e.vec4u8(o.OLIDCOLOR)),e=e.u8(o.STATE).u8(o.LODLEVEL),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(l||(l={}));class X{constructor(e){this.localTransform=e.getField(o.LOCALTRANSFORM,k),this.globalTransform=e.getField(o.GLOBALTRANSFORM,k),this.modelOrigin=e.getField(o.MODELORIGIN,Oe),this.model=e.getField(o.INSTANCEMODEL,x),this.modelNormal=e.getField(o.INSTANCEMODELNORMAL,x),this.modelScaleFactors=e.getField(o.MODELSCALEFACTORS,Me),this.boundingSphere=e.getField(o.BOUNDINGSPHERE,xe),this.featureAttribute=e.getField(o.FEATUREATTRIBUTE,ce),this.color=e.getField(o.COLOR,D),this.objectAndLayerIdColor=e.getField(o.OLIDCOLOR,D),this.state=e.getField(o.STATE,J),this.lodLevel=e.getField(o.LODLEVEL,J)}}let S=class extends ve{constructor(t,e){super(t),this.events=new Ee,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=at(e),this._capacity=w,this._buffer=this._layout.createBuffer(this._capacity),this._view=new X(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,l.ALLOCATED),this._size++,this.events.emit("instances-changed"),t}removeInstance(t){const e=this._view.state;m(t>=0&&t<this._capacity&&(e.get(t)&l.ALLOCATED)!==0,"invalid instance handle"),this._getStateFlag(t,l.ACTIVE)?this._setStateFlags(t,l.REMOVE):this.freeInstance(t),this.events.emit("instances-changed")}freeInstance(t){const e=this._view.state;m(t>=0&&t<this._capacity&&(e.get(t)&l.ALLOCATED)!==0,"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,s=!0){this._view.localTransform.setMat(t,e),s&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,s=!0){this._view.globalTransform.setMat(t,e),s&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){const e=this._view,s=I,i=T;e.localTransform.getMat(t,ee),e.globalTransform.getMat(t,U);const a=Te(U,U,ee);Ae(s,a[12],a[13],a[14]),e.modelOrigin.setVec(t,s),be(i,a),e.model.setMat(t,i);const n=Se(I,a);n.sort(),e.modelScaleFactors.set(t,0,n[1]),e.modelScaleFactors.set(t,1,n[2]),Le(i,i),Re(i,i),e.modelNormal.setMat(t,i),this._setStateFlags(t,l.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){const s=this._view;s.model.getMat(t,T),s.modelOrigin.getVec(t,I),e[0]=T[0],e[1]=T[1],e[2]=T[2],e[3]=0,e[4]=T[3],e[5]=T[4],e[6]=T[5],e[7]=0,e[8]=T[6],e[9]=T[7],e[10]=T[8],e[11]=0,e[12]=I[0],e[13]=I[1],e[14]=I[2],e[15]=1}applyShaderTransformation(t,e){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){this._view.localTransform.getMat(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(I,this,t),e*=Math.max(I[0],I[1],I[2])),e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(I,this,t),e*=nt(I[0],I[1],I[2])),e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}setObjectAndLayerIdColor(t,e){this._view.objectAndLayerIdColor.setVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,l.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,l.VISIBLE)}setHighlight(t,e){const{_highlightOptionsMap:s}=this,i=s.get(t);e?e!==i&&(s.set(t,e),this._setStateFlag(t,l.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):i&&(s.delete(t),this._setStateFlag(t,l.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(t){return this._getStateFlag(t,l.HIGHLIGHT)}geHighlightOptionsPrev(t){const e=this._highlightOptionsMapPrev.get(t)??null;return this._highlightOptionsMapPrev.delete(t),e}getHighlightName(t){const e=this.highlightOptionsMap.get(t)??null;return e?this._highlightOptionsMapPrev.set(t,e):this._highlightOptionsMapPrev.delete(t),e}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let s=0;s<this._capacity;++s)this.getState(s)&t&&++e;return e}_setStateFlags(t,e){const s=this._view.state;e=s.get(t)|e,s.set(t,e)}_clearStateFlags(t,e){const s=this._view.state;e=s.get(t)&~e,s.set(t,e)}_setStateFlag(t,e,s){s?this._setStateFlags(t,e):this._clearStateFlags(t,e)}_getStateFlag(t,e){return!!(this._view.state.get(t)&e)}_grow(){this._capacity=Math.max(w,Math.floor(this._capacity*le)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new X(this._buffer)}_findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&l.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};function nt(t,e,s){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),s))}y([v({constructOnly:!0})],S.prototype,"shaderTransformation",void 0),y([v()],S.prototype,"_size",void 0),y([v({readOnly:!0})],S.prototype,"size",null),S=y([ue("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],S);const I=L(),T=Ce(),ee=F(),U=F();class rt extends B{constructor(e,s){super((i=>De(this._instanceData.view.boundingSphere.getVec(i,this._tmpSphere))),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=s,this._tmpSphere=we(),this._tmpMat4=F()}addInstance(e){const s=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);z(Fe(this._tmpSphere),this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*Ne(i),s.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class ht{constructor(e,s){this._worldSpaceRadius=e,this._minScreenSpaceRadii=s}selectLevel(e,s,i){const a=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*s/a;let r=0;for(let c=1;c<this._minScreenSpaceRadii.length;++c)n>=this._minScreenSpaceRadii[c]&&(r=c);return r}}let ot=class{constructor(e,s){const i=e.renderContext.rctx,a=s.geometry,n=s.geometry.getRenderGeometry(),r=n.material;this._materials=e.materials,r.setParameters({instancedDoublePrecision:!0}),this.geometry=a,this.material=r,this.glMaterials=new He(r,this._materials),this.vertexBufferLayout=n.vertexBufferLayout,this.vbo=he.createVertex(i,oe.STATIC_DRAW,n.buffer),this.vao=new Ve(i,G,new Map([["geometry",_e(n.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=n.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,s,i,a,n,r,c,h){return this.geometry.intersect(e,s,i,a,n,r,c,h)}};class P{static async create(e,s,i){const a=await Promise.allSettled(s.components.map((r=>e.controller.schedule((()=>new ot(e,r)),i)))),n=a.map((r=>r.status==="fulfilled"?r.value:null)).filter(ge);if(fe(i)||n.length!==a.length){n.forEach((r=>r.destroy())),pe(i);for(const r of a)if(r.status==="rejected")throw r.reason}return new P(s.minScreenSpaceRadius,n)}constructor(e,s){this.minScreenSpaceRadius=e,this.components=s}destroy(){this.components.forEach((e=>e.destroy()))}intersect(e,s,i,a,n,r,c){this.components.forEach((h=>h.intersect(e,s,i,a,n,r,this.boundingSphere,c)))}get boundingBox(){if(this._boundingBox==null){const e=$e();this.components.forEach((s=>{s.boundingInfo!=null&&(Y(e,s.boundingInfo.bbMin),Y(e,s.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,s=L();Ue(e,s),this._boundingSphere={center:s,radius:.5*Be(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,s)=>e+s.triangleCount),0)}}const lt=t=>{const e=t.baseBoundingSphere.radius,s=t.levels.map((i=>i.minScreenSpaceRadius));return new ht(e,s)};let A=class extends ze{constructor(t,e){super(t),this.type=Ge.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new Pe,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[N.OPAQUE_MATERIAL,s=>this._produces(s)],[N.TRANSPARENT_MATERIAL,s=>!!this._hasTransparentLevels()&&this._produces(s)]]),this._instanceData=new S({shaderTransformation:t.shaderTransformation},t.optionalFields),this.addHandles(e.registerTask(qe.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=dt(this.optionalFields),this._glInstanceBufferLayout=_e(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)})),this._instanceData.events.on("instance-visibility-changed",(({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDataMap.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDataMap)e[0]!==H&&t.push(e[1]);return t}hasHighlight(t){return this._highlightRenderInstanceDataMap.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some((t=>t.components.some((e=>e.material.hasEmissions))))}get usedMemory(){return this._allRenderInstanceData.reduce(((t,e)=>e.reduce(((s,i)=>s+i.usedMemory),t)),this._levels.reduce(((t,e)=>t+e.components.reduce(((s,i)=>s+i.usedMemory),0)),0))}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach(((s,i)=>{const a=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,n=s.triangleCount;e.push({renderedInstances:a,renderedTriangles:a*n,trianglesPerInstance:n})})),{totalInstances:t,renderedInstances:e.reduce(((s,i)=>s+i.renderedInstances),0),renderedTriangles:e.reduce(((s,i)=>s+i.renderedTriangles),0),levels:e}}_createRenderInstanceDataArray(t=[]){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map((s=>{t.push(new it(e,this._instanceBufferLayout))})),t}async initializeRenderContext(t,e){this._context=t,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const s=await Promise.allSettled(this.symbol.levels.map((a=>P.create(t,a,e)))),i=s.map((a=>a.status==="fulfilled"?a.value:null)).filter(ge);if(fe(e)||i.length!==s.length){i.forEach((a=>a.destroy())),pe(e);for(const a of s)if(a.status==="rejected")throw a.reason}this._levels=i,this._levelSelector=lt(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((t=>t.destroy())),this._defaultRenderInstanceData.forEach((t=>t.destroy())),this._highlightRenderInstanceDataMap.forEach((t=>t.forEach((e=>e.destroy()))))}_hasTransparentLevels(){return this._levels.some((t=>t.components.some((e=>{const s=e.material.produces.get(N.TRANSPARENT_MATERIAL);return s==null?void 0:s(C.Color)}))))}hasHighlights(){return je(this._highlightRenderInstanceDataMap,(t=>t.some((e=>e.size>0))))}_produces(t){return(t!==C.Highlight||this.hasHighlights())&&(t!==C.ShadowHighlight||this.hasHighlight(H))}prepareRender(t){if(!K.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(We),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const s=new Array,i=this.levels;return e.forEach((a=>i.forEach((({components:n},r)=>n.forEach((c=>s.push(this._beginComponent(t,a[r],c)))))))),s}render(t,e){const s=this._getInstanceDatas(t);if(!s||e==null)return;let i=0;t.rctx.bindVAO();const a=this.levels;s.forEach((n=>a.forEach((({components:r},c)=>r.forEach((h=>this._renderComponent(t,e[i++],n[c],h,c)))))))}_getInstanceDatas(t){var h;const{output:e,bind:s}=t,i=e===C.Highlight,a=e===C.ShadowHighlight,n=!i&&!a,r=e!==C.ShadowExcludeHighlight;if(n)return r?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDataMap:c}=this;if(r){if(i){const g=(h=s.highlight)==null?void 0:h.name;if(!g)return null;const d=c.get(g);return d?[d]:null}const u=c.get(H);return a?u?[u]:null:Array.from(c.values())}return null}intersect(t,e,s,i){if(!this.baseMaterial.visible||this._octree==null)return;const a=L();V(a,i,s);const n=r=>{this._instanceData.getCombinedModelTransform(r,ie),t.transform.set(ie),z(ae,s,t.transform.inverse),z(ne,i,t.transform.inverse);const c=this._instanceData.getState(r),h=this._instanceData.getLodLevel(r),u=this._levels.length;m((c&l.ACTIVE)!==0,"invalid instance state"),m(h>=0&&h<u,"invaid lod level"),this._levels[h].intersect(t,e,ae,ne,r,this.metadata,u)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(n):this._octree.forEachAlongRay(s,a,n)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){var t;if(this._octreeCached==null){const e=this._instanceData,s=(t=e.view)==null?void 0:t.state;if(!s)return null;this._octreeCached=new rt(e,this.baseBoundingSphere);for(let i=0;i<e.capacity;++i)s.get(i)&l.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=ke(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new $;const e=t.viewForward,s=this._octree.findClosest(e,B.DepthOrder.FRONT_TO_BACK,t.frustum),i=this._octree.findClosest(e,B.DepthOrder.BACK_TO_FRONT,t.frustum);if(s==null||i==null)return new $;const a=t.eye,n=this._instanceData.view;n.boundingSphere.getVec(s,b),V(b,b,a);const r=Q(b,e)-b[3];n.boundingSphere.getVec(i,b),V(b,b,a);const c=Q(b,e)+b[3];return new $(r,c)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((t=>t.forEach((e=>e.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:s,_levelSelector:i}=this;this._allRenderInstanceData.forEach((d=>d.forEach((f=>f.beginUpdate()))));const a=this._instanceData,n=a.view;let r=a.size;const c=a.capacity;let h=this._instanceIndex;const u=Math.ceil(c/500),{_highlightRenderInstanceDataMap:g}=this;for(let d=0;d<r&&!t.done;++d){h===this._cycleStartIndex&&this._startUpdateCycle();const f=n.state.get(h);let _=0;if(!(f&l.ALLOCATED)){h=h+1===c?0:h+1,r++;continue}const R=n.lodLevel.get(h);if(f&l.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[R].freeTail(),f&l.HIGHLIGHT_ACTIVE){const p=a.geHighlightOptionsPrev(h);if(p){const E=g.get(p);if(!E)throw new Z("internal:lod-renderer","Internal error in lodRenderer");E[R].freeTail(),E.every((O=>O.isEmpty))&&(E.forEach((O=>O.destroy())),g.delete(p))}}if(f&l.REMOVE)a.freeInstance(h);else if(f&l.VISIBLE){let p=0;if(e&&(n.modelOrigin.getVec(h,se),p=i.selectLevel(se,a.getCombinedMedianScaleFactor(h),s)),_=f&~(l.ACTIVE|l.TRANSFORM_CHANGED),p>=0)if(f&l.HIGHLIGHT){const E=a.getHighlightName(h);if(E){const O=()=>{const j=this._createRenderInstanceDataArray();return j.forEach((me=>me.beginUpdate())),j},q=Ye(g,E,O);if(p>=q.length)throw new Z("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${p}`);te(q[p],n,h)}_|=l.HIGHLIGHT_ACTIVE}else te(this._defaultRenderInstanceData[p],n,h),_|=l.DEFAULT_ACTIVE;n.state.set(h,_),n.lodLevel.set(h,p)}else _=f&~(l.ACTIVE|l.TRANSFORM_CHANGED),n.state.set(h,_);if(this._octreeCached!=null){const p=!!(f&l.ACTIVE),E=!!(_&l.ACTIVE);!p&&E?this._octreeCached.addInstance(h):p&&!E?this._octreeCached.removeInstance(h):p&&E&&f&l.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h))}h=h+1===c?0:h+1,h%u===0&&t.madeProgress()}this._instanceIndex=h,this._allRenderInstanceData.forEach((d=>d.forEach((f=>f.endUpdate())))),this._context.requestRender()}_beginComponent(t,e,s){if(e.size===0)return null;const i=s.glMaterials.load(t.rctx,t.bind.slot,t.output);return i==null?void 0:i.beginSlot(t.bind)}_renderComponent(t,e,s,i,a){if(!e)return;const{bind:n,rctx:r}=t;r.runAppleAmdDriverHelper();const c=r.bindTechnique(e,n,i.material.parameters,ut);r.bindVAO(i.vao),e.ensureAttributeLocations(i.vao),K.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===C.Color&&(c.setUniform4fv("externalColor",re[Math.min(a,re.length-1)]),c.setUniform1i("colorMixMode",Qe.replace));const h=s.capacity,u=s.headIndex,g=s.tailIndex,d=s.firstIndex,f=this._glInstanceBufferLayout,_=(R,p)=>{Ze(r,G,s.buffer,f,R),r.drawArraysInstanced(e.primitiveType,0,i.vertexCount,p-R),Xe(r,G,s.buffer,f)};i.material.transparent&&d!=null?u>g?(m(d>=g&&d<=u,"invalid firstIndex"),_(d,u),_(g,d)):u<g&&(d<=u?(m(d>=0&&d<=u,"invalid firstIndex"),_(d,u),_(g,h),_(0,d)):(m(d>=g&&d<=h,"invalid firstIndex"),_(d,h),_(0,u),_(g,d))):u>g?_(g,u):u<g&&(_(0,u),_(g,h)),r.bindVAO(null)}};function te(t,e,s){const i=t.allocateHead();ct(e,s,t.view,i)}function ct(t,e,s,i){et(t.modelOrigin,e,s.modelOriginHi,s.modelOriginLo,i),s.model.copyFrom(i,t.model,e),s.modelNormal.copyFrom(i,t.modelNormal,e),t.color&&s.color&&s.color.copyFrom(i,t.color,e),t.objectAndLayerIdColor&&s.objectAndLayerIdColor&&s.objectAndLayerIdColor.copyFrom(i,t.objectAndLayerIdColor,e),t.featureAttribute&&s.featureAttribute&&s.featureAttribute.copyFrom(i,t.featureAttribute,e)}function dt(t){let e=de().vec3f(o.INSTANCEMODELORIGINHI).vec3f(o.INSTANCEMODELORIGINLO).mat3f(o.INSTANCEMODEL).mat3f(o.INSTANCEMODELNORMAL);return t!=null&&t.includes("featureAttribute")&&(e=e.vec4f(o.INSTANCEFEATUREATTRIBUTE)),t!=null&&t.includes("color")&&(e=e.vec4u8(o.INSTANCECOLOR)),t!=null&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(o.INSTANCEOBJECTANDLAYERIDCOLOR)),e}y([v({constructOnly:!0})],A.prototype,"symbol",void 0),y([v({constructOnly:!0})],A.prototype,"optionalFields",void 0),y([v({constructOnly:!0})],A.prototype,"metadata",void 0),y([v({constructOnly:!0})],A.prototype,"shaderTransformation",void 0),y([v()],A.prototype,"_instanceData",void 0),y([v()],A.prototype,"_cycleStartIndex",void 0),y([v({readOnly:!0})],A.prototype,"_enableLevelSelection",null),y([v()],A.prototype,"_updateCyclesWithStaticCamera",void 0),y([v({readOnly:!0})],A.prototype,"running",null),A=y([ue("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],A);const se=L(),b=Je(),ie=F(),ae=L(),ne=L(),re=[M(1,0,1,1),M(0,0,1,1),M(0,1,0,1),M(1,1,0,1),M(1,0,0,1)],ut=new Ke;export{A as k};
