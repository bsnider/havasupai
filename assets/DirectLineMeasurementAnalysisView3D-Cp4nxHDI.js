import{e as Z,ap as P,av as $,bW as He,FP as je,xV as ge,xU as Ie,eW as x,r as n,m as r,d as Q,vj as Ne,EK as Fe,ET as X,aZ as V,ER as k,FT as ee,rR as Y,EV as We,EW as ke,_ as Ue,l6 as Be,EY as Qe,F1 as qe,Fy as Ke,pt as Ye,FU as Je,F9 as Ze,Fb as me,dI as Xe,pC as ve,F8 as _e,Ff as et,aO as te,Fg as tt,dH as it,aT as ie,aU as C,eJ as se,fm as De,eI as ze,n7 as st,j3 as ne,h6 as nt,aP as B,vO as ye,GC as de,aR as we,mp as at,u as O,fO as q,GD as rt,fq as ot,fy as lt,fR as ut,zh as dt,GE as ht,g2 as be,x2 as Te,f$ as he,BK as ct,g0 as fe,xS as pt,y4 as gt,c as J,aW as mt,aV as vt,GF as _t,FV as yt,iw as wt,y5 as bt,pd as xe,pg as ae,uC as Pe,pb as pe,d_ as ft,ab as Le,fA as Pt,Gi as Lt,mm as Ct,h as St,kj as Ot,cQ as Vt,x$ as Mt,qj as Ce,FQ as At,fv as Et,aL as $t,FY as Dt,el as zt,xY as Tt}from"./index-CA3J3HgS.js";import{o as xt,s as Rt,m as Gt,f as Ht,d as jt}from"./analysisViewUtils-ByB4WbjG.js";import{e as j,w as It}from"./measurementUtils-BEDr_sNv.js";import{r as Nt,t as Ft,c as Wt,d as K,e as Se,f as kt,a as Ut}from"./ShadedColorMaterial.glsl-Cymxbvoz.js";import{g as re,j as Bt,y as Oe,w as Qt,d as Ve}from"./quantityFormatUtils-By702LDR.js";import{f as oe,_ as Me,m as U,C as Ae}from"./Segment-CnBLrWDx.js";import{y as qt,R as Kt}from"./SnappingVisualizer3D-CnGxe5yx.js";import{h as le}from"./lineStippleUtils-C89mzWlO.js";import{q as Yt,z as Jt,B as Zt}from"./dragEventPipeline3D-YVtzEDK2.js";import{c as Xt}from"./LaserlinePath.glsl-tX9JW1lg.js";import{E as ei,p as ti,P as ii}from"./EditGeometryOperations-BY_V0Ut9.js";import{p as si,h as ni}from"./InteractiveToolBase-DQaQisMs.js";import{e as ai}from"./SnappingContext-BZxcjOAq.js";import{f as ri}from"./SnappingDragPipelineStep-B6VMNBwh.js";import{a as oi}from"./SnappingManagerPool-B8wCjH2V.js";import"./VisualElement-BpS0n3Cc.js";import"./line-BqspC9Dq.js";import"./ColorMaterial.glsl-C2JDMCay.js";import"./TriangleMaterial-BmOrBe-u.js";import"./ExtendedLineVisualElement-DEodAX6q.js";import"./EngineVisualElement-CM4Zn-kb.js";import"./PointVisualElement-Bt-_VNXg.js";import"./PointSnappingHint-BeDdqDAP.js";import"./dehydratedFeatureComparison-CiK2oDXJ.js";let H=class extends Z{constructor(t){super(t)}initialize(){this.addHandles([P((()=>({viewData:this.viewData,startPoint:this.analysis.startPoint})),(({viewData:t,startPoint:i})=>{t.elevationAlignedStartPoint=this._applyProjectionAndElevationAlignment(i)}),$),P((()=>({viewData:this.viewData,endPoint:this.analysis.endPoint})),(({viewData:t,endPoint:i})=>{t.elevationAlignedEndPoint=this._applyProjectionAndElevationAlignment(i)}),$),P((()=>({result:this._computedResult,viewData:this.viewData})),(({result:t,viewData:i})=>{i.result=t}),$)])}_applyProjectionAndElevationAlignment(t){if(t==null)return t;const{spatialReference:i,elevationProvider:s}=this.view;return Nt(t,i,s)??(Ft(this.analysis,t.spatialReference,He.getLogger(this)),null)}get _computedResult(){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,measurementMode:s,unit:o}=this.viewData;if(t==null||i==null)return null;const a=je(t,i),p=this.geodesicLengthMeasurementUtils.geodesicDistanceBetweenPoints(t,i);if(a==null)return null;let u,h;switch(s){case j.Auto:h=p!=null?"geodesic":"euclidean",u=p??a.horizontal;break;case j.Geodesic:if(p==null)return null;h="geodesic",u=p;break;case j.Euclidean:h="euclidean",u=a.horizontal}let d=a.direct,l=a.vertical;const c=ge(d.value,d.unit,o),m=ge(u.value,u.unit,o),g=Ie(l.value,l.unit,o);return d=x(d,c),u=x(u,m),l=x(l,g),{mode:h,directDistance:d,horizontalDistance:u,verticalDistance:l}}};n([r({constructOnly:!0})],H.prototype,"view",void 0),n([r({constructOnly:!0})],H.prototype,"analysis",void 0),n([r({constructOnly:!0})],H.prototype,"viewData",void 0),n([r({constructOnly:!0})],H.prototype,"geodesicLengthMeasurementUtils",void 0),n([r()],H.prototype,"_computedResult",null),H=n([Q("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementController")],H);var y,E;(function(e){e[e.None=0]="None",e[e.Direct=1]="Direct",e[e.Triangle=2]="Triangle",e[e.ProjectedGeodesic=3]="ProjectedGeodesic"})(y||(y={})),(function(e){e[e.Auto=0]="Auto",e[e.AboveSegment=1]="AboveSegment",e[e.BelowSegment=2]="BelowSegment"})(E||(E={}));function Re(e){const t=new Ne,{vertex:i,fragment:s}=t;Fe(i,e),i.uniforms.add(new X("width",(a=>a.width))),t.attributes.add(V.POSITION,"vec3"),t.attributes.add(V.NORMAL,"vec3"),t.attributes.add(V.UV0,"vec2"),t.attributes.add(V.LENGTH,"float"),t.varyings.add("vtc","vec2"),t.varyings.add("vlength","float"),t.varyings.add("vradius","float"),i.main.add(k`vec3 bitangent = normal;
vtc = uv0;
vlength = length;
vradius = 0.5 * width;
vec4 pos = view * vec4(position + vradius * bitangent * uv0.y, 1.0);
gl_Position = proj * pos;`),s.uniforms.add(new X("outlineSize",(a=>a.outlineSize)),new ee("outlineColor",(a=>a.outlineColor)),new X("stripeLength",(a=>a.stripeLength)),new ee("stripeEvenColor",(a=>a.stripeEvenColor)),new ee("stripeOddColor",(a=>a.stripeOddColor)));const o=1/Math.sqrt(2);return s.code.add(k`
    const float INV_SQRT2 = ${k.float(o)};

    vec4 arrowColor(vec2 tc, float len) {
      float d = INV_SQRT2 * (tc.x - abs(tc.y));
      d = min(d, INV_SQRT2 * (len - tc.x - abs(tc.y)));
      d = min(d, 1.0 - abs(tc.y));

      if (d < 0.0) {
        return vec4(0.0);
      }
      if (d < outlineSize) {
        return outlineColor;
      }
      return fract(0.5 / stripeLength * tc.x * vradius) >= 0.5 ? stripeOddColor : stripeEvenColor;
    }`),s.main.add(k`
    vec2 ntc = vec2(vtc.x / vradius, vtc.y);
    vec4 color = arrowColor(ntc, vlength / vradius);
    if (color.a < ${k.float(Y)}) {
      discard;
    }
    fragColor = color;`),t}const li=Object.freeze(Object.defineProperty({__proto__:null,build:Re},Symbol.toStringTag,{value:"Module"}));class ui extends We{constructor(t,i){super(t,i,new ke(li,(()=>Ue(()=>Promise.resolve().then(()=>Ai),void 0))),Ge),this.primitiveType=Be.TRIANGLE_STRIP}initializePipeline(t){return Qe({blending:t.transparent?Je(t.oitPass):null,polygonOffset:t.polygonOffsetEnabled?{factor:0,units:-4}:null,depthTest:{func:Ye.LESS},depthWrite:Ke,colorWrite:qe})}}const Ge=new Map([[V.POSITION,0],[V.NORMAL,1],[V.UV0,2],[V.LENGTH,3]]);class ce extends Ze{constructor(){super(...arguments),this.polygonOffsetEnabled=!1,this.transparent=!1}}n([me()],ce.prototype,"polygonOffsetEnabled",void 0),n([me()],ce.prototype,"transparent",void 0);class di extends Xe{constructor(t){super(t,ci),this._configuration=new ce,this.vertexAttributeLocations=Ge,this.intersectDraped=void 0,this.produces=new Map([[ve.OPAQUE_MATERIAL,i=>!this._transparent&&_e(i)],[ve.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,i=>this._transparent&&_e(i)]])}getConfiguration(t,i){return super.getConfiguration(t,i,this._configuration),this._configuration.polygonOffsetEnabled=this.parameters.polygonOffset,this._configuration.transparent=this._transparent,this._configuration.oitPass=i.oitPass,this._configuration}get visible(){const{outlineColor:t,stripeEvenColor:i,stripeOddColor:s}=this.parameters;return t[3]>=Y||i[3]>=Y||s[3]>=Y}intersect(){}createGLMaterial(t){return new hi(t)}createBufferWriter(){return new wi}get _transparent(){const{parameters:t}=this;return t.outlineColor[3]<1||t.stripeEvenColor[3]<1||t.stripeOddColor[3]<1}}let hi=class extends tt{beginSlot(t){return this.getTechnique(ui,t)}},ci=class extends et{constructor(){super(...arguments),this.width=32,this.outlineSize=.2,this.outlineColor=te(1,.5,0,1),this.stripeEvenColor=te(1,1,1,1),this.stripeOddColor=te(1,.5,0,1),this.stripeLength=1,this.polygonOffset=!1}};const pi=it().vec3f(V.POSITION).vec3f(V.NORMAL).vec2f(V.UV0).f32(V.LENGTH),gi=C(),mi=C(),vi=C(),_i=C(),yi=C();class wi{constructor(){this.vertexBufferLayout=pi}elementCount(t){return 2*(t.get(V.POSITION).indices.length/2+1)}write(t,i,s,o,a,p){const{data:u,indices:h}=s.get(V.POSITION),d=s.get(V.NORMAL).data,l=u.length/3;h&&h.length!==2*(l-1)&&console.warn("MeasurementArrowMaterial does not support indices");const c=gi,m=mi,g=vi,M=_i,A=yi,D=a.position,z=a.normal,R=a.uv0;let G=0;for(let S=0;S<l;++S){const I=3*S;if(ie(c,u[I],u[I+1],u[I+2]),S<l-1){const f=3*(S+1);ie(m,u[f],u[f+1],u[f+2]),ie(A,d[f],d[f+1],d[f+2]),se(A,A),De(g,m,c),se(g,g),ze(M,A,g),se(M,M)}const N=st(c,m);t&&i&&(ne(c,c,t),ne(m,m,t),ne(M,M,i));const T=p+2*S,L=T+1;D.setVec(T,c),D.setVec(L,c),z.setVec(T,M),z.setVec(L,M),R.set(T,0,G),R.set(T,1,-1),R.set(L,0,G),R.set(L,1,1),S<l-1&&(G+=N)}const W=a.length;for(let S=0;S<2*l;++S)W.set(p+S,G);return null}}class bi extends Wt{constructor(t){super(t),this._arrowWidth=16,this._arrowSubdivisions=128,this._origin=C(),this._originTransform=nt(),this._arrowCenter=C(),this._renderOccluded=B.OccludeAndTransparent,this._geometry=null,this._stripeLength=1,this._stripesEnabled=!0,this._color=ye(),this._contrastColor=ye(),this.applyProperties(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){var i;t!==this._renderOccluded&&(this._renderOccluded=t,(i=this._arrowMaterial)==null||i.setParameters({renderOccluded:t}))}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this._geometryChanged()}get stripeLength(){return this._stripeLength}set stripeLength(t){this._stripeLength=t,this.attached&&this._arrowMaterial.setParameters({stripeLength:this._stripeLength})}get stripesEnabled(){return this._stripesEnabled}set stripesEnabled(t){if(this._stripesEnabled=t,this.attached){const i=this._stripesEnabled?this._contrastColor:this._color;this._arrowMaterial.setParameters({stripeEvenColor:i})}}get color(){return this._color}set color(t){de(t,this._color)||(we(this._color,t),this._updateArrowColor())}get contrastColor(){return this._contrastColor}set contrastColor(t){de(t,this._color)||(we(this._contrastColor,t),this._updateArrowColor())}createExternalResources(){const t=this._color,i=this._contrastColor,s=this._stripesEnabled?i:t;this._arrowMaterial=new di({outlineColor:t,stripeEvenColor:s,stripeOddColor:t,renderOccluded:this.renderOccluded,polygonOffset:!0,isDecoration:this.isDecoration}),this._handles=new at,this._handles.add(P((()=>this.view.state.camera),(()=>{this._viewChanged()})))}destroyExternalResources(){this._arrowMaterial=null,this._handles=O(this._handles)}forEachMaterial(t){t(this._arrowMaterial)}createGeometries(t){var s;if(((s=this._geometry)==null?void 0:s.startRenderSpace)==null||this._geometry.endRenderSpace==null)return;const i=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);i.transformation=this._originTransform,t.addGeometry(i),this._viewChanged()}_createArrowGeometry(t,i,s,o){const a=this.view,p=a.renderCoordsHelper,u=[],h=[],d=(l,c)=>{const m=q.get();De(m,l,s),u.push(m),h.push(c)};if(o.type==="euclidean"){o.eval(.5,this._arrowCenter);const l=q.get();if(p.worldUpAtPosition(this._arrowCenter,l),fi(t,i,l)){const{heading:c,tilt:m}=a.camera,{direction:g}=rt(a,t,c,m,Pi);ot(l,g)}d(t,l),d(i,l)}else{o.eval(.5,this._arrowCenter);const l=this._arrowSubdivisions+1&-2;for(let c=0;c<l;++c){const m=c/(l-1),g=q.get(),M=q.get();o.eval(m,g),p.worldUpAtPosition(g,M),d(g,M)}}return lt(this._arrowMaterial,u,h)}_geometryChanged(){this.recreateGeometry()}_viewChanged(){if(this.view.ready&&this.attached&&this._geometry!=null){const t=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameters({width:this._arrowWidth*t})}}_updateArrowColor(){if(!this.attached)return;const t=this._color,i=this._contrastColor,s=this._stripesEnabled?i:t,o=t,a=t;this._arrowMaterial.setParameters({stripeEvenColor:s,outlineColor:o,stripeOddColor:a})}}function fi(e,t,i){const s=ut(Ee,t,e),o=ze(Ee,s,i);return dt(o)===0}const Ee=C(),Pi=ht();let w=class extends Z{get _parameters(){const e=this.view.effectiveTheme,{accentColor:t,textColor:i}=e,s=be(t),o=Te(t,.75),a=be(he(t)),p=he(i,ct.Low);return{accentColor:s,contrastColor:a,translucentAccentColor:o,triangleLineWidth:3,geodesicProjectionLineWidth:2,guideLineWidth:2,guideStippleLengthPixels:3,directLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12,textColor:i,textBackgroundColor:fe(p,.6),textCalloutColor:fe(p,.5)}}get visible(){return this.analysisView.visible}get viewMode(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView;if(e==null||t==null||e.equals(t))return y.None;const i=this.analysisView.result;if(i==null)return y.Direct;if(this.actualVisualizedMeasurement==="geodesic")return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?y.ProjectedGeodesic:y.Direct;const{verticalDistance:s,horizontalDistance:o}=i,a=x(s,"meters").value,p=x(o,"meters").value;return Math.min(a/p,p/a)<this.triangleCollapseRatioThreshold?y.Direct:y.Triangle}get actualVisualizedMeasurement(){const{measurementMode:e,result:t}=this.analysisView;switch(e){case j.Auto:return t!=null&&x(t.horizontalDistance,"meters").value>pt?"geodesic":"euclidean";case j.Euclidean:return"euclidean";case j.Geodesic:return"geodesic"}}get allowVisualElementsOrientationChange(){return this._triangleOrientationOverride==null}set allowVisualElementsOrientationChange(e){this._triangleOrientationOverride==null!==e&&(this._triangleOrientationOverride==null?this._triangleOrientationOverride=this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}get labels(){return this.actualVisualizedMeasurement==="geodesic"?{direct:null,horizontal:this._segmentLabel,vertical:this._verticalLabel}:{direct:this._segmentLabel,horizontal:this._horizontalLabel,vertical:this._verticalLabel}}constructor(e){super(e),this._segmentVisualElement=null,this._triangleVisualElement=null,this._rightAngleQuad=null,this._projectedGeodesicLine=null,this._geodesicStartHint=null,this._geodesicEndHint=null,this._segmentLabel=null,this._verticalLabel=null,this._horizontalLabel=null,this._startPosition=C(),this._endPosition=C(),this._cornerPosition=C(),this._startPositionAtSeaLevel=C(),this._endPositionAtSeaLevel=C(),this._triangleOrientationOverride=null,this.messages=null,this.loadingMessages=!0,this.visualElementOrientation=E.Auto,this.triangleCollapseRatioThreshold=.03}initialize(){const e={attached:!0,view:this.view,isDecoration:!0},{guideLineWidth:t,guideStippleLengthPixels:i,triangleLineWidth:s,geodesicProjectionLineWidth:o,directLabelFontSize:a,verticalLabelFontSize:p,horizontalLabelFontSize:u}=this._parameters;this._segmentVisualElement=new bi({...e,geometry:null,renderOccluded:B.OccludeAndTransparent}),this._triangleVisualElement=new K({...e,width:s,renderOccluded:B.OccludeAndTransparent}),this._rightAngleQuad=new qt({...e,renderOccluded:B.OccludeAndTransparent});const h={...e,polygonOffset:!0,renderOccluded:B.OccludeAndTransparent};this._projectedGeodesicLine=new K({...h,width:o,stipplePattern:le(i)}),this._geodesicStartHint=new K({...h,width:t,stipplePattern:le(i)}),this._geodesicEndHint=new K({...h,width:t,stipplePattern:le(i)}),this._segmentLabel=new oe({...e,fontSize:a}),this._verticalLabel=new oe({...e,fontSize:p}),this._horizontalLabel=new oe({...e,fontSize:u}),this.addHandles([P((()=>{const{elevationAlignedStartPoint:d,elevationAlignedEndPoint:l}=this.analysisView,c=this.view;return{view:c,camera:c.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:d,elevationAlignedEndPoint:l,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}}),(d=>this._updateGeometryAndViewMode(d)),$),P((()=>({visible:this.visible,viewMode:this.viewMode})),(d=>this._updateVisualElementVisibility(d)),$),P((()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement})),(d=>this._updateLabelText(d)),$),P((()=>({visible:this.visible,viewMode:this.viewMode})),(d=>this._updateLabelVisibility(d)),$),P((()=>this._measurementArrowStripeLength),(d=>this._updateSegmentStripeLength(d)),$),gt((async()=>this._updateMessageBundle())),P((()=>this._parameters),(({textBackgroundColor:d,textCalloutColor:l,textColor:c,translucentAccentColor:m,accentColor:g,contrastColor:M})=>{const{_segmentLabel:A,_verticalLabel:D,_horizontalLabel:z,_triangleVisualElement:R,_rightAngleQuad:G,_projectedGeodesicLine:W,_geodesicStartHint:S,_geodesicEndHint:I,_segmentVisualElement:N}=this;A.backgroundColor=d,A.calloutColor=l,A.textColor=c,D.backgroundColor=d,D.calloutColor=l,D.textColor=c,z.backgroundColor=d,z.calloutColor=l,z.textColor=c,R.color=m,G.color=m,W.color=m,S.color=m,I.color=m,N.color=g,N.contrastColor=M}),J)]),this._updateMessageBundle()}destroy(){this._segmentVisualElement=O(this._segmentVisualElement),this._triangleVisualElement=O(this._triangleVisualElement),this._rightAngleQuad=O(this._rightAngleQuad),this._projectedGeodesicLine=O(this._projectedGeodesicLine),this._geodesicStartHint=O(this._geodesicStartHint),this._geodesicEndHint=O(this._geodesicEndHint),this._segmentLabel=O(this._segmentLabel),this._verticalLabel=O(this._verticalLabel),this._horizontalLabel=O(this._horizontalLabel),this.set("view",null)}_updateVisualElementVisibility({visible:e,viewMode:t}){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,e)switch(t){case y.None:break;case y.Direct:this._segmentVisualElement.visible=!0;break;case y.Triangle:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case y.ProjectedGeodesic:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}}_updateGeometryAndViewMode({view:e,camera:t,viewMode:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:o,orientation:a,visualizedMeasurement:p,stripeLength:u}){const h=e.renderCoordsHelper;if(h==null||s==null||o==null||s.equals(o))return;let d=this._startPosition,l=this._endPosition;h.toRenderCoords(s,d),h.toRenderCoords(o,l);const c=a===E.AboveSegment?1:-1,m=c*(h.getAltitude(l)-h.getAltitude(d));m<0&&(d=this._endPosition,l=this._startPosition);const g=p==="geodesic"?new Me(this._startPosition,this._endPosition,h.spatialReference):new U(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=g,this._updateSegmentStripeLength(u),i){case y.Direct:this._updateSegment(g,a);break;case y.Triangle:this._updateSegmentAndTriangle({view:e,camera:t,segment:g,orientation:a,startPosition:d,endPosition:l,deltaSign:c,altitudeDelta:m});break;case y.ProjectedGeodesic:this._updateSegmentAndProjection({view:e,orientation:a,startPosition:d,endPosition:l})}}_updateSegment(e,t){this._segmentLabel.anchor=t===E.AboveSegment?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"}}_updateSegmentAndTriangle({view:{renderCoordsHelper:e},camera:t,segment:i,orientation:s,startPosition:o,endPosition:a,deltaSign:p,altitudeDelta:u}){const h=this._cornerPosition;e.worldUpAtPosition(o,h),mt(h,h,p*Math.abs(u)),vt(h,h,o),this._triangleVisualElement.geometry=[[[o[0],o[1],o[2]],[h[0],h[1],h[2]],[a[0],a[1],a[2]]]],this._rightAngleQuad.geometry={previous:o,center:h,next:a};const d=new U(o,h),l=new U(h,a),c=Li(o,a,h,s,t);this._segmentLabel.anchor=c.segment,this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:d,sampleLocation:"center"},this._verticalLabel.anchor=c.vertical,this._horizontalLabel.geometry={type:"segment",segment:l,sampleLocation:"center"},this._horizontalLabel.anchor=c.horizontal}_updateSegmentAndProjection({view:{renderCoordsHelper:e},orientation:t,startPosition:i,endPosition:s}){e.setAltitude(this._startPositionAtSeaLevel,0,i),e.setAltitude(this._endPositionAtSeaLevel,0,s);const o=new Me(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,e.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(o),this._geodesicStartHint.setGeometryFromSegment(new U(this._startPositionAtSeaLevel,i)),this._geodesicEndHint.setGeometryFromSegment(new U(this._endPositionAtSeaLevel,s)),this._segmentLabel.geometry={type:"segment",segment:o,sampleLocation:"center"},this._segmentLabel.anchor=t===E.AboveSegment?"top":"bottom"}_updateLabelText({text:e,visualizedMeasurement:t}){e!=null?(this._segmentLabel.text=t==="euclidean"?e.directDistance:e.horizontalDistance,this._horizontalLabel.text=e.horizontalDistance,this._verticalLabel.text=e.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null),this.notifyChange("labels")}_updateLabelVisibility({visible:e,viewMode:t}){const i=this._segmentLabel,s=this._horizontalLabel,o=this._verticalLabel;if(i.visible=!1,s.visible=!1,o.visible=!1,e)switch(t){case y.Direct:i.visible=!0;break;case y.Triangle:i.visible=!0,s.visible=!0,o.visible=!0;break;case y.ProjectedGeodesic:i.visible=!0;case y.None:}}get _labelsText(){if(this.destroyed)return null;const e=this.messages,t=this.analysisView.result;if(t==null||e==null)return null;const{directDistance:i,horizontalDistance:s,verticalDistance:o}=t,a=this.analysisView.unit,p=u=>({directDistance:"",horizontalDistance:"",verticalDistance:"",...u});switch(a){case"metric":return p({directDistance:i&&Ve(e,i),horizontalDistance:s&&Ve(e,s),verticalDistance:o&&Qt(e,o)});case"imperial":return p({directDistance:i&&Oe(e,i),horizontalDistance:s&&Oe(e,s),verticalDistance:o&&Bt(e,o)});default:return p({directDistance:i&&re(e,i,a),horizontalDistance:s&&re(e,s,a),verticalDistance:o&&re(e,o,a)})}}_updateSegmentStripeLength(e){const t=this._segmentVisualElement;e!=null?(t.stripeLength=e,t.stripesEnabled=!0):t.stripesEnabled=!1}get _actualVisualElementsOrientation(){if(this._triangleOrientationOverride!=null)return this._triangleOrientationOverride;const e=this.visualElementOrientation;return e===E.Auto?this.view.state.camera.aboveGround?E.AboveSegment:E.BelowSegment:e}_requiresGeodesicGuideAt(e){const t=this.view;if(!(t!=null&&t.state))return!1;const i=t.state.camera,s=t.renderCoordsHelper;if(!s)return!1;const o=i.computeScreenPixelSizeAt(e);return s.getAltitude(e)/o>=10}get _measurementArrowStripeLength(){const{result:e,unit:t}=this.analysisView;if(e==null)return null;let i=null;const s=e.directDistance;switch(t){case"metric":i=s&&x(s,"meters");break;case"imperial":i=s&&x(s,_t(s.value,s.unit));break;default:i=s&&x(s,t)}return i==null?null:yt(i.value/30)*wt(1,i.unit,"meters")}_updateMessageBundle(){this.loadingMessages=!0,bt("esri/core/t9n/Units").then((e=>{this.messages=e})).finally((()=>{this.loadingMessages=!1}))}get testData(){}};function Li(e,t,i,s,o){const a=Ci,p=Si;o.projectToRenderScreen(i,a),o.projectToRenderScreen(t,p);const u={segment:"bottom",horizontal:"top",vertical:a[0]<p[0]?"left":"right"};{const h=Oi,d=Vi;if(ae(e,i,o,h),ae(e,t,o,d),Pe(h,d)>=$e){const l=Math.sign(h[1])===Math.sign(d[1]);u.segment=l?Ae(u.vertical):u.vertical}else{const l=Mi;ae(i,t,o,l),Pe(l,d)>=$e&&(u.segment=Math.sign(l[0])===Math.sign(d[0])?Ae(u.horizontal):u.horizontal)}}if(s===E.BelowSegment){const h=d=>d==="top"?"bottom":"top";u.segment=h(u.segment),u.horizontal=h(u.horizontal),u.vertical=h(u.vertical)}return u}n([r()],w.prototype,"_parameters",null),n([r()],w.prototype,"_triangleOrientationOverride",void 0),n([r()],w.prototype,"messages",void 0),n([r()],w.prototype,"view",void 0),n([r()],w.prototype,"analysis",void 0),n([r()],w.prototype,"analysisView",void 0),n([r()],w.prototype,"loadingMessages",void 0),n([r()],w.prototype,"visible",null),n([r()],w.prototype,"viewMode",null),n([r()],w.prototype,"actualVisualizedMeasurement",null),n([r()],w.prototype,"visualElementOrientation",void 0),n([r()],w.prototype,"triangleCollapseRatioThreshold",void 0),n([r()],w.prototype,"allowVisualElementsOrientationChange",null),n([r()],w.prototype,"labels",null),n([r()],w.prototype,"_labelsText",null),n([r()],w.prototype,"_actualVisualElementsOrientation",null),n([r()],w.prototype,"_measurementArrowStripeLength",null),w=n([Q("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],w);const $e=Math.cos(ft(12)),Ci=xe(),Si=xe(),Oi=pe(),Vi=pe(),Mi=pe();var F;(function(e){e.Manipulators="manipulators",e.AnalysisViewDestroyed="analysis-view-destroyed",e.AnalysisView="analysis-view"})(F||(F={}));let _=class extends Z{constructor(e){super(e),this.cursorPoint=null,this._visible=!1,this._laserLine=null,this.laserLineEnabled=!0,this._lastDraggedHandle=null}initialize(){this._laserLine=new Xt({view:this.view,attached:!0,isDecoration:!0}),this._updateVisibility(this._visible),this._connectToAnalysisView(),this.addHandles(P((()=>this._params),(({laserLineGlowColor:e,laserLineInnerColor:t,laserLineGlobalAlpha:i})=>{const s=this._laserLine,o=s.style;s.style={...o,innerColor:t,glowColor:e,globalAlpha:i}})))}destroy(){this._laserLine=O(this._laserLine)}get _params(){const{accentColor:e}=this.view.effectiveTheme;return{laserLineGlowColor:Le.toUnitRGB(e),laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:Le.toUnitRGB(he(e)),laserLineInnerWidth:.75,laserLineGlobalAlpha:.75*e.a,handleColor:Te(e,.5),handleRadius:5}}get visible(){return this._visible}set visible(e){e?this.show():this.hide()}get testData(){}get _cursorPosition(){const e=C(),t=this.cursorPoint;return t&&this.view.renderCoordsHelper.toRenderCoords(t,e),e}get _startPosition(){const e=C(),t=this.analysis.startPoint;return t&&this.view.renderCoordsHelper.toRenderCoords(t,e),e}get _endPosition(){const e=C(),t=this.analysis.endPoint;return t&&this.view.renderCoordsHelper.toRenderCoords(t,e),e}get _laserLineParams(){const e=this._focusPosition,{active:t,lineState:i}=this.toolState,s=this.analysisViewData,o=this.laserLineEnabled&&!!e&&i!=="measured"&&t;if(!o||!this.visible||s==null||s.destroyed)return{heightManifoldTarget:null,pointDistanceLine:null,lineVerticalPlaneSegment:null};const a=s.actualVisualizedMeasurement,p=this.view.viewingMode!=="local"&&o&&!!this.analysis.startPoint&&a==="geodesic",u=o&&s.viewMode===y.Triangle;return{heightManifoldTarget:a==="euclidean"?e:null,pointDistanceLine:p?this._pointDistanceLine:null,lineVerticalPlaneSegment:u?Pt(this._startPosition,this._endPosition):null}}get _focusPosition(){const{lineState:e}=this.toolState,t=this.analysisViewData,i=t!=null&&!t.destroyed&&t.measurementMode===j.Euclidean&&t.viewMode===y.Direct;switch(e){case"drawing":return i?this._startPosition:this.analysis.endPoint?this._endPosition:this._startPosition;case"editing":return i?this._lastDraggedHandle==="start"?this._endPosition:this._startPosition:this._lastDraggedHandle==="start"?this._startPosition:this._endPosition;default:return this.cursorPoint!=null?this._cursorPosition:null}}get _pointDistanceLine(){return{origin:this.toolState.lineState==="drawing"||this._lastDraggedHandle==="end"?this._startPosition:this._endPosition,target:this._focusPosition}}createManipulators(){const e=this._params,{view:t}=this,i=()=>{const c=kt(e.handleColor),m=[new Ut(Ct(c,1,32,32))],g=new Se({view:t,renderObjects:m});return g.available=!1,g.radius=e.handleRadius,[g,c]},[s,o]=i(),[a,p]=i(),u=new Se({view:this.view,available:!1,interactive:!1});this.analysis.startPoint!=null&&(s.location=this.analysis.startPoint,s.available=!0),this.analysis.endPoint!=null&&(a.location=this.analysis.endPoint,a.available=!0);const h=()=>{let c=this._lastDraggedHandle;s.grabbing&&!a.grabbing&&(c="start"),a.grabbing&&!s.grabbing&&(c="end"),s.grabbing||a.grabbing||(c=null),this._lastDraggedHandle=c},d=s.events.on("grab-changed",h),l=a.events.on("grab-changed",h);return this.addHandles([d,l,P((()=>Lt(this._params.handleColor)),(c=>{o.setParameters({color:c}),p.setParameters({color:c})}),{equals:de})],F.Manipulators),{start:s,end:a,cursor:u}}show(){this.destroyed||this._visible||this._updateVisibility(!0)}hide(){!this.destroyed&&this._visible&&this._updateVisibility(!1)}_connectToAnalysisView(){this.removeHandles(F.AnalysisView),this.addHandles([P((()=>{var e;return(e=this.analysisViewData)==null?void 0:e.destroyed}),(e=>{e&&this.removeHandles(F.AnalysisView)}),J),P((()=>[this.toolState.lineState==="measured",this.analysisViewData]),(([e,t])=>{t==null||t.destroyed||(t.allowVisualElementsOrientationChange=!e)}),J),P((()=>this._laserLineParams),(e=>{const t=this._laserLine;t.heightManifoldTarget=e.heightManifoldTarget,t.pointDistanceLine=e.pointDistanceLine,t.lineVerticalPlaneSegment=e.lineVerticalPlaneSegment}),J)],F.AnalysisView)}_updateVisibility(e){this.initialized&&(this._visible=e,e?this._laserLine.style={innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,glowFalloff:this._params.laserLineGlowFalloff,globalAlpha:this._params.laserLineGlobalAlpha}:this.view.cursor=null,this._laserLine.visible=e)}};n([r({constructOnly:!0})],_.prototype,"view",void 0),n([r()],_.prototype,"_params",null),n([r({constructOnly:!0})],_.prototype,"analysis",void 0),n([r({constructOnly:!0})],_.prototype,"analysisViewData",void 0),n([r()],_.prototype,"cursorPoint",void 0),n([r()],_.prototype,"toolState",void 0),n([r()],_.prototype,"visible",null),n([r()],_.prototype,"testData",null),n([r()],_.prototype,"_visible",void 0),n([r()],_.prototype,"_laserLine",void 0),n([r({constructOnly:!0})],_.prototype,"laserLineEnabled",void 0),n([r()],_.prototype,"_cursorPosition",null),n([r()],_.prototype,"_startPosition",null),n([r()],_.prototype,"_endPosition",null),n([r()],_.prototype,"_lastDraggedHandle",void 0),n([r()],_.prototype,"_laserLineParams",null),n([r()],_.prototype,"_focusPosition",null),n([r()],_.prototype,"_pointDistanceLine",null),_=n([Q("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DView")],_);let b=class extends xt{constructor(e){super(e),this._updatingHandles=new St,this._emulatedDrag=null,this.lineState="initial",this.removeIncompleteOnCancel=!1,this.startPointSurfaceLocation=null,this.endPointSurfaceLocation=null,this.cursorPointSurfaceLocation=null,this.startManipulator=null,this.endManipulator=null,this.cursorManipulator=null,this._getSnappingContext=Ot((t=>new ai({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new ei(new ti("point",ii(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new Kt})))}initialize(){const{view:e,analysis:t,analysisViewData:i,visible:s}=this;this.measurementView=new _({toolState:this,view:e,analysis:t,analysisViewData:i,visible:s});const o=oi(e);this._snappingManagerResult=o,this.addHandles(o);const{start:a,end:p,cursor:u}=this.measurementView.createManipulators(),h=(d,l,c)=>{const m=si(d,((g,M,A,D)=>{const z=Jt(g),R=this._snappingManager,G=this._getSnappingContext(D),W=this._updatingHandles,{lineState:S}=this;A=A.next(z).next(ni(this,[c,l])).next((L=>{if(l!=="cursorPoint"){const f=this.analysis[l];f!=null&&(g.location=f)}return L}));const I=Zt(this.view),N=L=>{const f=I(L);return f||this.lineState!=="drawing"&&this.lineState!=="initial"||(this[l]=null,this[c]=null),f};let T=M.next(z).next(N);if(D!=="touch"||S==="editing"){const{snappingStep:L,cancelSnapping:f}=ri({snappingManager:R,snappingContext:G,updatingHandles:W});A=A.next(f),T=T.next(...L)}T.next((L=>L.action!=="start"?L:null)).next((L=>{const f=Et(L.mapEnd,new $t);this[l]=f,g.location=f,this[c]=this._surfaceLocation(f,L.surfaceType)}))}));return l==="cursorPoint"?[m]:[m,d.events.on("grab-changed",(()=>{const g=a.grabbing||p.grabbing;this.lineState=g?"editing":"measured"})),P((()=>this.analysis[l]),(g=>{g&&(d.location=g)}))]};this.startManipulator=a,this.endManipulator=p,this.cursorManipulator=u,this.manipulators.add(a),this.manipulators.add(p),this.manipulators.add(u),this.addHandles([...h(a,"startPoint","startPointSurfaceLocation"),...h(p,"endPoint","endPointSurfaceLocation"),...h(u,"cursorPoint","cursorPointSurfaceLocation"),Vt((()=>this.state==="measured"),(()=>{this.finishToolCreation(),this.active&&(this.view.activeTool=null)}),$),P((()=>({startPointAvailable:this.startPoint!=null,endPointAvailable:this.endPoint!=null})),(({startPointAvailable:d,endPointAvailable:l})=>{this.startManipulator.available=d,this.endManipulator.available=l}),$)]),Mt(this)}destroy(){this._updatingHandles=O(this._updatingHandles),this.measurementView=O(this.measurementView)}get _snappingManager(){return this._snappingManagerResult.snappingManager}get state(){const{analysis:e}=this;if(e.startPoint==null&&e.endPoint==null)return"ready";const{lineState:t}=this;return this.validMeasurement&&t!=="editing"&&t!=="drawing"?"measured":"measuring"}get cursor(){return!this.active||this.state!=="ready"&&this.lineState==="measured"?null:"crosshair"}get startPoint(){return this.analysis.startPoint}set startPoint(e){this.analysis.startPoint=e}get endPoint(){return this.analysis.endPoint}set endPoint(e){this.analysis.endPoint=e}get cursorPoint(){return this.measurementView.cursorPoint}set cursorPoint(e){this.measurementView.cursorPoint=e}get snappingOptions(){return this._snappingManager.options}get validMeasurement(){return this.analysis.startPoint!=null&&this.analysis.endPoint!=null}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}resetCreated(){super.resetCreated(),this.lineState="initial",this.cursorPoint=null,this.state==="measured"&&this.finishToolCreation()}onShow(){this.measurementView.show()}onHide(){this.measurementView.hide()}onDeactivate(){var e;(e=this._emulatedDrag)==null||e.cancel(),this._emulatedDrag=null}onInputEvent(e){switch(e.type){case"immediate-click":this._handleImmediateClick(e);break;case"pointer-move":this._handlePointerMove(e)}}_handlePointerMove(e){var u,h;if(!this.active||this.view.navigating)return;const{pointerType:t}=e;if(t!=="mouse")return;const i=Ce(e),{lineState:s,cursorManipulator:o,endManipulator:a}=this;let p=!1;this.cursorPoint==null&&((u=this._emulatedDrag)==null||u.cancel(),this._emulatedDrag=ue(o,t,i),p=!0),s==="initial"&&((h=this._emulatedDrag)==null||h.update(i),p=!0),s==="drawing"&&(a.events.emit("drag",{action:"update",start:i,screenPoint:i}),p=!0),p&&e.stopPropagation()}_handleImmediateClick(e){var h,d,l,c,m;if(!this.active||!It(e))return;const t=Ce(e),{pointerType:i}=e,{cursorManipulator:s,startManipulator:o,endManipulator:a,lineState:p}=this;let u=!1;switch(this.cursorPoint==null&&((h=this._emulatedDrag)==null||h.cancel(),this._emulatedDrag=ue(s,i,t)),p){case"initial":if((d=this._emulatedDrag)==null||d.update(t),this.cursorPoint!=null){(l=this._emulatedDrag)==null||l.end(t),this._emulatedDrag=null,this.endPoint=null;const{cursorPoint:g}=this;this.startPoint=g,this.startPointSurfaceLocation=this.cursorPointSurfaceLocation,o.location=g,o.interactive=!1,a.interactive=!1,this.lineState="drawing",this._emulatedDrag=ue(a,i,t),u=!0}break;case"drawing":(c=this._emulatedDrag)==null||c.update(t),this.endPoint!=null&&((m=this._emulatedDrag)==null||m.end(t),this._emulatedDrag=null,o.interactive=!0,a.interactive=!0,this.lineState="measured",u=!0)}u&&e.stopPropagation()}_surfaceLocation(e,t){return t===Yt.GROUND?"on-the-surface":(e.z??0)>=this._getElevation(e)?"above-the-surface":"below-the-surface"}_getElevation(e){return this.view.basemapTerrain.ready?At(this.view.elevationProvider,e)??0:0}get test(){}};function ue(e,t,i){return e.events.emit("drag",{action:"start",pointerType:t,start:i,screenPoint:i}),{update:s=>e.events.emit("drag",{action:"update",start:s,screenPoint:s}),end:s=>e.events.emit("drag",{action:"end",start:s,screenPoint:s}),cancel:()=>e.events.emit("drag",{action:"cancel"})}}n([r({readOnly:!0})],b.prototype,"state",null),n([r()],b.prototype,"lineState",void 0),n([r({readOnly:!0})],b.prototype,"cursor",null),n([r()],b.prototype,"startPoint",null),n([r()],b.prototype,"endPoint",null),n([r()],b.prototype,"cursorPoint",null),n([r({constructOnly:!0})],b.prototype,"analysis",void 0),n([r({constructOnly:!0})],b.prototype,"analysisViewData",void 0),n([r()],b.prototype,"measurementView",void 0),n([r()],b.prototype,"removeIncompleteOnCancel",void 0),n([r({constructOnly:!0})],b.prototype,"view",void 0),n([r({readOnly:!0})],b.prototype,"validMeasurement",null),n([r({value:null})],b.prototype,"startPointSurfaceLocation",void 0),n([r({value:null})],b.prototype,"endPointSurfaceLocation",void 0),n([r({value:null})],b.prototype,"cursorPointSurfaceLocation",void 0),n([r()],b.prototype,"updating",null),b=n([Q("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],b);let v=class extends Rt(Z){constructor(e){super(e),this.type="direct-line-measurement-view-3d",this.analysis=null,this.tool=null,this.result=null,this.measurementMode=j.Auto,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null,this.userOperation=null}initialize(){const{analysis:e,view:t}=this;this._analysisVisualization=new w({view:t,analysis:e,analysisView:this}),this.addResolvingPromise(Dt().then((i=>{this.destroyed||(this._analysisController=new H({view:t,analysis:e,viewData:this,geodesicLengthMeasurementUtils:i}))}))),this.addHandles(Gt(this,b))}destroy(){Ht(this),this.userOperation=zt(this.userOperation),this._analysisController=O(this._analysisController),this._analysisVisualization=O(this._analysisVisualization)}get updating(){var e;return!!((e=this._analysisVisualization)!=null&&e.loadingMessages)}get viewMode(){return this._analysisVisualization.viewMode}get actualVisualizedMeasurement(){return this._analysisVisualization.actualVisualizedMeasurement}get visualElementOrientation(){return this._analysisVisualization.visualElementOrientation}set visualElementOrientation(e){this._analysisVisualization.visualElementOrientation=e}get allowVisualElementsOrientationChange(){return this._analysisVisualization.allowVisualElementsOrientationChange}set allowVisualElementsOrientationChange(e){this._analysisVisualization.allowVisualElementsOrientationChange=e}get triangleCollapseRatioThreshold(){return this._analysisVisualization.triangleCollapseRatioThreshold}set triangleCollapseRatioThreshold(e){this._analysisVisualization.triangleCollapseRatioThreshold=e}get directLabelText(){var e;return((e=this._analysisVisualization.labels.direct)==null?void 0:e.text)??""}get horizontalLabelText(){var e;return((e=this._analysisVisualization.labels.horizontal)==null?void 0:e.text)??""}get verticalLabelText(){var e;return((e=this._analysisVisualization.labels.vertical)==null?void 0:e.text)??""}get unit(){return this.analysis.unit??Tt(this.view)}get testData(){}place(e){return jt(this,{placementOptions:e})}};n([r()],v.prototype,"_analysisVisualization",void 0),n([r()],v.prototype,"_analysisController",void 0),n([r()],v.prototype,"updating",null),n([r({readOnly:!0})],v.prototype,"type",void 0),n([r({constructOnly:!0,nonNullable:!0})],v.prototype,"analysis",void 0),n([r()],v.prototype,"tool",void 0),n([r()],v.prototype,"result",void 0),n([r()],v.prototype,"measurementMode",void 0),n([r()],v.prototype,"elevationAlignedStartPoint",void 0),n([r()],v.prototype,"elevationAlignedEndPoint",void 0),n([r({readOnly:!0})],v.prototype,"viewMode",null),n([r({readOnly:!0})],v.prototype,"actualVisualizedMeasurement",null),n([r()],v.prototype,"visualElementOrientation",null),n([r()],v.prototype,"allowVisualElementsOrientationChange",null),n([r()],v.prototype,"triangleCollapseRatioThreshold",null),n([r({readOnly:!0})],v.prototype,"directLabelText",null),n([r({readOnly:!0})],v.prototype,"horizontalLabelText",null),n([r({readOnly:!0})],v.prototype,"verticalLabelText",null),n([r()],v.prototype,"unit",null),n([r()],v.prototype,"userOperation",void 0),v=n([Q("esri.views.3d.analysis.DirectLineMeasurementAnalysisView3D")],v);const ss=v,Ai=Object.freeze(Object.defineProperty({__proto__:null,build:Re},Symbol.toStringTag,{value:"Module"}));export{ss as default};
