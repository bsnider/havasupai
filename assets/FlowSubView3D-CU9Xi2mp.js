import{sN as w,dJ as b,aX as $,sO as S,aO as y,dO as x,cm as v,ov as R,am as C,oj as I,u as L,mb as D,e as z,r as l,m as u,d as _,sP as F,eb as E,cJ as q,cQ as j,aq as G,el as H,b2 as P,cR as M,l$ as O,ed as T,g3 as W,oP as k}from"./index-CxDa6KP7.js";import{c as B,u as N,g as A}from"./dataUtils-BQIFxQZE.js";import{s as J,h as U}from"./utils-DzWhCHZC.js";import{p as V}from"./SubView3D-BSB4iNwd.js";import{R as X,b as Q}from"./line-BQqND8NX.js";function Y(t,e,s,r){const{spatialReference:n}=t;return Z(s.map((i=>i.map((o=>{const[a,c]=K(o,e),{absoluteZ:f}=w(a,c,0,n,t,r),m=b(a,c,f);return t.renderCoordsHelper.toRenderCoords(m,n,m),m})))))}function Z(t){const e=X(t),s=new $({width:2,color:y(.1,.2,1,1),innerWidth:1,innerColor:y(.2,.4,1,1),cap:S.ROUND});return e.map((r=>Q(s,r)))}function K({x:t,y:e},s){const{extent:r,size:[n,i]}=s;return[t/n*r.width+r.xmin,(i-e)/i*r.height+r.ymin]}function tt(t,e,s){let[r,n,i,o]=[null,null,null,null];for(e.reset(t);!e.done;){const a=e.next();if(a==null)continue;if(!a.visible){e.skipSubtree();continue}const c=a.extent;a.leaf&&a.rendered&&x(c,s)&&(r=g(c[0],r),n=g(c[1],n),i=p(c[2],i),o=p(c[3],o))}return r==null||n==null||i==null||o==null?null:v([r,n,i,o])}function p(t,e){return e==null?t:Math.max(t,e)}function g(t,e){return e==null?t:Math.min(t,e)}class et{constructor(e,s){this.streamlines=e,this._geometries=s,this._object3D=null,this._engineLayer=null}get attached(){return this._object3D!=null&&this._engineLayer!=null}attach(e){const{_geometries:s}=this;if(s==null)return;this.detach();const r=new R(e,{pickable:!1,updatePolicy:C.SYNC}),n=new I({geometries:s});n.visible=!0,r.add(n),this._object3D=n,this._engineLayer=r}detach(){this.attached&&(this._engineLayer=L(this._engineLayer),this._object3D=D(this._object3D))}}let d=class extends z{constructor(t){super(t),this.simulationSettings=null,this.loadImagery=null,this.createGeometry=null}async load(t,e){const s=await this.loadImagery(t,e);if(s==null)return null;const r=this._createFlowFieldFromData(s),n=this._getStreamlines(t,r),i=this.createGeometry(t,n);return new et(n,i)}_createFlowFieldFromData(t){return B(this.simulationSettings,t)}_getStreamlines(t,e){const{size:[s,r]}=t;return N(this.simulationSettings,e,s,r)}};l([u()],d.prototype,"simulationSettings",void 0),l([u()],d.prototype,"loadImagery",void 0),l([u()],d.prototype,"createGeometry",void 0),d=l([_("esri.views.3d.support.flow.StreamlinesStyle3D")],d);let h=class extends V{constructor(t){super(t),this.type="flow",this._preorderIterator=new F,this._abortController=null,this._debouncedLoad=E((async()=>{var a;const{view:e,_style:s}=this;if(s==null)return;const r=this._computeExtent();if(r==null)return;const n={extent:r,timeExtent:this.layer.timeExtent,size:this._viewSizeWithEqualRatio(r),pixelRatio:e.state.contentPixelRatio};this._abortController==null&&(this._abortController=new AbortController);const i=this._abortController,o=await s.load(n,i.signal);q(i.signal),o!=null&&((a=this._resources)==null||a.detach(),o.attach(e.stage),this._resources=o)})),this._loadImagery=(e,s)=>{const{extent:r,size:[n,i],timeExtent:o}=e;return A(this.layer,r,n,i,o,s)},this._createFlowGeometry=(e,s)=>Y(this.view,e,s,this.elevationInfo)}initialize(){this.addHandles([j((()=>this.newStyleRequired),(()=>this._updateStyle()),G)]),this.updatingHandles.add((()=>this._style),(()=>this._triggerLoad())),this._updateStyle(),this.updatingHandles.addWhen((()=>{var t;return!((t=this.view.basemapTerrain)!=null&&t.updating)}),(()=>this._triggerLoad()))}destroy(){this._abortController=H(this._abortController),this.clear()}get layer(){return this.layerView.layer}get flowRenderer(){const t=this.layer.renderer;return(t==null?void 0:t.type)!=="flow"?null:t}get elevationInfo(){return new P({mode:"absolute-height",offset:1e3})}get dataBounds(){const{fullExtent:t}=this.layer,{spatialReference:e}=this.view.basemapTerrain,s=M(t,e).geometry;return s==null?null:O(s)}get simulationSettings(){const{flowRenderer:t}=this;return t==null?null:J(t)}get newStyleRequired(){var s;const t=(s=this._style)==null?void 0:s.simulationSettings,e=this.simulationSettings;return t!=null&&e!=null&&!U(t,e)}doRefresh(){return this._triggerLoad()}clear(){var t;(t=this._resources)==null||t.detach(),this._resources=null}_triggerLoad(){return T(this.updatingHandles.addPromise(this._debouncedLoad()))}_updateStyle(){var e;const{simulationSettings:t}=this;t!=null&&((e=this._style)==null||e.destroy(),this._style=new d({simulationSettings:t,loadImagery:this._loadImagery,createGeometry:this._createFlowGeometry}))}_computeExtent(){const t=this.view.basemapTerrain,e=t==null?void 0:t.rootTiles;if(e==null||e.length===0)return null;const{spatialReference:s}=t,{dataBounds:r}=this;if(!s||r==null)return null;const n=tt(e,this._preorderIterator,r);return n==null?null:(k(n,r,n),W(n,s))}_viewSizeWithEqualRatio(t){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin),[s,r]=this.view.size;return s<r?[s,Math.floor(s/e)]:[Math.floor(r*e),r]}get test(){}};l([u()],h.prototype,"type",void 0),l([u()],h.prototype,"_style",void 0),l([u()],h.prototype,"layer",null),l([u()],h.prototype,"flowRenderer",null),l([u()],h.prototype,"elevationInfo",null),l([u()],h.prototype,"dataBounds",null),l([u()],h.prototype,"simulationSettings",null),l([u()],h.prototype,"newStyleRequired",null),h=l([_("esri.views.3d.layers.FlowSubView3D")],h);export{h as b};
